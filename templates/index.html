<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบติดตามอ้อยเข้าโรงงานแบบเรียลไทม์</title>
    <!-- Critical CSS loaded first -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Non-critical resources loaded asynchronously -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" media="print" onload="this.media='all'">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    
    <!-- Plotly loaded asynchronously -->
    <script>
        // Load Plotly asynchronously
        function loadPlotly() {
            const script = document.createElement('script');
            script.src = 'https://cdn.plot.ly/plotly-2.35.2.min.js';
            script.async = true;
            document.head.appendChild(script);
        }
        // Load after page is interactive
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadPlotly);
        } else {
            loadPlotly();
        }
    </script>
    <style>
        /* Critical CSS for immediate rendering - Enhanced Dark Theme */
        :root {
            --primary-bg: #050508;
            --secondary-bg: #0a0a0f;
            --tertiary-bg: #0f0f15;
            --card-bg: rgba(15, 15, 21, 0.85);
            --card-border: rgba(255, 255, 255, 0.08);
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-tertiary: #06b6d4;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
        }

        * {
            box-sizing: border-box;
        }

        body { 
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 50%, var(--tertiary-bg) 100%);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            line-height: 1.6;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Fallback font while Sarabun loads */
        .font-loading {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* Enhanced Progressive loading styles */
        .progressive-loading {
            opacity: 0;
            transform: translateY(30px) scale(0.95);
            transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), 
                       transform 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                       filter 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            filter: blur(2px);
        }
        
        .progressive-loading.loaded {
            opacity: 1;
            transform: translateY(0) scale(1);
            filter: blur(0px);
        }
        
        .progressive-loading.loading {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        @keyframes pulse-glow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(99, 102, 241, 0.1);
            }
            50% { 
                box-shadow: 0 0 40px rgba(99, 102, 241, 0.2);
            }
        }
        
        /* Enhanced Immediate loading indicator */
        .immediate-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                #6366f1 20%, 
                #8b5cf6 40%, 
                #06b6d4 60%, 
                #8b5cf6 80%, 
                transparent 100%);
            background-size: 300% 100%;
            animation: loading-bar-smooth 2.5s ease-in-out infinite;
            z-index: 10000;
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.3);
        }
        
        @keyframes loading-bar-smooth {
            0% { 
                background-position: -300% 0; 
                opacity: 0.8;
            }
            50% { 
                background-position: 0% 0; 
                opacity: 1;
            }
            100% { 
                background-position: 300% 0; 
                opacity: 0.8;
            }
        }
        .container-fluid { padding: 20px; }
        
        .header-section {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 32px;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow-xl);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .header-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary), var(--accent-tertiary));
            border-radius: 24px 24px 0 0;
        }
        
        .header-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            border-color: rgba(99, 102, 241, 0.3);
        }
        
        .card-summary { 
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 20px; 
            padding: 28px; 
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .card-summary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 20px 20px 0 0;
        }
        
        .card-summary:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: rgba(99, 102, 241, 0.4);
        }
        
        .card-summary:active {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .card-icon {
            font-size: 2.8rem;
            margin-bottom: 16px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            filter: drop-shadow(0 2px 8px rgba(99, 102, 241, 0.3));
        }
        
        .card-summary:hover .card-icon {
            transform: scale(1.1);
            filter: drop-shadow(0 4px 12px rgba(99, 102, 241, 0.5));
        }
        
        .card-value {
            font-size: 2.4rem;
            font-weight: 700;
            margin: 12px 0;
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .card-summary:hover .card-value {
            transform: scale(1.05);
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        
        .chart-panel { 
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px; 
            padding: 32px; 
            margin-bottom: 32px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            height: 100%;
            position: relative;
        }
        
        .chart-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-tertiary));
            border-radius: 24px 24px 0 0;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        .animate-pulse {
            animation: pulse 2s infinite;
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        .chart-panel:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: rgba(99, 102, 241, 0.4);
        }

        .chart-panel > div {
            background: transparent !important;
        }
        
        .statistics-panel {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .statistics-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-secondary), var(--accent-primary));
            border-radius: 24px 24px 0 0;
        }
        
        .statistics-panel:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: rgba(139, 92, 246, 0.4);
        }
        
        .data-grid-frame { 
            padding: 32px; 
            border-radius: 24px; 
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .data-grid-frame:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: rgba(99, 102, 241, 0.4);
        }
        
        .sticky-header { 
            position: sticky; 
            top: 0; 
            background: var(--tertiary-bg);
            backdrop-filter: blur(20px);
            z-index: 10;
            box-shadow: var(--shadow-md);
            border-bottom: 1px solid var(--card-border);
        }

        /* Enhanced Control Panel Styles */
        .control-panel {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow-lg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .control-panel:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
            border-color: rgba(99, 102, 241, 0.4);
        }

        .date-input-group {
            position: relative;
            transition: transform 0.3s ease;
        }

        .date-input-group:hover {
            transform: translateY(-2px);
        }

        .date-input-group input {
            background: linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            color: #f8f9fa;
            transition: all 0.3s ease;
        }

        .date-input-group input:focus {
            background: linear-gradient(145deg, rgba(255,255,255,0.2), rgba(255,255,255,0.12));
            border-color: rgba(0, 212, 255, 0.6);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            transform: scale(1.02);
        }

        .info-text {
            background: linear-gradient(135deg, rgba(13, 202, 240, 0.1), rgba(13, 202, 240, 0.05));
            border: 1px solid rgba(13, 202, 240, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
        }

        /* Enhanced Summary Cards */
        .summary-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.12), rgba(255,255,255,0.06));
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            border-radius: 20px 20px 0 0;
        }

        .summary-card:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            border-color: rgba(255,255,255,0.4);
        }

        .summary-icon {
            margin-bottom: 15px;
            transition: transform 0.3s ease;
        }

        .summary-card:hover .summary-icon {
            transform: scale(1.1) rotate(5deg);
        }



        /* Enhanced Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .btn-outline-info {
            border: 2px solid #17a2b8;
            color: #17a2b8;
            border-radius: 12px;
            padding: 10px 20px;
            transition: all 0.3s ease;
            background: transparent;
        }

        .btn-outline-info:hover {
            background: linear-gradient(135deg, #17a2b8, #138496);
            border-color: #17a2b8;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(23, 162, 184, 0.4);
        }

        /* Enhanced Tab Styles */
        .nav-tabs .nav-link {
            border: none;
            border-radius: 15px 15px 0 0;
            padding: 12px 20px;
            margin-right: 5px;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            color: #f8f9fa;
            transition: all 0.3s ease;
        }

        /* Historical Data Section Enhancements */
        .historical-header {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .date-selection-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .historical-tabs-container {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 20px;
        }

        .historical-tabs-container .nav-tabs {
            border: none;
            background: transparent;
        }

        .historical-tabs-container .nav-link {
            border-radius: 8px;
            margin-right: 5px;
            font-size: 0.9rem;
            padding: 10px 15px;
        }

        /* Chart Container Enhancements */
        .chart-container-wrapper {
            position: relative;
        }

        .chart-container {
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .responsive-chart {
            width: 100%;
            height: 400px;
            min-height: 300px;
        }

        .chart-message {
            color: #adb5bd;
            font-size: 1.1rem;
            text-align: center;
            padding: 20px;
        }

        .chart-controls {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
        }

        /* Enhanced Summary Cards */
        .enhanced-summary-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .enhanced-summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .enhanced-summary-card .summary-icon i {
            font-size: 2.5rem;
        }

        .enhanced-summary-card .card-title {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .enhanced-summary-card h4 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Mobile Responsive Enhancements */
        @media (max-width: 768px) {
            .historical-header {
                padding: 15px;
            }

            .date-selection-container {
                padding: 10px;
            }

            .date-selection-container .row {
                margin: 0;
            }

            .date-selection-container .col-12 {
                margin-bottom: 10px;
            }

            .historical-tabs-container {
                padding: 5px;
            }

            .historical-tabs-container .nav-link {
                padding: 8px 12px;
                font-size: 0.8rem;
                margin-right: 2px;
            }

            .chart-container {
                min-height: 300px;
                padding: 15px;
            }

            .responsive-chart {
                height: 300px;
                min-height: 250px;
            }

            .chart-message {
                font-size: 1rem;
                padding: 15px;
            }

            .enhanced-summary-card {
                padding: 15px;
            }

            .enhanced-summary-card .summary-icon i {
                font-size: 2rem;
            }

            .enhanced-summary-card .card-title {
                font-size: 0.8rem;
            }

            .enhanced-summary-card h4 {
                font-size: 1.2rem;
            }

            .chart-controls {
                padding: 8px;
            }

            .chart-controls .btn {
                font-size: 0.8rem;
                padding: 6px 12px;
            }
        }

        @media (max-width: 576px) {
            .historical-header {
                padding: 10px;
            }

            .date-selection-container {
                padding: 8px;
            }

            .historical-tabs-container .nav-link {
                padding: 6px 8px;
                font-size: 0.75rem;
            }

            .chart-container {
                min-height: 250px;
                padding: 10px;
            }

            .responsive-chart {
                height: 250px;
                min-height: 200px;
            }

            .enhanced-summary-card {
                padding: 12px;
            }

            .enhanced-summary-card .summary-icon i {
                font-size: 1.8rem;
            }

            .enhanced-summary-card .card-title {
                font-size: 0.75rem;
            }

            .enhanced-summary-card h4 {
                font-size: 1.1rem;
            }
        }

        .nav-tabs .nav-link:hover {
            background: linear-gradient(135deg, rgba(255,255,255,0.15), rgba(255,255,255,0.08));
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 212, 255, 0.1));
            color: #00d4ff;
            border-bottom: 3px solid #00d4ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.3s ease, padding-left 0.3s ease, transform 0.3s ease;
            will-change: background-color, padding-left, transform;
        }
        
        .stat-item:hover {
            background: rgba(255, 255, 255, 0.05);
            padding-left: 10px;
            border-radius: 10px;
            transform: translate3d(5px, 0, 0);
        }
        
        .stat-item {
            transition: all 0.3s ease;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            font-weight: 500;
            color: #adb5bd;
            font-size: 1rem;
        }
        
        .stat-value {
            font-weight: 700;
            color: #f8f9fa;
            font-size: 1.1rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            transition: color 0.3s ease, transform 0.3s ease;
            will-change: color, transform;
        }
        
        .stat-item:hover .stat-value {
            color: #00d4ff;
            transform: scale3d(1.02, 1.02, 1);
        }

        .analysis-panel {
            background: rgba(255, 193, 7, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 12px 32px rgba(255, 193, 7, 0.1);
            transition: all 0.3s ease;
        }
        
        .analysis-title {
            font-weight: 600;
            color: #ffc107;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        .analysis-text {
            color: #f8f9fa;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        #loading-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background: linear-gradient(135deg, #050508 0%, #0a0a0f 25%, #0f0f15 50%, #0a0a0f 75%, #050508 100%);
            display: flex;
            justify-content: center; 
            align-items: center; 
            z-index: 9999;
            backdrop-filter: blur(15px);
            overflow: hidden;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #loading-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* AI Background Animation */
        .ai-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* Floating Circles */
        .floating-circle {
            position: absolute;
            border-radius: 50%;
            background: linear-gradient(45deg, rgba(0, 212, 255, 0.08), rgba(78, 205, 196, 0.08));
            animation: float-smooth 12s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            filter: blur(0.5px);
        }

        .floating-circle:nth-child(1) {
            width: 80px;
            height: 80px;
            top: 20%;
            left: 10%;
            animation-delay: 0s;
            animation-duration: 15s;
        }

        .floating-circle:nth-child(2) {
            width: 120px;
            height: 120px;
            top: 60%;
            right: 15%;
            animation-delay: 3s;
            animation-duration: 18s;
        }

        .floating-circle:nth-child(3) {
            width: 60px;
            height: 60px;
            bottom: 30%;
            left: 20%;
            animation-delay: 6s;
            animation-duration: 14s;
        }

        .floating-circle:nth-child(4) {
            width: 100px;
            height: 100px;
            top: 40%;
            right: 30%;
            animation-delay: 2s;
            animation-duration: 16s;
        }

        /* Neural Network Lines */
        .neural-line {
            position: absolute;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.2), transparent);
            height: 1px;
            animation: neural-pulse-smooth 6s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
            filter: blur(0.3px);
        }

        .neural-line:nth-child(5) {
            width: 200px;
            top: 25%;
            left: 20%;
            animation-delay: 0s;
        }

        .neural-line:nth-child(6) {
            width: 150px;
            top: 45%;
            right: 25%;
            animation-delay: 2s;
        }

        .neural-line:nth-child(7) {
            width: 180px;
            bottom: 35%;
            left: 15%;
            animation-delay: 4s;
        }

        /* Data Particles */
        .data-particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: radial-gradient(circle, #00d4ff, rgba(0, 212, 255, 0.3));
            border-radius: 50%;
            animation: particle-float-smooth 8s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
            box-shadow: 0 0 6px rgba(0, 212, 255, 0.4);
        }

        .data-particle:nth-child(8) {
            top: 15%;
            left: 30%;
            animation-delay: 0s;
        }

        .data-particle:nth-child(9) {
            top: 35%;
            right: 40%;
            animation-delay: 2s;
        }

        .data-particle:nth-child(10) {
            bottom: 25%;
            left: 50%;
            animation-delay: 4s;
        }

        .data-particle:nth-child(11) {
            top: 55%;
            left: 70%;
            animation-delay: 6s;
        }

        /* AI Grid Pattern */
        .ai-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 212, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 212, 255, 0.02) 1px, transparent 1px);
            background-size: 60px 60px;
            animation: grid-move-smooth 40s linear infinite;
            opacity: 0.6;
        }

        /* Holographic Effect */
        .holographic-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, 
                transparent 30%, 
                rgba(0, 212, 255, 0.03) 50%, 
                transparent 70%);
            animation: holographic-sweep-smooth 16s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
            opacity: 0.7;
        }

        /* Smooth Animations */
        @keyframes float-smooth {
            0%, 100% { 
                transform: translateY(0px) translateX(0px) rotate(0deg) scale(1); 
                opacity: 0.6;
            }
            25% { 
                transform: translateY(-15px) translateX(10px) rotate(90deg) scale(1.05); 
                opacity: 0.8;
            }
            50% { 
                transform: translateY(-25px) translateX(-5px) rotate(180deg) scale(1.1); 
                opacity: 1;
            }
            75% { 
                transform: translateY(-15px) translateX(-10px) rotate(270deg) scale(1.05); 
                opacity: 0.8;
            }
        }

        @keyframes neural-pulse-smooth {
            0%, 100% { 
                opacity: 0.2; 
                transform: scaleX(1) scaleY(1); 
                filter: brightness(1);
            }
            25% { 
                opacity: 0.4; 
                transform: scaleX(1.1) scaleY(1.05); 
                filter: brightness(1.2);
            }
            50% { 
                opacity: 0.6; 
                transform: scaleX(1.3) scaleY(1.1); 
                filter: brightness(1.5);
            }
            75% { 
                opacity: 0.4; 
                transform: scaleX(1.1) scaleY(1.05); 
                filter: brightness(1.2);
            }
        }

        @keyframes particle-float-smooth {
            0% { 
                transform: translateY(0px) translateX(0px) scale(0.5); 
                opacity: 0; 
            }
            10% { 
                transform: translateY(-10px) translateX(5px) scale(1); 
                opacity: 0.8; 
            }
            50% { 
                transform: translateY(-50px) translateX(25px) scale(1.2); 
                opacity: 1; 
            }
            90% { 
                transform: translateY(-90px) translateX(45px) scale(0.8); 
                opacity: 0.6; 
            }
            100% { 
                transform: translateY(-120px) translateX(60px) scale(0.3); 
                opacity: 0; 
            }
        }

        @keyframes grid-move-smooth {
            0% { 
                transform: translate(0, 0); 
                opacity: 0.6;
            }
            50% { 
                transform: translate(30px, 30px); 
                opacity: 0.8;
            }
            100% { 
                transform: translate(60px, 60px); 
                opacity: 0.6;
            }
        }

        @keyframes holographic-sweep-smooth {
            0% { 
                transform: translateX(-100%) rotate(0deg) scaleY(1); 
                opacity: 0;
            }
            25% { 
                transform: translateX(-50%) rotate(90deg) scaleY(1.1); 
                opacity: 0.3;
            }
            50% { 
                transform: translateX(0%) rotate(180deg) scaleY(1.2); 
                opacity: 0.5;
            }
            75% { 
                transform: translateX(50%) rotate(270deg) scaleY(1.1); 
                opacity: 0.3;
            }
            100% { 
                transform: translateX(100%) rotate(360deg) scaleY(1); 
                opacity: 0;
            }
        }

        /* Enhanced AI Loading Text Animation */
        .ai-loading-text {
            background: linear-gradient(45deg, #6366f1, #8b5cf6, #06b6d4, #8b5cf6, #6366f1);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: ai-text-shimmer-enhanced 4s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
            font-weight: 600;
            text-shadow: 0 0 30px rgba(99, 102, 241, 0.4);
            filter: drop-shadow(0 0 20px rgba(99, 102, 241, 0.3));
            transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .ai-loading-text.text-changing {
            animation: text-change-effect-enhanced 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        @keyframes ai-text-shimmer-enhanced {
            0%, 100% { 
                background-position: 0% 50%; 
                filter: brightness(1) drop-shadow(0 0 20px rgba(99, 102, 241, 0.3));
            }
            25% { 
                background-position: 100% 50%; 
                filter: brightness(1.2) drop-shadow(0 0 25px rgba(139, 92, 246, 0.4));
            }
            50% { 
                background-position: 200% 50%; 
                filter: brightness(1.4) drop-shadow(0 0 30px rgba(6, 182, 212, 0.5));
            }
            75% { 
                background-position: 300% 50%; 
                filter: brightness(1.2) drop-shadow(0 0 25px rgba(139, 92, 246, 0.4));
            }
        }

        @keyframes text-change-effect-enhanced {
            0% { 
                transform: scale(1) translateY(0px); 
                opacity: 1; 
                filter: blur(0px) brightness(1);
            }
            50% { 
                transform: scale(0.95) translateY(-3px); 
                opacity: 0.8; 
                filter: blur(1px) brightness(1.2);
            }
            100% { 
                transform: scale(1) translateY(0px); 
                opacity: 1; 
                filter: blur(0px) brightness(1);
            }
        }

        @keyframes ai-text-shimmer-smooth {
            0% { 
                background-position: 0% 50%; 
                filter: brightness(1) drop-shadow(0 0 15px rgba(0, 212, 255, 0.3));
            }
            25% { 
                background-position: 25% 50%; 
                filter: brightness(1.2) drop-shadow(0 0 20px rgba(0, 212, 255, 0.5));
            }
            50% { 
                background-position: 50% 50%; 
                filter: brightness(1.4) drop-shadow(0 0 25px rgba(0, 212, 255, 0.7));
            }
            75% { 
                background-position: 75% 50%; 
                filter: brightness(1.2) drop-shadow(0 0 20px rgba(0, 212, 255, 0.5));
            }
            100% { 
                background-position: 100% 50%; 
                filter: brightness(1) drop-shadow(0 0 15px rgba(0, 212, 255, 0.3));
            }
        }

        /* AI Spinner Enhancement */
        .ai-spinner {
            border: 3px solid rgba(0, 212, 255, 0.1);
            border-top: 3px solid #00d4ff;
            border-right: 3px solid rgba(78, 205, 196, 0.5);
            border-radius: 50%;
            width: 3rem;
            height: 3rem;
            animation: ai-spin-smooth 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.4));
        }

        @keyframes ai-spin-smooth {
            0% { 
                transform: rotate(0deg) scale(1); 
                border-top-color: #00d4ff;
                border-right-color: rgba(78, 205, 196, 0.5);
            }
            25% { 
                transform: rotate(90deg) scale(1.05); 
                border-top-color: rgba(78, 205, 196, 0.8);
                border-right-color: #00d4ff;
            }
            50% { 
                transform: rotate(180deg) scale(1.1); 
                border-top-color: #4ecdc4;
                border-right-color: rgba(0, 212, 255, 0.8);
            }
            75% { 
                transform: rotate(270deg) scale(1.05); 
                border-top-color: rgba(0, 212, 255, 0.8);
                border-right-color: #4ecdc4;
            }
            100% { 
                transform: rotate(360deg) scale(1); 
                border-top-color: #00d4ff;
                border-right-color: rgba(78, 205, 196, 0.5);
            }
        }

        /* Glowing Effect */
        .ai-glow {
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.5));
        }

        /* Data Flow Animation */
        .data-flow {
            position: absolute;
            width: 2px;
            height: 120px;
            background: linear-gradient(to bottom, 
                transparent 0%, 
                rgba(0, 212, 255, 0.3) 20%, 
                #00d4ff 50%, 
                rgba(0, 212, 255, 0.3) 80%, 
                transparent 100%);
            animation: data-flow-smooth 6s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
            filter: blur(0.5px);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }

        .data-flow:nth-child(1) {
            top: 10%;
            left: 25%;
            animation-delay: 0s;
        }

        .data-flow:nth-child(2) {
            top: 20%;
            right: 30%;
            animation-delay: 2s;
        }

        .data-flow:nth-child(3) {
            bottom: 20%;
            left: 40%;
            animation-delay: 4s;
        }

        @keyframes data-flow-smooth {
            0% { 
                transform: translateY(-150px) scaleY(0.5); 
                opacity: 0; 
            }
            20% { 
                transform: translateY(-100px) scaleY(0.8); 
                opacity: 0.6; 
            }
            50% { 
                transform: translateY(0px) scaleY(1); 
                opacity: 1; 
            }
            80% { 
                transform: translateY(100px) scaleY(0.8); 
                opacity: 0.6; 
            }
            100% { 
                transform: translateY(150px) scaleY(0.5); 
                opacity: 0; 
            }
        }

        @keyframes logo-glow-smooth {
            0% { 
                background-position: 0% 50%; 
                filter: brightness(1) drop-shadow(0 0 20px rgba(0, 212, 255, 0.4));
            }
            25% { 
                background-position: 25% 50%; 
                filter: brightness(1.3) drop-shadow(0 0 25px rgba(0, 212, 255, 0.6));
            }
            50% { 
                background-position: 50% 50%; 
                filter: brightness(1.5) drop-shadow(0 0 30px rgba(0, 212, 255, 0.8));
            }
            75% { 
                background-position: 75% 50%; 
                filter: brightness(1.3) drop-shadow(0 0 25px rgba(0, 212, 255, 0.6));
            }
            100% { 
                background-position: 100% 50%; 
                filter: brightness(1) drop-shadow(0 0 20px rgba(0, 212, 255, 0.4));
            }
        }
        
        .spinner-border {
            width: 4rem; 
            height: 4rem;
            border-width: 0.5em;
        }

        .logo-animation {
            display: flex;
            font-size: 5rem;
            font-weight: 700;
            letter-spacing: 0.5rem;
            text-shadow: 0 4px 15px rgba(0, 212, 255, 0.4);
            filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.3));
        }
        .logo-char {
            opacity: 0;
            transform: translateY(25px);
            background: linear-gradient(135deg, #00d4ff, #4ecdc4, #00d4ff, #4ecdc4);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: fadeInUp 0.8s forwards cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                       logo-glow-smooth 5s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite;
            filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.4));
        }
        .logo-char.brr {
            margin-left: 2rem;
        }
        .logo-char:nth-child(2) { animation-delay: 0.1s; }
        .logo-char:nth-child(3) { animation-delay: 0.2s; }
        .logo-char:nth-child(4) { animation-delay: 0.3s; }
        .logo-char:nth-child(5) { animation-delay: 0.4s; }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        h1, h2, h3, h4, h5, h6 { 
            color: #f8f9fa; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-weight: 600;
        }
        
        .text-muted { 
            color: #adb5bd !important; 
        }
        
        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.1);
            color: #f8f9fa;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            background: rgba(255, 255, 255, 0.15);
            color: #f8f9fa;
            border-color: #00d4ff;
            box-shadow: 0 0 0 0.25rem rgba(0, 212, 255, 0.25);
            transition: all 0.3s ease;
        }
        
        .form-control:hover, .form-select:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        .form-select option {
            background: #1a1a2e;
        }
        
        .btn {
            border-radius: 12px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            font-weight: 500;
            will-change: transform, box-shadow;
        }
        
        .btn:hover {
            transform: translate3d(0, -2px, 0);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        
        .btn:active {
            transform: translate3d(0, -1px, 0);
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00d4ff 0%, #4ecdc4 100%);
            border: none;
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            border: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
        }
        
        /* Enhanced Hourly Analysis Button */
        .btn-hourly-analysis {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 50%, #ff6b6b 100%);
            border: none;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 8px 16px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            animation: pulse-glow 2s infinite;
        }
        
        .btn-hourly-analysis:hover {
            background: linear-gradient(135deg, #ff5252 0%, #ff7043 50%, #ff5252 100%);
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
            color: white;
            text-decoration: none;
        }
        
        .btn-hourly-analysis:active {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.5);
        }
        
        .btn-hourly-analysis::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-hourly-analysis:hover::before {
            left: 100%;
        }
        
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            }
            50% {
                box-shadow: 0 4px 18px rgba(255, 107, 107, 0.6);
            }
        }
        
        #status-bar {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        #status-bar:hover {
            background: rgba(0,0,0,0.4);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        
        .table-dark {
            background: transparent;
        }
        
        .dashboard-title {
            background: linear-gradient(135deg, #00d4ff, #4ecdc4, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5rem;
            font-weight: 700;
            text-shadow: none;
            filter: drop-shadow(0 4px 8px rgba(0, 212, 255, 0.4));
        }
        
        .section-title {
            color: #00d4ff;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            position: relative;
            text-shadow: 0 2px 4px rgba(0, 212, 255, 0.3);
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #00d4ff, #4ecdc4);
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0, 212, 255, 0.5);
        }
        
        .auto-update-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #4ecdc4;
            font-size: 0.9rem;
        }
        
        .auto-update-indicator .pulse {
            width: 8px;
            height: 8px;
            background: #4ecdc4;
            border-radius: 50%;
            animation: pulse 2s infinite;
            will-change: opacity, transform;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        @media (prefers-reduced-motion: reduce) {
            .auto-update-indicator .pulse {
                animation: none;
                opacity: 0.7;
            }
        }
        
        .flash-update {
            animation: flash-bg 0.8s ease-out;
            border-radius: 5px;
        }
        @keyframes flash-bg {
            0% { background-color: rgba(255, 193, 7, 0.6); }
            100% { background-color: transparent; }
        }

        .loading-text-animated {
            animation: pulse-loading-text 2s infinite ease-in-out;
            will-change: opacity, transform;
        }
        @keyframes pulse-loading-text {
            0% { opacity: 0.6; }
            50% { opacity: 1; transform: scale(1.02); }
            100% { opacity: 0.6; }
        }
        
        @media (prefers-reduced-motion: reduce) {
            .loading-text-animated {
                animation: none;
                opacity: 0.8;
            }
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #00d4ff, #4ecdc4); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #4ecdc4, #00d4ff); }

        /* FAQ Icon Styles */
        .bi-question-circle-fill {
            transition: all 0.3s ease;
            opacity: 0.7;
        }
        
        .bi-question-circle-fill:hover {
            opacity: 1;
            transform: scale(1.2);
            color: #00d4ff !important;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        
        /* FAQ Modal Styles */
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            border: 1px solid rgba(78, 205, 196, 0.3);
        }
        
        .modal-header {
            background: rgba(78, 205, 196, 0.1);
            border-bottom: 1px solid rgba(78, 205, 196, 0.2);
        }
        
        .modal-footer {
            background: rgba(78, 205, 196, 0.05);
            border-top: 1px solid rgba(78, 205, 196, 0.2);
        }

        .border-start-lg {
            border-left: none; /* Default for mobile */
        }

        @media (min-width: 992px) { /* lg breakpoint */
            .border-start-lg {
                border-left: 1px solid rgba(255, 255, 255, 0.2) !important;
            }
        }
        
        /* --- START: IMPROVED TABLE STYLES --- */
        .table-container { 
            margin-top: 1rem;
            border-radius: 15px;
            overflow-x: auto; /* Allow horizontal scroll on small screens */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table-dark td, .table-dark th {
            border-color: rgba(255, 255, 255, 0.15);
            padding: 0.9rem 1rem; /* Increased padding for better spacing */
            vertical-align: middle; /* Center content vertically */
            white-space: nowrap; /* Prevent text wrapping */
        }

        .table-dark thead th {
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0,0,0,0.2);
            position: relative; /* Needed for the sort icon */
        }

        .table-dark thead th:hover {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
        }

        .table-dark thead th .sort-icon {
            display: inline-block;
            width: 1em;
            text-align: left;
            margin-left: 8px;
            opacity: 0.5;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .table-dark thead th.sort-asc .sort-icon,
        .table-dark thead th.sort-desc .sort-icon {
            opacity: 1;
        }
        
        .table-dark tr:not(.summary-row):hover {
            background: rgba(255, 255, 255, 0.1) !important;
            transform: none; /* Removed scale for stability */
            transition: background-color 0.2s ease-in-out;
        }

        .table-dark tr.summary-row {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(78, 205, 196, 0.2)) !important;
            font-weight: 700;
            border-top: 3px solid #00d4ff;
        }

        .table-dark tr.summary-row td {
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            font-size: 1.05rem; /* Slightly larger font */
        }
        /* --- END: IMPROVED TABLE STYLES --- */
        
        /* --- START: STICKY FIRST COLUMN FOR HORIZONTAL SCROLL --- */
        /* Make the first header cell sticky (for vertical and horizontal scroll) */
        .table-container .table-dark thead.sticky-header th:first-child {
            position: -webkit-sticky;
            position: sticky;
            left: 0;
            z-index: 11; /* Must be higher than other sticky elements */
        }

        /* Make the first data cell in each body row sticky */
        .table-container .table-dark tbody td:first-child {
            position: -webkit-sticky;
            position: sticky;
            left: 0;
            z-index: 1; /* Below the header */
            background-color: #1a1a2e; /* Match the dark theme to hide content scrolling behind */
        }

        /* Ensure the background of the sticky cell matches the row's hover state */
        .table-container .table-dark tbody tr:not(.summary-row):hover td:first-child {
            background-color: rgba(255, 255, 255, 0.1) !important;
        }

        /* For the summary row, let it inherit the TR's gradient background */
        .table-container .table-dark tbody tr.summary-row td:first-child {
            background: inherit !important;
        }
        /* --- END: STICKY FIRST COLUMN FOR HORIZONTAL SCROLL --- */

        /* --- WEATHER PANEL STYLES REMOVED --- */
        
        /* Weather recommendations styles removed */
        
        /* Risk indicator styles removed */

        /* AI Notice Footer Styles */
        .ai-notice-footer {
            text-align: center;
            padding: 8px 0;
        }
        
        .ai-notice-text-footer {
            color: #6c757d;
            font-size: 0.75rem;
            font-weight: 400;
            opacity: 0.8;
            line-height: 1.4;
        }
        
        .ai-notice-text-footer i {
            color: #6c757d;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translate3d(0, 20px, 0);
            }
            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }
        
        /* Performance optimizations */
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            box-sizing: border-box;
        }
        
        /* Reduce motion for users who prefer it */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Hardware acceleration for smooth scrolling */
        body {
            -webkit-overflow-scrolling: touch;
            overflow-x: hidden;
        }
        
        /* Optimize table rendering */
        .table-container {
            transform: translateZ(0);
            will-change: scroll-position;
            contain: layout style paint;
        }
        
        /* Optimize animations */
        .animate__animated {
            will-change: transform, opacity;
        }
        
        /* Optimize gradients */
        .card-summary,
        .chart-panel,
        .statistics-panel {
            contain: layout style paint;
        }
        
        /* Optimize hover effects */
        @media (hover: hover) {
            .card-summary:hover,
            .chart-panel:hover,
            .statistics-panel:hover {
                will-change: transform, box-shadow, border-color;
            }
        }
        
        /* Disable hover effects on touch devices */
        @media (hover: none) {
            .card-summary:hover,
            .chart-panel:hover,
            .statistics-panel:hover {
                transform: none !important;
                box-shadow: inherit !important;
                border-color: inherit !important;
            }
        }

        /* Skeleton Loading Styles */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 25%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.1) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 1rem;
            margin-bottom: 0.5rem;
        }

        .skeleton-text.short { width: 60%; }
        .skeleton-text.medium { width: 80%; }
        .skeleton-text.long { width: 100%; }

        .skeleton-title {
            height: 1.5rem;
            width: 70%;
            margin-bottom: 1rem;
        }

        .skeleton-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            height: 100%;
        }

        /* Performance optimizations */
        .card-summary,
        .analysis-panel-enhanced,
        .ai-card {
            contain: layout style paint;
            will-change: transform, box-shadow, border-color;
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Optimize animations */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Enhanced smooth transitions */
        .smooth-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading states */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: loading-shimmer 1.5s infinite;
        }

        @keyframes loading-shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Improved button interactions */
        .btn {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

    </style>
</head>
<body class="font-loading">
    <!-- Immediate loading indicator -->
    <div class="immediate-loader" id="immediate-loader"></div>
    
    <div id="loading-overlay">
        <!-- AI Background Animation -->
        <div class="ai-background">
            <!-- AI Grid Pattern -->
            <div class="ai-grid"></div>
            
            <!-- Holographic Effect -->
            <div class="holographic-overlay"></div>
            
            <!-- Floating Circles -->
            <div class="floating-circle"></div>
            <div class="floating-circle"></div>
            <div class="floating-circle"></div>
            <div class="floating-circle"></div>
            
            <!-- Neural Network Lines -->
            <div class="neural-line"></div>
            <div class="neural-line"></div>
            <div class="neural-line"></div>
            
            <!-- Data Particles -->
            <div class="data-particle"></div>
            <div class="data-particle"></div>
            <div class="data-particle"></div>
            <div class="data-particle"></div>
            
            <!-- Data Flow -->
            <div class="data-flow"></div>
            <div class="data-flow"></div>
            <div class="data-flow"></div>
        </div>
        
        <div id="initial-loader" class="text-center" style="position: relative; z-index: 10;">
            <div class="logo-animation">
                <span class="logo-char">I</span>
                <span class="logo-char">T</span>
                <span class="logo-char brr">B</span>
                <span class="logo-char brr">R</span>
                <span class="logo-char brr">R</span>
            </div>
            <h5 class="ai-loading-text mt-3" id="loading-message">
                <i class="bi bi-cpu me-2 ai-glow"></i>กำลังเตรียมข้อมูล....
            </h5>
            <div class="mt-3">
                <div class="ai-spinner" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container-fluid">
        <div class="header-section progressive-loading animate__animated animate__fadeInDown">
            <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                <div>
                    <h1 class="dashboard-title mb-0" id="dashboard-title">ระบบติดตามอ้อยเข้าโรงงาน</h1>
                    <p class="text-muted mb-0 mt-2">
                        <i class="bi bi-calendar3 me-1"></i>
                        <span id="current-date-display">--</span>
                        <span class="mx-2">|</span>
                        <i class="bi bi-clock me-1"></i>
                        <span id="current-time-display">--:--:--</span>
                    </p>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <a href="/advanced_hourly_analysis" class="btn btn-hourly-analysis">
                        <i class="bi bi-bar-chart-line me-2"></i>
                        การวิเคราะห์รายชั่วโมง
                        <i class="bi bi-arrow-right ms-2"></i>
                    </a>
                    <div class="auto-update-indicator">
                        <div class="pulse"></div>
                        <span>อัปเดตอัตโนมัติ</span>
                    </div>
                </div>
            </div>
            
            <div class="row align-items-end g-3">
                <div class="col-md-3">
                    <label for="date-picker" class="form-label text-white-50 mb-2">เลือกวันที่:</label>
                    <input type="date" id="date-picker" class="form-control" value="{{ today_date }}">
                </div>
                <div class="col-md-3">
                    <label for="refresh-interval" class="form-label text-white-50 mb-2">รีเฟรชทุก:</label>
                    <select id="refresh-interval" class="form-select">
                        <option value="0">ปิด</option>
                        <option value="30000">30 วินาที</option>
                        <option value="60000" selected>1 นาที</option>
                    </select>
                </div>
                <div class="col-md-6 d-flex gap-2 flex-wrap">
                    <button class="btn btn-secondary" onclick="debouncedFetch()" title="รีเฟรชข้อมูล (Ctrl+R)"><i class="bi bi-arrow-clockwise"></i> รีเฟรช</button>
                    <button class="btn btn-success" onclick="goToToday()" title="กลับไปวันที่ปัจจุบัน"><i class="bi bi-calendar-check"></i> วันนี้</button>
                    <button class="btn btn-warning" onclick="toggleFullscreen()" title="เต็มหน้าจอ (F11)"><i class="bi bi-fullscreen"></i></button>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card-summary text-center h-100">
                    <i class="bi bi-truck-front card-icon"></i>
                    <h6 class="text-muted mb-2">
                        รวมราง A (คัน)
                        <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.8rem; cursor: pointer;" 
                           onclick="showFAQModal('truck-a-count', 'จำนวนรถราง A')" title="ข้อมูลเพิ่มเติม"></i>
                    </h6>
                    <div class="card-value" id="a1sum">0</div>
                    <small class="text-muted">เฉลี่ย: <span id="avg-a-count">0</span>/ชม.</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card-summary text-center h-100">
                    <i class="bi bi-truck-front-fill card-icon"></i>
                    <h6 class="text-muted mb-2">
                        รวมราง B (คัน)
                        <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.8rem; cursor: pointer;" 
                           onclick="showFAQModal('truck-b-count', 'จำนวนรถราง B')" title="ข้อมูลเพิ่มเติม"></i>
                    </h6>
                    <div class="card-value" id="b1sum">0</div>
                    <small class="text-muted">เฉลี่ย: <span id="avg-b-count">0</span>/ชม.</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card-summary text-center h-100">
                    <i class="bi bi-box-seam card-icon"></i>
                    <h6 class="text-muted mb-2">
                        รวมราง A (ตัน)
                        <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.8rem; cursor: pointer;" 
                           onclick="showFAQModal('tons-a', 'ปริมาณอ้อยราง A')" title="ข้อมูลเพิ่มเติม"></i>
                    </h6>
                    <div class="card-value" id="a2sum">0.00</div>
                    <small class="text-muted">เฉลี่ย: <span id="avg-a-tons">0</span>/ชม.</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card-summary text-center h-100">
                    <i class="bi bi-box-seam-fill card-icon"></i>
                    <h6 class="text-muted mb-2">
                        รวมราง B (ตัน)
                        <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.8rem; cursor: pointer;" 
                           onclick="showFAQModal('tons-b', 'ปริมาณอ้อยราง B')" title="ข้อมูลเพิ่มเติม"></i>
                    </h6>
                    <div class="card-value" id="b2sum">0.00</div>
                    <small class="text-muted">เฉลี่ย: <span id="avg-b-tons">0</span>/ชม.</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card-summary text-center h-100">
                    <i class="bi bi-bookmark-check card-icon" style="color: #28a745;"></i>
                    <h6 class="text-muted mb-2">
                        อ้อยสดรวม (วันนี้)
                        <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.8rem; cursor: pointer;" 
                           onclick="showFAQModal('fresh-cane', 'อ้อยสด')" title="ข้อมูลเพิ่มเติม"></i>
                    </h6>
                    <div class="card-value" id="total-fresh">0.00</div>
                    <small class="text-muted">ตัน (<span id="fresh-percent">0</span>%)</small>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="card-summary text-center h-100">
                    <i class="bi bi-fire card-icon" style="color: #dc3545;"></i>
                    <h6 class="text-muted mb-2">
                        อ้อยไฟรวม (วันนี้)
                        <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.8rem; cursor: pointer;" 
                           onclick="showFAQModal('burnt-cane', 'อ้อยไฟ')" title="ข้อมูลเพิ่มเติม"></i>
                    </h6>
                    <div class="card-value" id="total-burnt">0.00</div>
                    <small class="text-muted">ตัน (<span id="burnt-percent">0</span>%)</small>
                </div>
            </div>
        </div>

        <!-- Weather Impact Panel removed -->

        <div class="row g-4">
            <div class="col-xl-8">
                <div class="data-grid-frame animate__animated animate__fadeInLeft h-100">
                    <h4 class="section-title">
                        <i class="bi bi-table me-2"></i>ข้อมูลรายชั่วโมง
                        <i class="bi bi-question-circle-fill text-info ms-2" style="font-size: 0.9rem; cursor: pointer;" 
                           onclick="showFAQModal('hourly-data', 'ข้อมูลรายชั่วโมง')" title="ข้อมูลเพิ่มเติม"></i>
                    </h4>
                    <div class="table-container progressive-loading">
                        <table class="table table-striped table-hover table-dark">
                            <thead class="sticky-header">
                                <tr>
                                    <th onclick="sortTable(0)" class="text-center"><i class="bi bi-clock"></i> เวลา<span class="sort-icon"></span></th>
                                    <th onclick="sortTable(1)" class="text-center"><i class="bi bi-truck"></i> A(คัน)<span class="sort-icon"></span></th>
                                    <th onclick="sortTable(2)" class="text-center"><i class="bi bi-box"></i> A(ตัน)<span class="sort-icon"></span></th>
                                    <th onclick="sortTable(3)" class="text-center"><i class="bi bi-truck"></i> B(คัน)<span class="sort-icon"></span></th>
                                    <th onclick="sortTable(4)" class="text-center"><i class="bi bi-box"></i> B(ตัน)<span class="sort-icon"></span></th>
                                    <th onclick="sortTable(5)" class="text-center">รวม(คัน)<span class="sort-icon"></span></th>
                                    <th onclick="sortTable(6)" class="text-center">รวม(ตัน)<span class="sort-icon"></span></th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-xl-4">
                <div class="animate__animated animate__fadeInRight">
                    <div class="statistics-panel progressive-loading mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="section-title mb-0"><i class="bi bi-calendar-day me-2"></i>สรุปข้อมูลวันนี้</h5>
                            <div class="text-muted small">
                                ประเมินเทียบข้อมูลย้อนหลัง <strong id="stat-comparison-days">?</strong> วัน
                            </div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">
                                ยอดรวมวันนี้:
                                <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.7rem; cursor: pointer;" 
                                   onclick="showFAQModal('total-today', 'ยอดรวมวันนี้')" title="ข้อมูลเพิ่มเติม"></i>
                            </span>
                            <span class="stat-value"><span id="stat-today-total">0.00</span> ตัน</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">
                                จำนวนรถวันนี้:
                                <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.7rem; cursor: pointer;" 
                                   onclick="showFAQModal('truck-count-today', 'จำนวนรถวันนี้')" title="ข้อมูลเพิ่มเติม"></i>
                            </span>
                            <span class="stat-value"><span id="stat-today-truck-count">0</span> คัน</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">
                                อ้อยสดวันนี้:
                                <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.7rem; cursor: pointer;" 
                                   onclick="showFAQModal('fresh-today', 'อ้อยสดวันนี้')" title="ข้อมูลเพิ่มเติม"></i>
                            </span>
                            <span class="stat-value text-success"><span id="stat-today-fresh">0.00</span> ตัน (<span id="stat-today-fresh-pct">0</span>%)</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">
                                อ้อยไฟวันนี้:
                                <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.7rem; cursor: pointer;" 
                                   onclick="showFAQModal('burnt-today', 'อ้อยไฟวันนี้')" title="ข้อมูลเพิ่มเติม"></i>
                            </span>
                            <span class="stat-value text-danger"><span id="stat-today-burnt">0.00</span> ตัน (<span id="stat-today-burnt-pct">0</span>%)</span>
                        </div>
                        <div class="mt-3 pt-3 border-top border-white border-opacity-10 text-center">
                            <h6 class="text-white-50 mb-2">คะแนนประสิทธิภาพรายวัน</h6>
                            <div class="display-4 fw-bold" id="score-overall-display">N/A</div>
                            <div id="score-headline-text" class="text-muted">รอข้อมูล</div>
                        </div>
                    </div>
                    <div class="statistics-panel progressive-loading mb-4" style="background: rgba(40, 167, 69, 0.1); border-color: rgba(40, 167, 69, 0.3);">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="section-title mb-0" style="color: #28a745;"><i class="bi bi-archive me-2"></i>ข้อมูลสะสม (ตั้งแต่เปิดหีบ)</h5>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">
                                ยอดสะสมทั้งหมด:
                                <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.7rem; cursor: pointer;" 
                                   onclick="showFAQModal('total-all-time', 'ยอดสะสมทั้งหมด')" title="ข้อมูลเพิ่มเติม"></i>
                            </span>
                            <span class="stat-value"><span id="stat-all-time-total">0.00</span> ตัน</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">
                                ปริมาณอ้อย ราง A:
                                <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.7rem; cursor: pointer;" 
                                   onclick="showFAQModal('tons-a-all-time', 'ปริมาณอ้อยราง A สะสม')" title="ข้อมูลเพิ่มเติม"></i>
                            </span>
                            <span class="stat-value"><span id="stat-all-time-tons-a">0.00</span> ตัน (<span id="stat-all-time-tons-a-pct">0.00</span>%)</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">
                                ปริมาณอ้อย ราง B:
                                <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.7rem; cursor: pointer;" 
                                   onclick="showFAQModal('tons-b-all-time', 'ปริมาณอ้อยราง B สะสม')" title="ข้อมูลเพิ่มเติม"></i>
                            </span>
                            <span class="stat-value"><span id="stat-all-time-tons-b">0.00</span> ตัน (<span id="stat-all-time-tons-b-pct">0.00</span>%)</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">
                                จำนวนรถ ราง A:
                                <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.7rem; cursor: pointer;" 
                                   onclick="showFAQModal('trucks-a-all-time', 'จำนวนรถราง A สะสม')" title="ข้อมูลเพิ่มเติม"></i>
                            </span>
                            <span class="stat-value"><span id="stat-all-time-trucks-a">0</span> คัน (<span id="stat-all-time-trucks-a-pct">0.00</span>%)</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">
                                จำนวนรถ ราง B:
                                <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.7rem; cursor: pointer;" 
                                   onclick="showFAQModal('trucks-b-all-time', 'จำนวนรถราง B สะสม')" title="ข้อมูลเพิ่มเติม"></i>
                            </span>
                            <span class="stat-value"><span id="stat-all-time-trucks-b">0</span> คัน (<span id="stat-all-time-trucks-b-pct">0.00</span>%)</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">
                                อ้อยสดสะสม:
                                <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.7rem; cursor: pointer;" 
                                   onclick="showFAQModal('fresh-all-time', 'อ้อยสดสะสม')" title="ข้อมูลเพิ่มเติม"></i>
                            </span>
                            <span class="stat-value text-success"><span id="stat-all-time-fresh">0.00</span> ตัน (<span id="stat-all-time-fresh-pct">0</span>%)</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">
                                อ้อยไฟสะสม:
                                <i class="bi bi-question-circle-fill text-info ms-1" style="font-size: 0.7rem; cursor: pointer;" 
                                   onclick="showFAQModal('burnt-all-time', 'อ้อยไฟสะสม')" title="ข้อมูลเพิ่มเติม"></i>
                            </span>
                            <span class="stat-value text-danger"><span id="stat-all-time-burnt">0.00</span> ตัน (<span id="stat-all-time-burnt-pct">0</span>%)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        {% include '_analysis_panel.html' %}

        <div class="row g-4 mt-1">
            <div class="col-lg-6">
                <div class="chart-panel progressive-loading animate__animated animate__fadeInUp">
                    <h5 class="section-title">
                        ปริมาณอ้อยรายชั่วโมง (ตัน)
                        <i class="bi bi-question-circle-fill text-info ms-2" style="font-size: 0.8rem; cursor: pointer;" 
                           onclick="showFAQModal('chart-hourly-tons', 'กราฟปริมาณอ้อยรายชั่วโมง')" title="ข้อมูลเพิ่มเติม"></i>
                    </h5>
                    <div id="chart-hourly-tons" style="height: 350px;"></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-panel progressive-loading animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
                    <h5 class="section-title">
                        จำนวนรถรายชั่วโมง (คัน)
                        <i class="bi bi-question-circle-fill text-info ms-2" style="font-size: 0.8rem; cursor: pointer;" 
                           onclick="showFAQModal('chart-hourly-counts', 'กราฟจำนวนรถรายชั่วโมง')" title="ข้อมูลเพิ่มเติม"></i>
                    </h5>
                    <div id="chart-hourly-counts" style="height: 350px;"></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-panel progressive-loading animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                    <h5 class="section-title">
                        ปริมาณอ้อยสะสมตามประเภท (ตัน)
                        <i class="bi bi-question-circle-fill text-info ms-2" style="font-size: 0.8rem; cursor: pointer;" 
                           onclick="showFAQModal('chart-cumulative-types', 'กราฟปริมาณอ้อยสะสมตามประเภท')" title="ข้อมูลเพิ่มเติม"></i>
                    </h5>
                    <div id="chart-cumulative-types" style="height: 350px;"></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-panel progressive-loading animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
                    <h5 class="section-title">
                        ปริมาณอ้อยสะสมตามราง (ตัน)
                        <i class="bi bi-question-circle-fill text-info ms-2" style="font-size: 0.8rem; cursor: pointer;" 
                           onclick="showFAQModal('chart-cumulative-lines', 'กราฟปริมาณอ้อยสะสมตามราง')" title="ข้อมูลเพิ่มเติม"></i>
                    </h5>
                    <div id="chart-cumulative-lines" style="height: 350px;"></div>
                </div>
            </div>
        </div>

        <div class="row g-4 mt-1">
            <div class="col-lg-12">
                <div class="chart-panel progressive-loading animate__animated animate__fadeInUp" style="animation-delay: 0.4s;">
                     <!-- Enhanced Header with Mobile Support -->
                     <div class="historical-header mb-4">
                        <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
                            <h5 class="section-title mb-0">
                                <i class="bi bi-clock-history me-2"></i>ข้อมูลย้อนหลัง
                                <i class="bi bi-question-circle-fill text-info ms-2" style="font-size: 0.8rem; cursor: pointer;" 
                                   onclick="showFAQModal('historical-data', 'ข้อมูลย้อนหลัง')" title="ข้อมูลเพิ่มเติม"></i>
                            </h5>
                        </div>
                        
                        <!-- Mobile-Optimized Date Selection -->
                        <div class="date-selection-container">
                            <div class="row g-2 align-items-end">
                                <div class="col-12 col-sm-6 col-md-3">
                                    <label for="historical-start-date" class="form-label small text-light">
                                        <i class="bi bi-calendar-event me-1"></i>ตั้งแต่
                                    </label>
                                    <input type="date" id="historical-start-date" class="form-control form-control-sm" value="{{ historical_start_date }}">
                                </div>
                                <div class="col-12 col-sm-6 col-md-3">
                                    <label for="historical-end-date" class="form-label small text-light">
                                        <i class="bi bi-calendar-check me-1"></i>ถึง
                                    </label>
                                    <input type="date" id="historical-end-date" class="form-control form-control-sm" value="{{ historical_end_date }}">
                                </div>
                                <div class="col-12 col-sm-12 col-md-6">
                                    <div class="d-flex gap-2 flex-wrap">
                                        <button class="btn btn-primary btn-sm flex-fill" onclick="fetchAllHistoricalData()">
                                            <i class="bi bi-search me-1"></i>แสดงข้อมูล
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="setDefaultDateRange()">
                                            <i class="bi bi-arrow-clockwise me-1"></i>รีเซ็ต
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Enhanced Mobile-Friendly Tabs -->
                    <div class="historical-tabs-container">
                        <ul class="nav nav-tabs nav-fill" id="historicalTab" role="tablist">
                          <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="daily-chart-tab" data-bs-toggle="tab" data-bs-target="#daily-chart-pane" type="button" role="tab">
                              <i class="bi bi-graph-up me-1"></i>
                              <span class="d-none d-sm-inline">กราฟรายวัน</span>
                              <span class="d-inline d-sm-none">รายวัน</span>
                            </button>
                          </li>
                          <li class="nav-item" role="presentation">
                            <button class="nav-link" id="daily-weight-bar-tab" data-bs-toggle="tab" data-bs-target="#daily-weight-bar-pane" type="button" role="tab">
                              <i class="bi bi-bar-chart me-1"></i>
                              <span class="d-none d-sm-inline">กราฟแท่งน้ำหนัก</span>
                              <span class="d-inline d-sm-none">แท่ง</span>
                            </button>
                          </li>
                          <li class="nav-item" role="presentation">
                            <button class="nav-link" id="heatmap-tab" data-bs-toggle="tab" data-bs-target="#heatmap-pane" type="button" role="tab">
                              <i class="bi bi-grid-3x3-gap me-1"></i>
                              <span class="d-none d-sm-inline">Heatmap รายชั่วโมง</span>
                              <span class="d-inline d-sm-none">Heatmap</span>
                            </button>
                          </li>
                        </ul>
                    </div>

                    <div class="tab-content" id="historicalTabContent">
                      <div class="tab-pane fade show active" id="daily-chart-pane" role="tabpanel" tabindex="0">
                        <!-- Enhanced Chart Container with Mobile Support -->
                        <div class="chart-container-wrapper">
                            <div id="chart-historical-data-container" class="chart-container mt-3">
                                <div id="chart-historical-data" class="responsive-chart"></div>
                                <div id="historical-data-message" class="chart-message">
                                    <i class="bi bi-graph-up me-2"></i>เลือกช่วงวันที่แล้วกด 'แสดงข้อมูล'
                                </div>
                            </div>
                            
                            <!-- Chart Controls for Mobile -->
                            <div class="chart-controls d-flex justify-content-center gap-2 mt-3 d-md-none">
                                <button class="btn btn-outline-light btn-sm" onclick="toggleChartFullscreen('chart-historical-data')">
                                    <i class="bi bi-arrows-fullscreen me-1"></i>ขยาย
                                </button>
                                <button class="btn btn-outline-light btn-sm" onclick="downloadChart('chart-historical-data')">
                                    <i class="bi bi-download me-1"></i>ดาวน์โหลด
                                </button>
                            </div>
                        </div>
                      </div>
                      <div class="tab-pane fade" id="daily-weight-bar-pane" role="tabpanel" tabindex="0">
                        <!-- Enhanced Bar Chart Container with Mobile Support -->
                        <div class="chart-container-wrapper">
                            <div id="chart-daily-weight-container" class="chart-container animate-fade-in-up">
                                <div id="chart-daily-weight" class="responsive-chart"></div>
                                <div id="daily-weight-message" class="chart-message">
                                    <i class="bi bi-bar-chart me-2"></i>เลือกช่วงวันที่แล้วกด 'แสดงข้อมูล'
                                </div>
                            </div>
                            
                            <!-- Chart Controls for Mobile -->
                            <div class="chart-controls d-flex justify-content-center gap-2 mt-3 d-md-none">
                                <button class="btn btn-outline-light btn-sm" onclick="toggleChartFullscreen('chart-daily-weight')">
                                    <i class="bi bi-arrows-fullscreen me-1"></i>ขยาย
                                </button>
                                <button class="btn btn-outline-light btn-sm" onclick="downloadChart('chart-daily-weight')">
                                    <i class="bi bi-download me-1"></i>ดาวน์โหลด
                                </button>
                            </div>
                        </div>

                        <!-- Enhanced Summary Cards with Mobile Support -->
                        <div id="daily-weight-summary" class="mt-4" style="display: none;">
                          <div class="row g-3">
                            <div class="col-6 col-md-3">
                              <div class="summary-card enhanced-summary-card">
                                <div class="summary-icon mb-2">
                                  <i class="bi bi-calendar-check text-primary"></i>
                                </div>
                                <h6 class="card-title text-light mb-2">จำนวนวัน</h6>
                                <h4 id="summary-days" class="text-primary mb-0">0</h4>
                              </div>
                            </div>
                            <div class="col-6 col-md-3">
                              <div class="summary-card enhanced-summary-card">
                                <div class="summary-icon mb-2">
                                  <i class="bi bi-weight text-success"></i>
                                </div>
                                <h6 class="card-title text-light mb-2">น้ำหนักรวม</h6>
                                <h4 id="summary-total" class="text-success mb-0">0 ตัน</h4>
                              </div>
                            </div>
                            <div class="col-6 col-md-3">
                              <div class="summary-card enhanced-summary-card">
                                <div class="summary-icon mb-2">
                                  <i class="bi bi-calculator text-warning"></i>
                                </div>
                                <h6 class="card-title text-light mb-2">เฉลี่ยต่อวัน</h6>
                                <h4 id="summary-avg" class="text-warning mb-0">0 ตัน</h4>
                              </div>
                            </div>
                            <div class="col-6 col-md-3">
                              <div class="summary-card enhanced-summary-card">
                                <div class="summary-icon mb-2">
                                  <i class="bi bi-graph-up-arrow text-info"></i>
                                </div>
                                <h6 class="card-title text-light mb-2">สูงสุด</h6>
                                <h4 id="summary-max" class="text-info mb-0">0 ตัน</h4>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="tab-pane fade" id="heatmap-pane" role="tabpanel" tabindex="0">
                        <!-- Enhanced Heatmap Container with Mobile Support -->
                        <div class="chart-container-wrapper">
                            <div id="chart-heatmap-container" class="chart-container mt-3">
                                <div id="chart-heatmap" class="responsive-chart"></div>
                                <div id="heatmap-message" class="chart-message">
                                    <i class="bi bi-grid-3x3-gap me-2"></i>เลือกช่วงวันที่แล้วกด 'แสดงข้อมูล'
                                </div>
                            </div>
                            
                            <!-- Chart Controls for Mobile -->
                            <div class="chart-controls d-flex justify-content-center gap-2 mt-3 d-md-none">
                                <button class="btn btn-outline-light btn-sm" onclick="toggleChartFullscreen('chart-heatmap')">
                                    <i class="bi bi-arrows-fullscreen me-1"></i>ขยาย
                                </button>
                                <button class="btn btn-outline-light btn-sm" onclick="downloadChart('chart-heatmap')">
                                    <i class="bi bi-download me-1"></i>ดาวน์โหลด
                                </button>
                            </div>
                        </div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-12">
                <div class="chart-panel progressive-loading animate__animated animate__fadeInUp" style="animation-delay: 0.5s;">
                    <h5 class="section-title">
                        สรุปยอดอ้อยรายเดือน (ตลอดฤดูกาล)
                        <i class="bi bi-question-circle-fill text-info ms-2" style="font-size: 0.8rem; cursor: pointer;" 
                           onclick="showFAQModal('monthly-data', 'สรุปยอดอ้อยรายเดือน')" title="ข้อมูลเพิ่มเติม"></i>
                    </h5>
                    <div id="chart-monthly-bar-container" style="min-height: 400px; display: flex; align-items: center; justify-content: center;">
                        <div id="chart-monthly-bar" style="width: 100%; height: 400px;"></div>
                        <div id="monthly-bar-message" class="text-muted">กำลังโหลดข้อมูล...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4"><div id="status-bar" class="animate__animated animate__fadeInUp"><i class="bi bi-info-circle me-2"></i><span id="status-message">พร้อมใช้งาน</span><span class="ms-3 text-muted">| อัปเดตล่าสุด: <span id="last-update-time">--</span></span></div></div>
        
        <!-- AI Notice Footer -->
        <div class="ai-notice-footer mt-3">
            <div class="ai-notice-text-footer">
                <i class="bi bi-info-circle me-1" style="font-size: 0.8rem;"></i>
                หมายเหตุ: ผลลัพธ์จาก AI อาจไม่ถูกต้อง 100% กรุณาตรวจสอบก่อนใช้งานจริง
            </div>
        </div>
        
        <footer class="text-center text-white-50 mt-2 pb-3">
            <small>พัฒนาโดยฝ่ายเทคโนโลยีสารสนเทศ BRR</small>
        </footer>
    </div>

    <!-- FAQ Modal -->
    <div class="modal fade" id="faqModal" tabindex="-1" aria-labelledby="faqModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="faqModalLabel">
                        <i class="bi bi-question-circle-fill text-info me-2"></i>
                        <span id="faq-title">ข้อมูลเพิ่มเติม</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="faq-content">
                        <!-- Content will be loaded dynamically -->
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const tableBody = document.getElementById('data-table-body');
        const datePicker = document.getElementById('date-picker');
        const refreshIntervalSelect = document.getElementById('refresh-interval');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        let currentData = [], currentStats = {}, refreshTimer;
        let isUserInteracting = false, interactionTimer = null;
        
        // AI Loading Messages
        const aiLoadingMessages = [
            '<i class="bi bi-cpu me-2 ai-glow"></i>กำลังเตรียมข้อมูล....',
            '<i class="bi bi-database me-2 ai-glow"></i>กำลังประมวลผลข้อมูล...',
            '<i class="bi bi-graph-up me-2 ai-glow"></i>กำลังสร้างกราฟวิเคราะห์...',
            '<i class="bi bi-lightning me-2 ai-glow"></i>กำลังคำนวณประสิทธิภาพ...',
            '<i class="bi bi-search me-2 ai-glow"></i>กำลังค้นหาข้อมูลล่าสุด...',
            '<i class="bi bi-gear me-2 ai-glow"></i>กำลังปรับแต่งระบบ...',
            '<i class="bi bi-robot me-2 ai-glow"></i>AI กำลังเรียนรู้ข้อมูล...',
            '<i class="bi bi-bar-chart me-2 ai-glow"></i>กำลังสร้างรายงาน...'
        ];
        
        let loadingMessageIndex = 0;
        let loadingMessageInterval;
        
        // Function to cycle through AI loading messages
        function startAILoadingMessages() {
            if (loadingMessageInterval) {
                clearInterval(loadingMessageInterval);
            }
            
            loadingMessageInterval = setInterval(() => {
                if (loadingMessage) {
                    // Add transition effect
                    loadingMessage.classList.add('text-changing');
                    
                    setTimeout(() => {
                        loadingMessage.innerHTML = aiLoadingMessages[loadingMessageIndex];
                        loadingMessageIndex = (loadingMessageIndex + 1) % aiLoadingMessages.length;
                        
                        // Remove transition effect after change
                        setTimeout(() => {
                            loadingMessage.classList.remove('text-changing');
                        }, 100);
                    }, 250);
                }
            }, 3000); // Change message every 3 seconds for smoother experience
        }
        
        function stopAILoadingMessages() {
            if (loadingMessageInterval) {
                clearInterval(loadingMessageInterval);
                loadingMessageInterval = null;
            }
        }
        
        let sortColumnIndex = -1; 
        let isSortAscending = true; 
        let fetchTimeout = null;
        let isFetching = false;
        let lastFetchTime = 0;
        const FETCH_DEBOUNCE_MS = 300;
        const MIN_FETCH_INTERVAL_MS = 1000;
        
        // Data caching
        let dataCache = new Map();
        const CACHE_DURATION_MS = 30000; // 30 seconds cache
        
        // Progressive loading management
        let progressiveElements = [];
        let isPageLoaded = false;
        
        // Progressive loading functions
        function initProgressiveLoading() {
            progressiveElements = document.querySelectorAll('.progressive-loading');
            console.log('Found progressive elements:', progressiveElements.length);
            
            // Show progressive elements immediately
            showProgressiveElements();
        }
        
        function showProgressiveElements() {
            progressiveElements.forEach((element, index) => {
                // Add loading class for visual feedback
                element.classList.add('loading');
                
                setTimeout(() => {
                    element.classList.remove('loading');
                    element.classList.add('loaded');
                    
                    // Load monthly chart after its container becomes visible
                    if (element.querySelector('#chart-monthly-bar')) {
                        setTimeout(() => {
                            console.log('Loading monthly chart from progressive element');
                            fetchMonthlyData();
                        }, 100); // Small delay to ensure container is fully visible
                    }
                    
                    // Also check if this is the monthly chart container itself
                    if (element.id === 'chart-monthly-bar-container' || element.querySelector('#chart-monthly-bar-container')) {
                        setTimeout(() => {
                            console.log('Loading monthly chart from container element');
                            fetchMonthlyData();
                        }, 200); // Slightly longer delay for container
                    }
                }, index * 150); // Stagger the loading with longer delay for smoother effect
            });
            
            // Also try to load monthly chart after all progressive elements are loaded
            setTimeout(() => {
                console.log('Loading monthly chart after all progressive elements loaded');
                fetchMonthlyData();
            }, progressiveElements.length * 100 + 500);
            
            // Force load monthly chart after a longer delay
            setTimeout(() => {
                console.log('Force loading monthly chart');
                fetchMonthlyData();
            }, 3000);
            
            // Final attempt to load monthly chart
            setTimeout(() => {
                console.log('Final attempt to load monthly chart');
                fetchMonthlyData();
            }, 5000);
        }
        
        function hideImmediateLoader() {
            const immediateLoader = document.getElementById('immediate-loader');
            if (immediateLoader) {
                immediateLoader.style.opacity = '0';
                setTimeout(() => {
                    immediateLoader.remove();
                }, 300);
            }
        }
        
        function optimizeInitialLoad() {
            // Hide immediate loader
            hideImmediateLoader();
            
            // Show progressive elements
            showProgressiveElements();
            
            // Load fonts
            if (document.fonts && document.fonts.ready) {
                document.fonts.ready.then(() => {
                    document.body.classList.remove('font-loading');
                });
            } else {
                // Fallback for older browsers
                setTimeout(() => {
                    document.body.classList.remove('font-loading');
                }, 1000);
            }
            
            isPageLoaded = true;
            
            // Load monthly data after optimization
            setTimeout(() => {
                console.log('Loading monthly data from optimizeInitialLoad');
                fetchMonthlyData();
            }, 1000);
        }

        // Debounced fetch function
        function debouncedFetch(options = {}) {
            if (fetchTimeout) {
                clearTimeout(fetchTimeout);
            }
            
            fetchTimeout = setTimeout(() => {
                fetchData(options);
            }, FETCH_DEBOUNCE_MS);
        }

        async function fetchData(options = {}) {
            const silent = options.silent === true;
            const now = Date.now();
            
            // Prevent too frequent requests
            if (!silent && now - lastFetchTime < MIN_FETCH_INTERVAL_MS) {
                console.log('Fetch request throttled');
                return;
            }
            
            if (isFetching) {
                console.log('Fetch already in progress');
                return;
            }
            
            isFetching = true;
            lastFetchTime = now;
            
            // ตรวจสอบ elements ที่จำเป็น
            const initialLoader = document.getElementById('initial-loader');
            const loadingOverlay = document.getElementById('loading-overlay');
            
            if (!silent) {
                if (initialLoader) {
                    try {
                        initialLoader.style.display = 'block';
                    } catch (e) {
                        console.warn('Could not show initial loader:', e);
                    }
                }
                if (loadingOverlay) {
                    try {
                        loadingOverlay.style.display = 'flex';
                        loadingOverlay.classList.remove('hidden');
                        startAILoadingMessages(); // Start AI loading messages
                    } catch (e) {
                        console.warn('Could not show loading overlay:', e);
                    }
                }
                // Show skeleton loading for cards
                showSkeletonLoading();
            }
            
            const selectedDate = datePicker.value;
            if (!selectedDate) {
                showError('กรุณาเลือกวันที่');
                if (!silent) {
                    loadingOverlay.classList.add('hidden');
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 800);
                    stopAILoadingMessages(); // Stop AI loading messages
                }
                return;
            }
            
            // Check cache first
            const cacheKey = `data_${selectedDate}`;
            const cachedData = dataCache.get(cacheKey);
            const cacheTime = Date.now();
            
            if (cachedData && (cacheTime - cachedData.timestamp) < CACHE_DURATION_MS) {
                console.log('Using cached data for:', selectedDate);
                updateDashboard(cachedData.data, selectedDate);
                isFetching = false;
                return;
            }
            
            const url = `/get_data?date=${selectedDate}`;
            console.log('Fetching data from:', url); // Debug log
            
            try {
                const response = await fetch(url);
                console.log('Response status:', response.status); // Debug log
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP Error Response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('Received data structure:', Object.keys(data)); // Debug log
                console.log('Full response data:', data); // Debug full data
                
                if (data.error) throw new Error(data.error);
                
                // ตรวจสอบโครงสร้างข้อมูล
                if (!data.hourly_data) {
                    console.error('Missing hourly_data in response');
                    console.error('Available keys:', Object.keys(data));
                    throw new Error('ข้อมูลไม่ครบถ้วน: ไม่พบข้อมูลรายชั่วโมง');
                }
                
                if (!Array.isArray(data.hourly_data)) {
                    console.error('hourly_data is not an array:', typeof data.hourly_data);
                    console.error('hourly_data value:', data.hourly_data);
                    throw new Error('ข้อมูลไม่ถูกต้อง: ข้อมูลรายชั่วโมงไม่ใช่รูปแบบที่ถูกต้อง');
                }
                
                console.log('Data validation passed, updating dashboard...'); // Debug log
                console.log('hourly_data length:', data.hourly_data.length);
                console.log('First few rows:', data.hourly_data.slice(0, 3));
                
                // Cache the data
                dataCache.set(cacheKey, {
                    data: data,
                    timestamp: cacheTime
                });
                
                updateDashboard(data, selectedDate);
                
                if (!silent) showNotification('อัปเดตข้อมูลสำเร็จ!', 'success');
                const lastUpdateTimeEl = document.getElementById('last-update-time');
                if (lastUpdateTimeEl) {
                    lastUpdateTimeEl.textContent = new Date().toLocaleTimeString('th-TH');
                }

            } catch (error) {
                console.error('เกิดข้อผิดพลาดในการดึงข้อมูล:', error);
                if (!silent) showError(`เกิดข้อผิดพลาด: ${error.message}`);
                
                // แสดงข้อความในตารางเมื่อเกิดข้อผิดพลาด
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}
                        </td>
                    </tr>
                `;
            } finally {
                isFetching = false;
                if (!silent) {
                    setTimeout(() => { 
                        if (loadingOverlay) {
                            loadingOverlay.classList.add('hidden');
                            setTimeout(() => {
                                loadingOverlay.style.display = 'none';
                            }, 800);
                            stopAILoadingMessages(); // Stop AI loading messages
                        }
                    }, 300);
                }
            }
        }

        // Skeleton loading functions
        function showSkeletonLoading() {
            const cards = document.querySelectorAll('.card-summary');
            cards.forEach(card => {
                const content = card.querySelector('.card-content');
                const skeleton = card.querySelector('.skeleton-content');
                if (content && skeleton) {
                    content.style.display = 'none';
                    skeleton.style.display = 'block';
                }
            });
        }

        function hideSkeletonLoading() {
            const cards = document.querySelectorAll('.card-summary');
            cards.forEach(card => {
                const content = card.querySelector('.card-content');
                const skeleton = card.querySelector('.skeleton-content');
                if (content && skeleton) {
                    content.style.display = 'block';
                    skeleton.style.display = 'none';
                }
            });
        }

        function updateDashboard(data, selectedDate) {
            console.log('=== UPDATE DASHBOARD START ===');
            console.log('Received data:', data); // Debug log
            console.log('Selected date:', selectedDate);
            
            // Hide skeleton loading
            hideSkeletonLoading();
            
            // ตรวจสอบว่าข้อมูลมีครบหรือไม่
            if (!data) {
                console.error('No data received');
                showError('ไม่ได้รับข้อมูลจากเซิร์ฟเวอร์');
                return;
            }
            
            if (!data.hourly_data) {
                console.error('Missing hourly_data in response:', data);
                console.error('Available keys:', Object.keys(data));
                showError('ข้อมูลไม่ครบถ้วน: ไม่พบข้อมูลรายชั่วโมง');
                return;
            }
            
            if (!Array.isArray(data.hourly_data)) {
                console.error('hourly_data is not an array:', typeof data.hourly_data);
                showError('ข้อมูลไม่ถูกต้อง: ข้อมูลรายชั่วโมงไม่ใช่รูปแบบที่ถูกต้อง');
                return;
            }
            
            currentData = data.hourly_data;
            console.log('Current data set length:', currentData.length);
            console.log('Current data set:', currentData); // Debug log
            
            try {
                const date = new Date(selectedDate + 'T00:00:00');
                const dashboardTitleEl = document.getElementById('dashboard-title');
                if (dashboardTitleEl) {
                    dashboardTitleEl.textContent = `รายงานข้อมูลอ้อย ประจำวันที่ ${date.toLocaleDateString('th-TH', { dateStyle: 'long' })}`;
                    console.log('Dashboard title updated successfully');
                } else {
                    console.warn('Dashboard title element not found');
                }
            } catch (e) {
                console.error('Error updating dashboard title:', e);
            }

            // ตรวจสอบข้อมูล summary ก่อนอัปเดต
            console.log('Checking summary data...');
            if (data.summary) {
                console.log('Summary data found:', data.summary);
                try {
                    animateValue('a1sum', data.summary.a1sum, 500, 0);
                    animateValue('b1sum', data.summary.b1sum, 500, 0);
                    animateValue('a2sum', data.summary.a2sum, 500, 2);
                    animateValue('b2sum', data.summary.b2sum, 500, 2);
                    animateValue('total-fresh', data.summary.total_fresh, 500, 2);
                    animateValue('total-burnt', data.summary.total_burnt, 500, 2);
                    
                    // อัปเดตค่าเฉลี่ย
                    updateAndFlash('avg-a-count', data.summary.daily_avg_a_count);
                    updateAndFlash('avg-b-count', data.summary.daily_avg_b_count);
                    updateAndFlash('avg-a-tons', data.summary.daily_avg_a_tons);
                    updateAndFlash('avg-b-tons', data.summary.daily_avg_b_tons);
                    console.log('Summary data updated successfully');
                } catch (e) {
                    console.error('Error updating summary data:', e);
                }
            } else {
                console.error('Missing summary data:', data);
                console.error('Available keys:', Object.keys(data));
            }
            
            // อัปเดตเปอร์เซ็นต์
            console.log('Checking statistics data...');
            if (data.statistics) {
                console.log('Statistics data found:', data.statistics);
                try {
                    const totalTons = parseFloat(data.statistics.today_total || 0);
                    if(totalTons > 0) {
                        updateAndFlash('fresh-percent', (data.statistics.type_1_percent || 0).toFixed(1));
                        updateAndFlash('burnt-percent', (data.statistics.type_2_percent || 0).toFixed(1));
                    } else {
                        const freshPercentEl = document.getElementById('fresh-percent');
                        const burntPercentEl = document.getElementById('burnt-percent');
                        if (freshPercentEl) freshPercentEl.textContent = '0.0';
                        if (burntPercentEl) burntPercentEl.textContent = '0.0';
                    }
                    console.log('Statistics data updated successfully');
                } catch (e) {
                    console.error('Error updating statistics data:', e);
                }
            } else {
                console.warn('No statistics data found');
            }
            
            // อัปเดตสถิติ
            console.log('Updating statistics panel...');
            if (data.statistics) {
                try {
                    updateStatisticsPanel(data.statistics);
                    console.log('Statistics panel updated successfully');
                } catch (e) {
                    console.error('Error updating statistics panel:', e);
                }
            } else {
                console.warn('Missing statistics data');
            }
            
            // อัปเดตการวิเคราะห์
            console.log('Updating analysis panel...');
            if (data.analysis) {
                try {
                    updateAnalysisPanel(data.analysis);
                    console.log('Analysis panel updated successfully');
                } catch (e) {
                    console.error('Error updating analysis panel:', e);
                }
            } else {
                console.warn('Missing analysis data');
            }
            
            // เรียงลำดับตาราง
            console.log('Sorting table...');
            try {
                sortTable(0);
                console.log('Table sorted successfully');
            } catch (e) {
                console.error('Error sorting table:', e);
            }
            
            // รีเฟรชกราฟ
            console.log('Refreshing charts...');
            try {
                refreshAllCharts(data);
                console.log('Charts refreshed successfully');
            } catch (e) {
                console.error('Error refreshing charts:', e);
            }

            currentStats = data.statistics || {};
            console.log('=== UPDATE DASHBOARD COMPLETED ===');
        }
        
        function updateAnalysisPanel(analysisData) {
            console.log('Updating analysis panel with:', analysisData); // Debug log
            
            if (!analysisData) {
                console.error("Analysis data is missing");
                return;
            }
            
            // Weather analysis update removed

            // Mode badges removed - no longer needed

            const exec = analysisData.executive;
            updateAndFlash('an-latest-time', exec.latest_time);
            updateAndFlash('an-latest-tons', exec.latest_tons);
            updateAndFlash('an-peak-time', exec.peak_time);
            updateAndFlash('an-peak-tons', exec.peak_tons);
            updateAndFlash('an-forecast-total', exec.forecast_total);
            updateAndFlash('an-forecast-hours', exec.forecast_hours);
            updateAndFlash('an-forecast-label', exec.forecast_label);

            const guru = analysisData.guru_analysis;
            if (guru) {
                const headlineEl = document.getElementById('guru-headline');
                const findingsEl = document.getElementById('guru-findings');
                const commentEl = document.getElementById('guru-comment');
                const recommendationEl = document.getElementById('guru-recommendation');
                const scoreDisplayEl = document.getElementById('score-overall-display');
                const headlineTextEl = document.getElementById('score-headline-text');

                headlineEl.innerHTML = `<i class="bi ${guru.headline.icon} me-2"></i>${guru.headline.text}`;
                headlineEl.className = `analysis-title ${guru.headline.color}`;
                findingsEl.innerHTML = guru.findings_html;
                commentEl.textContent = guru.comment;
                recommendationEl.textContent = guru.recommendation;

                // Update efficiency score
                if (guru.scores) {
                    updateAndFlash('efficiency-score', guru.scores.overall_score_display);
                    updateAndFlash('score-overall-display', guru.scores.overall_score_display);
                    updateAndFlash('score-headline-text', guru.headline.text);
                    
                    const scoreValue = guru.scores.overall_score_value;
                    const efficiencyScoreEl = document.getElementById('efficiency-score');
                    efficiencyScoreEl.className = "display-6 fw-bold";
                    if (scoreValue >= 8.5) efficiencyScoreEl.classList.add('text-success');
                    else if (scoreValue >= 7.0) efficiencyScoreEl.classList.add('text-primary');
                    else if (scoreValue >= 5.0) efficiencyScoreEl.classList.add('text-warning');
                    else if (scoreValue > 0) efficiencyScoreEl.classList.add('text-danger');
                    
                    scoreDisplayEl.className = "display-4 fw-bold";
                    if (scoreValue >= 8.5) scoreDisplayEl.classList.add('text-success');
                    else if (scoreValue >= 7.0) scoreDisplayEl.classList.add('text-primary');
                    else if (scoreValue >= 5.0) scoreDisplayEl.classList.add('text-warning');
                    else if (scoreValue > 0) scoreDisplayEl.classList.add('text-danger');
                    
                    headlineTextEl.className = "";
                    headlineTextEl.classList.add(guru.headline.color);
                }

                // Update efficiency metrics
                if (guru.efficiency_metrics) {
                    updateEfficiencyMetrics(guru.efficiency_metrics);
                }

                // Update anomalies
                console.log('Anomalies data:', guru.anomalies);
                if (guru.anomalies) {
                    updateAnomalies(guru.anomalies);
                }

                // Update operational insights
                if (guru.operational_insights) {
                    updateOperationalInsights(guru.operational_insights);
                }

                // Update AI prediction
                if (guru.prediction) {
                    updateAIPrediction(guru.prediction);
                }

                // Show enhanced sections
                document.getElementById('efficiency-metrics').style.display = 'block';
                document.getElementById('ai-prediction').style.display = 'block';
            }
        }

        function updateEfficiencyMetrics(metrics) {
            // Volume efficiency
            if (metrics.volume_efficiency !== undefined) {
                updateAndFlash('volume-efficiency-value', `${metrics.volume_efficiency.toFixed(1)}%`);
                const statusEl = document.getElementById('volume-efficiency-status');
                statusEl.textContent = metrics.volume_status;
                statusEl.className = `efficiency-status ${getStatusClass(metrics.volume_status)}`;
            }

            // Quality efficiency
            if (metrics.quality_efficiency !== undefined) {
                updateAndFlash('quality-efficiency-value', `${metrics.quality_efficiency.toFixed(1)}%`);
                const statusEl = document.getElementById('quality-efficiency-status');
                statusEl.textContent = metrics.quality_status;
                statusEl.className = `efficiency-status ${getStatusClass(metrics.quality_status)}`;
            }

            // Stability efficiency
            if (metrics.stability_status !== undefined) {
                updateAndFlash('stability-efficiency-value', metrics.stability_status);
                const statusEl = document.getElementById('stability-efficiency-status');
                statusEl.textContent = metrics.stability_status;
                statusEl.className = `efficiency-status ${getStatusClass(metrics.stability_status)}`;
            }

            // Hourly efficiency
            if (metrics.hourly_efficiency !== undefined) {
                updateAndFlash('hourly-efficiency-value', `${metrics.hourly_efficiency.toFixed(1)}%`);
                const statusEl = document.getElementById('hourly-efficiency-status');
                statusEl.textContent = metrics.hourly_status;
                statusEl.className = `efficiency-status ${getStatusClass(metrics.hourly_status)}`;
            }
        }

        function updateAnomalies(anomalies) {
            console.log('updateAnomalies called with:', anomalies);
            const anomalyContainer = document.getElementById('anomaly-detection');
            const anomaliesList = document.getElementById('anomalies-list');
            console.log('anomalyContainer:', anomalyContainer);
            console.log('anomaliesList:', anomaliesList);
            
            if (anomalies && anomalies.length > 0) {
                anomaliesList.innerHTML = anomalies.map(anomaly => {
                    // Determine anomaly type and icon
                    let icon = 'bi-exclamation-triangle-fill';
                    let category = 'warning';
                    let categoryText = 'คำเตือน';
                    
                    if (anomaly.includes('สูงกว่า') || anomaly.includes('สูงผิดปกติ') || anomaly.includes('ดีขึ้น')) {
                        icon = 'bi-arrow-up-circle-fill';
                        category = 'positive';
                        categoryText = 'ผลดี';
                    } else if (anomaly.includes('ต่ำกว่า') || anomaly.includes('ต่ำผิดปกติ') || anomaly.includes('ปัญหา')) {
                        icon = 'bi-exclamation-triangle-fill';
                        category = 'critical';
                        categoryText = 'ต้องแก้ไข';
                    }
                    
                    return `
                        <div class="anomaly-item ${category}">
                            <div class="d-flex align-items-start">
                                <i class="bi ${icon} anomaly-icon text-${category === 'positive' ? 'success' : category === 'critical' ? 'danger' : 'warning'}"></i>
                                <div class="flex-grow-1">
                                    <p class="anomaly-text">${anomaly}</p>
                                    <div class="anomaly-category">${categoryText}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                anomalyContainer.style.display = 'block';
            } else {
                anomalyContainer.style.display = 'none';
            }
        }

        function updateOperationalInsights(insights) {
            const insightsList = document.getElementById('insights-list');
            if (insights && insights.length > 0) {
                insightsList.innerHTML = insights.slice(0, 4).map(insight => 
                    `<li class="mb-2"><i class="bi bi-lightbulb me-1 small text-info"></i>${insight}</li>`
                ).join('');
            } else {
                insightsList.innerHTML = '<li class="mb-2"><i class="bi bi-info-circle me-1 small text-muted"></i>ไม่มีข้อมูลเชิงปฏิบัติเพิ่มเติม</li>';
            }
        }

        function updateAIPrediction(prediction) {
            const predictionEl = document.getElementById('prediction-text');
            if (prediction) {
                predictionEl.textContent = prediction;
            } else {
                predictionEl.textContent = 'ไม่มีข้อมูลการคาดการณ์';
            }
        }

        function getStatusClass(status) {
            if (status === 'สูง' || status === 'เสถียร') return 'high';
            if (status === 'ปกติ' || status === 'ปานกลาง') return 'normal';
            if (status === 'ต่ำ' || status === 'ผันผวน') return 'low';
            return 'normal';
        }

        function exportAnalysis() {
            const selectedDate = document.getElementById('date-picker').value;
            if (!selectedDate) {
                alert('กรุณาเลือกวันที่ก่อนส่งออกรายงาน');
                return;
            }
            
            // Show loading state
            const exportBtn = event.target;
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>กำลังสร้างรายงาน...';
            exportBtn.disabled = true;
            
            fetch(`/export_analysis_report?date=${selectedDate}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`เกิดข้อผิดพลาด: ${data.error}`);
                    } else {
                        // Create downloadable report
                        const reportContent = generateReportContent(data);
                        downloadReport(reportContent, `analysis_report_${selectedDate}.txt`);
                        alert('ส่งออกรายงานสำเร็จแล้ว');
                    }
                })
                .catch(error => {
                    console.error('Export error:', error);
                    alert('เกิดข้อผิดพลาดในการส่งออกรายงาน');
                })
                .finally(() => {
                    exportBtn.innerHTML = originalText;
                    exportBtn.disabled = false;
                });
        }

        function generateReportContent(data) {
            const report = data;
            let content = '';
            
            content += '='.repeat(60) + '\n';
            content += `รายงานการวิเคราะห์ AI - วันที่ ${report.report_date}\n`;
            content += `สร้างเมื่อ: ${new Date(report.generated_at).toLocaleString('th-TH')}\n`;
            content += '='.repeat(60) + '\n\n';
            
            // Summary
            content += 'สรุปข้อมูลประจำวัน:\n';
            content += `- ปริมาณรวม: ${report.summary.total_tons.toLocaleString('th-TH')} ตัน\n`;
            content += `- จำนวนรถ: ${report.summary.total_trucks.toLocaleString('th-TH')} คัน\n`;
            content += `- อ้อยสด: ${report.summary.fresh_percentage.toFixed(2)}%\n`;
            content += `- อ้อยไฟ: ${report.summary.burnt_percentage.toFixed(2)}%\n\n`;
            
            // Analysis
            content += 'ผลการวิเคราะห์ AI:\n';
            content += `- สถานะ: ${report.analysis.status}\n`;
            content += `- คะแนน: ${report.analysis.score}\n`;
            content += `- ความเห็น: ${report.analysis.comment}\n`;
            content += `- ข้อเสนอแนะ: ${report.analysis.recommendation}\n\n`;
            
            // Efficiency metrics
            if (report.efficiency_metrics) {
                content += 'ประสิทธิภาพการทำงาน:\n';
                if (report.efficiency_metrics.volume_efficiency) {
                    content += `- ประสิทธิภาพปริมาณ: ${report.efficiency_metrics.volume_efficiency.toFixed(1)}% (${report.efficiency_metrics.volume_status})\n`;
                }
                if (report.efficiency_metrics.quality_efficiency) {
                    content += `- ประสิทธิภาพคุณภาพ: ${report.efficiency_metrics.quality_efficiency.toFixed(1)}% (${report.efficiency_metrics.quality_status})\n`;
                }
                if (report.efficiency_metrics.stability_status) {
                    content += `- ความเสถียร: ${report.efficiency_metrics.stability_status}\n`;
                }
                content += '\n';
            }
            
            // Operational insights
            if (report.operational_insights && report.operational_insights.length > 0) {
                content += 'ข้อมูลเชิงปฏิบัติ:\n';
                report.operational_insights.forEach((insight, index) => {
                    content += `${index + 1}. ${insight}\n`;
                });
                content += '\n';
            }
            
            // Predictions
            if (report.predictions && report.predictions.length > 0) {
                content += 'การคาดการณ์:\n';
                report.predictions.forEach((prediction, index) => {
                    content += `${index + 1}. ${prediction}\n`;
                });
                content += '\n';
            }
            
            content += '='.repeat(60) + '\n';
            content += 'รายงานนี้สร้างโดยระบบ AI Insight & Analysis\n';
            content += '='.repeat(60) + '\n';
            
            return content;
        }

        function downloadReport(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function showDetailedAnalysis() {
            const selectedDate = document.getElementById('date-picker').value;
            if (!selectedDate) {
                alert('กรุณาเลือกวันที่ก่อนดูการวิเคราะห์ละเอียด');
                return;
            }
            
            // Show loading state
            const detailBtn = event.target;
            const originalText = detailBtn.innerHTML;
            detailBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>กำลังโหลด...';
            detailBtn.disabled = true;
            
            fetch(`/get_detailed_analytics?date=${selectedDate}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(`เกิดข้อผิดพลาด: ${data.error}`);
                    } else {
                        showDetailedAnalysisModal(data);
                    }
                })
                .catch(error => {
                    console.error('Detailed analysis error:', error);
                    alert('เกิดข้อผิดพลาดในการโหลดข้อมูลการวิเคราะห์ละเอียด');
                })
                .finally(() => {
                    detailBtn.innerHTML = originalText;
                    detailBtn.disabled = false;
                });
        }

        function showDetailedAnalysisModal(data) {
            // Create modal content
            let modalContent = `
                <div class="modal fade" id="detailedAnalysisModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content bg-dark text-light">
                            <div class="modal-header border-secondary">
                                <h5 class="modal-title">
                                    <i class="bi bi-graph-up me-2"></i>การวิเคราะห์ละเอียด - ${data.analysis_date}
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-warning">ประสิทธิภาพรายชั่วโมง</h6>
                                        <div class="table-responsive">
                                            <table class="table table-dark table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>เวลา</th>
                                                        <th>ปริมาณ (ตัน)</th>
                                                        <th>ประสิทธิภาพ</th>
                                                    </tr>
                                                </thead>
                                                <tbody>`;
            
            // Add hourly data
            data.hourly_analysis.forEach(hour => {
                const efficiencyClass = hour.efficiency === 'high' ? 'text-success' : 
                                      hour.efficiency === 'normal' ? 'text-warning' : 
                                      hour.efficiency === 'low' ? 'text-danger' : 'text-muted';
                const efficiencyText = hour.efficiency === 'high' ? 'สูง' : 
                                     hour.efficiency === 'normal' ? 'ปกติ' : 
                                     hour.efficiency === 'low' ? 'ต่ำ' : 'ไม่มีข้อมูล';
                
                modalContent += `
                    <tr>
                        <td>${hour.time_label}</td>
                        <td>${hour.Total_Tons.toFixed(2)}</td>
                        <td class="${efficiencyClass}">${efficiencyText}</td>
                    </tr>`;
            });
            
            modalContent += `
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-warning">สถิติประสิทธิภาพ</h6>
                                        <div class="card bg-secondary">
                                            <div class="card-body">
                                                <p><strong>ค่าเฉลี่ย 30 วัน:</strong> ${data.performance_stats.avg_tons?.toFixed(2) || 'N/A'} ตัน</p>
                                                <p><strong>ส่วนเบี่ยงเบนมาตรฐาน:</strong> ${data.performance_stats.std_tons?.toFixed(2) || 'N/A'} ตัน</p>
                                                <p><strong>ค่าต่ำสุด:</strong> ${data.performance_stats.min_tons?.toFixed(2) || 'N/A'} ตัน</p>
                                                <p><strong>ค่าสูงสุด:</strong> ${data.performance_stats.max_tons?.toFixed(2) || 'N/A'} ตัน</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer border-secondary">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('detailedAnalysisModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to page and show it
            document.body.insertAdjacentHTML('beforeend', modalContent);
            const modal = new bootstrap.Modal(document.getElementById('detailedAnalysisModal'));
            modal.show();
        }
        
        function updateStatisticsPanel(stats) {
            console.log('Updating statistics panel with:', stats); // Debug log
            
            if (!stats) {
                console.error('Statistics data is missing');
                return;
            }
            
            updateAndFlash('stat-today-total', (stats.today_total || 0).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            updateAndFlash('stat-today-truck-count', (stats.today_truck_count || 0).toLocaleString('th-TH'));
            updateAndFlash('stat-today-fresh', (stats.today_type_1 || 0).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            updateAndFlash('stat-today-fresh-pct', (stats.type_1_percent || 0).toFixed(2));
            updateAndFlash('stat-today-burnt', (stats.today_type_2 || 0).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            updateAndFlash('stat-today-burnt-pct', (stats.type_2_percent || 0).toFixed(2));

            updateAndFlash('stat-comparison-days', stats.comparison_period_days || '?');

            updateAndFlash('stat-all-time-total', (stats.total_cane_all || 0).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            updateAndFlash('stat-all-time-tons-a', (stats.total_tons_a_season || 0).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            updateAndFlash('stat-all-time-tons-b', (stats.total_tons_b_season || 0).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            updateAndFlash('stat-all-time-tons-a-pct', (stats.percent_tons_a_season || 0).toFixed(2));
            updateAndFlash('stat-all-time-tons-b-pct', (stats.percent_tons_b_season || 0).toFixed(2));
            updateAndFlash('stat-all-time-trucks-a', (stats.total_trucks_a_season || 0).toLocaleString('th-TH'));
            updateAndFlash('stat-all-time-trucks-b', (stats.total_trucks_b_season || 0).toLocaleString('th-TH'));
            updateAndFlash('stat-all-time-trucks-a-pct', (stats.percent_trucks_a_season || 0).toFixed(2));
            updateAndFlash('stat-all-time-trucks-b-pct', (stats.percent_trucks_b_season || 0).toFixed(2));
            updateAndFlash('stat-all-time-fresh', (stats.total_type_1 || 0).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            updateAndFlash('stat-all-time-fresh-pct', (stats.type_1_percent_overall || 0).toFixed(2));
            updateAndFlash('stat-all-time-burnt', (stats.total_type_2 || 0).toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            updateAndFlash('stat-all-time-burnt-pct', (stats.type_2_percent_overall || 0).toFixed(2));
        }
        
        // Virtual scrolling variables
        let virtualScrollData = [];
        let visibleStartIndex = 0;
        let visibleEndIndex = 50; // Show 50 rows at a time
        const ROW_HEIGHT = 50; // Approximate row height in pixels

        function renderTable() {
            console.log('=== RENDER TABLE START ===');
            console.log('Rendering table with data:', currentData); // Debug log
            
            // For large datasets, use virtual scrolling
            if (currentData.length > 100) {
                renderVirtualTable();
                return;
            }
            
            // ตรวจสอบ tableBody element
            if (!tableBody) {
                console.error('tableBody element not found');
                return;
            }
            
            if (!currentData || currentData.length === 0) {
                console.warn('No data to render in table');
                try {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                ไม่มีข้อมูลในตาราง กรุณาตรวจสอบการเชื่อมต่อหรือลองใหม่อีกครั้ง
                            </td>
                        </tr>
                    `;
                    console.log('Empty table message displayed');
                } catch (e) {
                    console.error('Error displaying empty table message:', e);
                }
                return;
            }
            
            try {
                tableBody.innerHTML = '';
                console.log('Table body cleared, starting to render rows...');
                
                currentData.forEach((row, index) => {
                    console.log(`Processing row ${index}:`, row); // Debug log
                    
                    try {
                        const tr = document.createElement('tr');
                        if (row.is_summary) {
                            tr.classList.add('summary-row');
                            tr.innerHTML = `
                                <td class="text-center">${row.Time || 'สรุปรวม'}</td>
                                <td class="text-center">${parseFloat(row.A_Count || 0).toLocaleString('th-TH', {minimumFractionDigits: 1, maximumFractionDigits: 1})}</td>
                                <td class="text-center">${parseFloat(row.A_Tons || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td class="text-center">${parseFloat(row.B_Count || 0).toLocaleString('th-TH', {minimumFractionDigits: 1, maximumFractionDigits: 1})}</td>
                                <td class="text-center">${parseFloat(row.B_Tons || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td class="text-center fw-bold">${parseFloat(row.Total_Count || 0).toLocaleString('th-TH', {minimumFractionDigits: 1, maximumFractionDigits: 1})}</td>
                                <td class="text-center fw-bold">${parseFloat(row.Total_Tons || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            `;
                        } else {
                             tr.innerHTML = `
                                <td class="text-center">${row.Time || 'N/A'}</td>
                                <td class="text-center">${parseFloat(row.A_Count || 0).toLocaleString('th-TH')}</td>
                                <td class="text-center">${parseFloat(row.A_Tons || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td class="text-center">${parseFloat(row.B_Count || 0).toLocaleString('th-TH')}</td>
                                <td class="text-center">${parseFloat(row.B_Tons || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                <td class="text-center">${parseFloat(row.Total_Count || 0).toLocaleString('th-TH')}</td>
                                <td class="text-center">${parseFloat(row.Total_Tons || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            `;
                        }
                        tableBody.appendChild(tr);
                        console.log(`Row ${index} added successfully`);
                    } catch (rowError) {
                        console.error(`Error processing row ${index}:`, rowError);
                        console.error('Row data:', row);
                    }
                });
                
                console.log('All rows processed successfully');
            } catch (tableError) {
                console.error('Error rendering table:', tableError);
                // แสดงข้อความข้อผิดพลาดในตาราง
                try {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-danger">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                เกิดข้อผิดพลาดในการแสดงตาราง: ${tableError.message}
                            </td>
                        </tr>
                    `;
                } catch (displayError) {
                    console.error('Could not display error message:', displayError);
                }
            }
            
            console.log('=== RENDER TABLE COMPLETED ===');
        }

        function renderVirtualTable() {
            console.log('=== RENDER VIRTUAL TABLE START ===');
            
            if (!tableBody) {
                console.error('tableBody element not found');
                return;
            }

            // Update virtual scroll data
            virtualScrollData = currentData;
            
            // Calculate visible range
            const visibleData = virtualScrollData.slice(visibleStartIndex, visibleEndIndex);
            
            // Clear table
            tableBody.innerHTML = '';
            
            // Add spacer for items before visible range
            if (visibleStartIndex > 0) {
                const spacer = document.createElement('tr');
                spacer.style.height = `${visibleStartIndex * ROW_HEIGHT}px`;
                spacer.innerHTML = '<td colspan="8"></td>';
                tableBody.appendChild(spacer);
            }
            
            // Render visible rows
            visibleData.forEach((row, index) => {
                const actualIndex = visibleStartIndex + index;
                const tr = createTableRow(row, actualIndex);
                tableBody.appendChild(tr);
            });
            
            // Add spacer for items after visible range
            const remainingItems = virtualScrollData.length - visibleEndIndex;
            if (remainingItems > 0) {
                const spacer = document.createElement('tr');
                spacer.style.height = `${remainingItems * ROW_HEIGHT}px`;
                spacer.innerHTML = '<td colspan="8"></td>';
                tableBody.appendChild(spacer);
            }
            
            console.log('=== RENDER VIRTUAL TABLE COMPLETED ===');
        }

        function createTableRow(row, index) {
            const tr = document.createElement('tr');
            tr.className = 'animate__animated animate__fadeIn';
            tr.style.animationDelay = `${index * 0.05}s`;
            
            const isSummary = row.is_summary;
            const rowClass = isSummary ? 'table-warning fw-bold' : '';
            tr.className += ` ${rowClass}`;
            
            tr.innerHTML = `
                <td class="text-center">${row.Time || '-'}</td>
                <td class="text-center">${row.A_Count ? row.A_Count.toLocaleString('th-TH') : '0'}</td>
                <td class="text-center">${row.A_Tons ? row.A_Tons.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00'}</td>
                <td class="text-center">${row.B_Count ? row.B_Count.toLocaleString('th-TH') : '0'}</td>
                <td class="text-center">${row.B_Tons ? row.B_Tons.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00'}</td>
                <td class="text-center">${row.Total_Count ? row.Total_Count.toLocaleString('th-TH') : '0'}</td>
                <td class="text-center">${row.Total_Tons ? row.Total_Tons.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00'}</td>
                <td class="text-center">
                    ${row.Fresh_Tons ? row.Fresh_Tons.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00'} / 
                    ${row.Burnt_Tons ? row.Burnt_Tons.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : '0.00'}
                </td>
            `;
            
            return tr;
        }

        // Virtual scroll event handler
        function handleVirtualScroll(event) {
            const table = event.target;
            const scrollTop = table.scrollTop;
            const containerHeight = table.clientHeight;
            
            // Calculate new visible range
            const newStartIndex = Math.floor(scrollTop / ROW_HEIGHT);
            const newEndIndex = Math.min(newStartIndex + Math.ceil(containerHeight / ROW_HEIGHT) + 10, virtualScrollData.length);
            
            // Only re-render if the range has changed significantly
            if (Math.abs(newStartIndex - visibleStartIndex) > 5) {
                visibleStartIndex = newStartIndex;
                visibleEndIndex = newEndIndex;
                renderVirtualTable();
            }
        }
        
        const chartColors = { 
            A: '#6366f1', 
            B: '#10b981', 
            Fresh: '#059669', 
            Burnt: '#dc2626', 
            Total: '#f59e0b',
            // เพิ่มสีใหม่สำหรับกราฟที่สวยงาม
            primary: '#3b82f6',
            secondary: '#8b5cf6',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            info: '#06b6d4',
            light: '#f3f4f6',
            dark: '#1f2937'
        };
        
        const commonLayoutOptions = {
            font: { 
                color: '#f8f9fa', 
                family: 'Sarabun, sans-serif',
                size: 12
            },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'rgba(255, 255, 255, 0.02)',
            margin: { l: 70, r: 30, t: 50, b: 60 },
            legend: { 
                x: 0.5, 
                y: 1.05, 
                xanchor: 'center', 
                orientation: 'h', 
                bgcolor: 'rgba(0,0,0,0.3)',
                bordercolor: 'rgba(255,255,255,0.2)',
                borderwidth: 1,
                font: { size: 11 }
            },
            xaxis: { 
                gridcolor: 'rgba(255,255,255,0.08)',
                gridwidth: 1,
                zeroline: false,
                showline: true,
                linecolor: 'rgba(255,255,255,0.2)',
                linewidth: 1,
                tickfont: { size: 11 }
            },
            yaxis: { 
                gridcolor: 'rgba(255,255,255,0.08)',
                gridwidth: 1,
                zeroline: false,
                showline: true,
                linecolor: 'rgba(255,255,255,0.2)',
                linewidth: 1,
                tickfont: { size: 11 }
            },
            // เพิ่มเอฟเฟกต์ที่สวยงาม
            hovermode: 'closest',
            hoverlabel: {
                bgcolor: 'rgba(0,0,0,0.8)',
                bordercolor: 'rgba(255,255,255,0.2)',
                font: { size: 11 }
            }
        };
        
        const pieLayoutOptions = { 
            ...commonLayoutOptions, 
            legend: { 
                x: 0.5, 
                y: -0.1, 
                xanchor: 'center', 
                orientation: 'h',
                bgcolor: 'rgba(0,0,0,0.3)',
                bordercolor: 'rgba(255,255,255,0.2)',
                borderwidth: 1
            } 
        };
        
        const chartConfig = { 
            responsive: true, 
            displayModeBar: false,
            modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'autoScale2d'],
            // เพิ่มการแสดงผลที่สวยงาม
            staticPlot: false,
            displaylogo: false
        };

        function renderHourlyTonsChart(elementId, data) {
            const hourlyData = data.filter(d => !d.is_summary);
            const times = hourlyData.map(d => d.Time);
            const traces = [
                { 
                    x: times, 
                    y: hourlyData.map(d => d.A_Tons), 
                    name: 'ราง A', 
                    type: 'scatter', 
                    mode: 'lines+markers', 
                    line: { 
                        color: chartColors.A, 
                        width: 4,
                        shape: 'spline'
                    },
                    marker: {
                        size: 6,
                        color: chartColors.A,
                        line: { color: '#ffffff', width: 2 }
                    },
                    hovertemplate: '<b>ราง A</b><br>เวลา: %{x}<br>ปริมาณ: %{y:,.2f} ตัน<extra></extra>',
                    fill: 'tonexty',
                    fillcolor: 'rgba(99, 102, 241, 0.1)'
                },
                { 
                    x: times, 
                    y: hourlyData.map(d => d.B_Tons), 
                    name: 'ราง B', 
                    type: 'scatter', 
                    mode: 'lines+markers', 
                    line: { 
                        color: chartColors.B, 
                        width: 4,
                        shape: 'spline'
                    },
                    marker: {
                        size: 6,
                        color: chartColors.B,
                        line: { color: '#ffffff', width: 2 }
                    },
                    hovertemplate: '<b>ราง B</b><br>เวลา: %{x}<br>ปริมาณ: %{y:,.2f} ตัน<extra></extra>',
                    fill: 'tonexty',
                    fillcolor: 'rgba(16, 185, 129, 0.1)'
                }
            ];
            
            const layout = {
                ...commonLayoutOptions,
                title: {
                    text: 'ปริมาณอ้อยรายชั่วโมง (ตัน)',
                    font: { size: 16, color: '#f8f9fa' },
                    x: 0.5,
                    y: 0.95
                },
                yaxis: { 
                    ...commonLayoutOptions.yaxis, 
                    title: { text: 'ปริมาณ (ตัน)', font: { size: 12 } }
                },
                xaxis: { 
                    ...commonLayoutOptions.xaxis, 
                    title: { text: 'เวลา', font: { size: 12 } }
                }
            };
            
            Plotly.react(elementId, traces, layout, chartConfig);
        }

        function renderHourlyCountsChart(elementId, data) {
            const hourlyData = data.filter(d => !d.is_summary);
            const times = hourlyData.map(d => d.Time);
            const traces = [
                { 
                    x: times, 
                    y: hourlyData.map(d => d.A_Count), 
                    name: 'ราง A', 
                    type: 'scatter', 
                    mode: 'lines+markers', 
                    line: { 
                        color: chartColors.A, 
                        width: 4,
                        shape: 'spline'
                    },
                    marker: {
                        size: 6,
                        color: chartColors.A,
                        line: { color: '#ffffff', width: 2 }
                    },
                    hovertemplate: '<b>ราง A</b><br>เวลา: %{x}<br>จำนวนรถ: %{y:,.0f} คัน<extra></extra>',
                    fill: 'tonexty',
                    fillcolor: 'rgba(99, 102, 241, 0.1)'
                },
                { 
                    x: times, 
                    y: hourlyData.map(d => d.B_Count), 
                    name: 'ราง B', 
                    type: 'scatter', 
                    mode: 'lines+markers', 
                    line: { 
                        color: chartColors.B, 
                        width: 4,
                        shape: 'spline'
                    },
                    marker: {
                        size: 6,
                        color: chartColors.B,
                        line: { color: '#ffffff', width: 2 }
                    },
                    hovertemplate: '<b>ราง B</b><br>เวลา: %{x}<br>จำนวนรถ: %{y:,.0f} คัน<extra></extra>',
                    fill: 'tonexty',
                    fillcolor: 'rgba(16, 185, 129, 0.1)'
                }
            ];
            
            const layout = {
                ...commonLayoutOptions,
                title: {
                    text: 'จำนวนรถรายชั่วโมง (คัน)',
                    font: { size: 16, color: '#f8f9fa' },
                    x: 0.5,
                    y: 0.95
                },
                yaxis: { 
                    ...commonLayoutOptions.yaxis, 
                    title: { text: 'จำนวนรถ (คัน)', font: { size: 12 } }
                },
                xaxis: { 
                    ...commonLayoutOptions.xaxis, 
                    title: { text: 'เวลา', font: { size: 12 } }
                }
            };
            
            Plotly.react(elementId, traces, layout, chartConfig);
        }

        function renderCumulativeTypesChart(elementId, data) {
            const traces = [
                { 
                    x: data.times, 
                    y: data.fresh, 
                    name: 'อ้อยสดสะสม', 
                    type: 'scatter', 
                    mode: 'lines', 
                    line: { 
                        color: chartColors.Fresh, 
                        width: 4,
                        shape: 'spline'
                    }, 
                    fill: 'tonexty', 
                    fillcolor: 'rgba(5, 150, 105, 0.2)',
                    hovertemplate: '<b>อ้อยสดสะสม</b><br>เวลา: %{x}<br>ปริมาณ: %{y:,.2f} ตัน<extra></extra>'
                },
                { 
                    x: data.times, 
                    y: data.burnt, 
                    name: 'อ้อยไฟสะสม', 
                    type: 'scatter', 
                    mode: 'lines', 
                    line: { 
                        color: chartColors.Burnt, 
                        width: 4,
                        shape: 'spline'
                    }, 
                    fill: 'tonexty', 
                    fillcolor: 'rgba(220, 38, 38, 0.2)',
                    hovertemplate: '<b>อ้อยไฟสะสม</b><br>เวลา: %{x}<br>ปริมาณ: %{y:,.2f} ตัน<extra></extra>'
                }
            ];
            
            const layout = {
                ...commonLayoutOptions,
                title: {
                    text: 'ปริมาณอ้อยสะสมตามประเภท (ตัน)',
                    font: { size: 16, color: '#f8f9fa' },
                    x: 0.5,
                    y: 0.95
                },
                yaxis: { 
                    ...commonLayoutOptions.yaxis, 
                    title: { text: 'ปริมาณสะสม (ตัน)', font: { size: 12 } }
                },
                xaxis: { 
                    ...commonLayoutOptions.xaxis, 
                    title: { text: 'เวลา', font: { size: 12 } }
                }
            };
            
            Plotly.react(elementId, traces, layout, chartConfig);
        }
        
        function renderCumulativeLinesChart(elementId, data) {
            const traces = [
                { 
                    x: data.times, 
                    y: data.a_tons, 
                    name: 'ราง A สะสม', 
                    type: 'scatter', 
                    mode: 'lines', 
                    line: { 
                        color: chartColors.A, 
                        width: 4,
                        shape: 'spline'
                    }, 
                    fill: 'tonexty', 
                    fillcolor: 'rgba(99, 102, 241, 0.2)',
                    hovertemplate: '<b>ราง A สะสม</b><br>เวลา: %{x}<br>ปริมาณ: %{y:,.2f} ตัน<extra></extra>'
                },
                { 
                    x: data.times, 
                    y: data.b_tons, 
                    name: 'ราง B สะสม', 
                    type: 'scatter', 
                    mode: 'lines', 
                    line: { 
                        color: chartColors.B, 
                        width: 4,
                        shape: 'spline'
                    }, 
                    fill: 'tonexty', 
                    fillcolor: 'rgba(16, 185, 129, 0.2)',
                    hovertemplate: '<b>ราง B สะสม</b><br>เวลา: %{x}<br>ปริมาณ: %{y:,.2f} ตัน<extra></extra>'
                }
            ];
            
            const layout = {
                ...commonLayoutOptions,
                title: {
                    text: 'ปริมาณอ้อยสะสมตามราง (ตัน)',
                    font: { size: 16, color: '#f8f9fa' },
                    x: 0.5,
                    y: 0.95
                },
                yaxis: { 
                    ...commonLayoutOptions.yaxis, 
                    title: { text: 'ปริมาณสะสม (ตัน)', font: { size: 12 } }
                },
                xaxis: { 
                    ...commonLayoutOptions.xaxis, 
                    title: { text: 'เวลา', font: { size: 12 } }
                }
            };
            
            Plotly.react(elementId, traces, layout, chartConfig);
        }
        
        function renderHistoricalChart(elementId, data) {
            console.log('Historical chart data received:', data);
            const dates = data.map(d => d.report_date);
            const totalTons = data.map(d => {
                const tons = parseFloat(d.total_tons) || 0;
                console.log(`Date: ${d.report_date}, Total tons: ${d.total_tons}, Parsed: ${tons}`);
                return tons;
            });
            const traces = [
                { 
                    x: dates, 
                    y: totalTons, 
                    name: 'รวมทั้งหมด', 
                    type: 'scatter', 
                    mode: 'lines+markers', 
                    line: { 
                        color: chartColors.Total, 
                        width: 4,
                        shape: 'spline'
                    },
                    marker: {
                        size: 6,
                        color: chartColors.Total,
                        line: { color: '#ffffff', width: 2 }
                    },
                    hovertemplate: '<b>รวมทั้งหมด</b><br>วันที่: %{x}<br>ปริมาณ: %{y:,.2f} ตัน<extra></extra>',
                    fill: 'tonexty',
                    fillcolor: 'rgba(245, 158, 11, 0.1)'
                }
            ];
            
            const layout = {
                ...commonLayoutOptions,
                title: {
                    text: 'ข้อมูลย้อนหลัง - ปริมาณอ้อยรายวัน',
                    font: { size: 16, color: '#f8f9fa' },
                    x: 0.5,
                    y: 0.95
                },
                yaxis: { 
                    ...commonLayoutOptions.yaxis, 
                    title: { text: 'ปริมาณตันต่อวัน', font: { size: 12 } }
                },
                xaxis: { 
                    ...commonLayoutOptions.xaxis, 
                    type: 'date',
                    title: { text: 'วันที่', font: { size: 12 } }
                }
            };
            
            Plotly.react(elementId, traces, layout, chartConfig);
        }
        
        function renderHeatmap(elementId, data) {
            const trace = [{
                z: data.z,
                x: data.x.map(h => `${h}:00`),
                y: data.y,
                type: 'heatmap',
                colorscale: [
                    [0, 'rgba(59, 130, 246, 0.1)'],
                    [0.2, 'rgba(59, 130, 246, 0.3)'],
                    [0.4, 'rgba(59, 130, 246, 0.5)'],
                    [0.6, 'rgba(59, 130, 246, 0.7)'],
                    [0.8, 'rgba(59, 130, 246, 0.9)'],
                    [1, 'rgba(59, 130, 246, 1)']
                ],
                reversescale: false,
                hovertemplate: '<b>ปริมาณอ้อย</b><br>วันที่: %{y}<br>เวลา: %{x}<br>ปริมาณ: %{z:,.2f} ตัน<extra></extra>',
                showscale: true,
                colorbar: {
                    title: 'ปริมาณ (ตัน)',
                    titleside: 'right',
                    thickness: 15,
                    len: 0.8,
                    outlinewidth: 1,
                    outlinecolor: 'rgba(255,255,255,0.2)',
                    tickfont: { color: '#f8f9fa', size: 10 }
                }
            }];
            
            const layout = {
                ...commonLayoutOptions,
                title: {
                    text: 'Heatmap ปริมาณอ้อยรายชั่วโมง',
                    font: { size: 16, color: '#f8f9fa' },
                    x: 0.5,
                    y: 0.95
                },
                xaxis: { 
                    ...commonLayoutOptions.xaxis, 
                    title: { text: 'ชั่วโมง', font: { size: 12 } }
                },
                yaxis: { 
                    ...commonLayoutOptions.yaxis, 
                    title: { text: 'วันที่', font: { size: 12 } },
                    autorange: 'reversed' 
                }
            };
            
            Plotly.react(elementId, trace, layout, chartConfig);
        }

        function renderMonthlyBarChart(elementId, data) {
            console.log('renderMonthlyBarChart called with:', elementId, data);
            
            if (!data || data.length === 0) {
                console.error('No data provided to renderMonthlyBarChart');
                return;
            }
            
            const months = data.map(d => d.report_month);
            const tons = data.map(d => d.total_tons);
            
            console.log('Months:', months);
            console.log('Tons:', tons);
            
            // สร้างสีแบบ gradient ตามปริมาณ
            const maxTons = Math.max(...tons);
            const colors = tons.map(ton => {
                const intensity = ton / maxTons;
                return `rgba(59, 130, 246, ${0.3 + intensity * 0.7})`;
            });
            
            // สร้าง customdata array สำหรับแต่ละ bar
            const customData = data.map(d => {
                const freshPercent = d.total_tons > 0 ? ((d.fresh_tons / d.total_tons) * 100) : 0;
                const burntPercent = d.total_tons > 0 ? ((d.burnt_tons / d.total_tons) * 100) : 0;
                const lineAPercent = d.total_tons > 0 ? ((d.line_a_tons / d.total_tons) * 100) : 0;
                const lineBPercent = d.total_tons > 0 ? ((d.line_b_tons / d.total_tons) * 100) : 0;
                
                return [
                    d.fresh_tons, freshPercent,
                    d.burnt_tons, burntPercent,
                    d.line_a_tons, lineAPercent,
                    d.line_b_tons, lineBPercent,
                    d.total_trucks,
                    d.fresh_trucks,
                    d.burnt_trucks
                ];
            });
            
            // สร้าง custom hovertemplate ที่ใช้ customdata
            const customHoverTemplate = '<b style="color: #ffffff; font-size: 16px;">%{x}</b><br>' +
                '<span style="color: #3b82f6; font-weight: bold; font-size: 14px;">📊 ปริมาณรวม: %{y:,.0f} ตัน</span><br>' +
                '<span style="color: #10b981; font-weight: bold; font-size: 14px;">🌿 อ้อยสด: %{customdata[0]:,.0f} ตัน (%{customdata[1]:.1f}%)</span><br>' +
                '<span style="color: #f59e0b; font-weight: bold; font-size: 14px;">🔥 อ้อยไฟ: %{customdata[2]:,.0f} ตัน (%{customdata[3]:.1f}%)</span><br>' +
                '<span style="color: #8b5cf6; font-weight: bold; font-size: 14px;">🚛 ราง A: %{customdata[4]:,.0f} ตัน (%{customdata[5]:.1f}%)</span><br>' +
                '<span style="color: #06b6d4; font-weight: bold; font-size: 14px;">🚚 ราง B: %{customdata[6]:,.0f} ตัน (%{customdata[7]:.1f}%)</span><br>' +
                '<span style="color: #ffffff; font-weight: bold; font-size: 14px;">📦 จำนวนรถ: %{customdata[8]:,.0f} คัน</span><br>' +
                '<span style="color: #10b981; font-weight: bold; font-size: 14px;">🌿 รถอ้อยสด: %{customdata[9]:,.0f} คัน</span><br>' +
                '<span style="color: #f59e0b; font-weight: bold; font-size: 14px;">🔥 รถอ้อยไฟ: %{customdata[10]:,.0f} คัน</span><extra></extra>';
            
            const trace = [{
                x: months,
                y: tons,
                type: 'bar',
                customdata: customData,
                marker: {
                    color: colors,
                    line: {
                        color: 'rgba(255,255,255,0.3)',
                        width: 1
                    }
                },
                hovertemplate: customHoverTemplate,
                text: tons.map(t => t.toLocaleString('th-TH', {minimumFractionDigits: 0, maximumFractionDigits: 0})),
                textposition: 'outside',
                textfont: { color: '#f8f9fa', size: 11 }
            }];
            
            const layout = {
                ...commonLayoutOptions,
                title: {
                    text: 'สรุปยอดอ้อยรายเดือน (ตลอดฤดูกาล)',
                    font: { size: 16, color: '#f8f9fa' },
                    x: 0.5,
                    y: 0.95
                },
                yaxis: { 
                    ...commonLayoutOptions.yaxis, 
                    title: { text: 'ปริมาณอ้อย (ตัน)', font: { size: 12 } }
                },
                xaxis: { 
                    ...commonLayoutOptions.xaxis, 
                    type: 'category',
                    title: { text: 'เดือน', font: { size: 12 } }
                }
            };
            
            console.log('About to render Plotly chart with:', { elementId, trace, layout });
            Plotly.react(elementId, trace, layout, chartConfig).then(() => {
                console.log('Monthly chart rendered successfully');
            }).catch(error => {
                console.error('Error rendering monthly chart:', error);
            });
        }

        function refreshAllCharts(data) {
            if (!data) {
                console.warn('No data provided for charts refresh');
                return;
            }
            
            try {
                if (data.hourly_data) {
                    renderHourlyTonsChart('chart-hourly-tons', data.hourly_data);
                    renderHourlyCountsChart('chart-hourly-counts', data.hourly_data);
                }
                
                // Also refresh monthly chart
                setTimeout(() => {
                    fetchMonthlyData();
                }, 100);
                
                if (data.cumulative) {
                    renderCumulativeTypesChart('chart-cumulative-types', data.cumulative);
                    renderCumulativeLinesChart('chart-cumulative-lines', data.cumulative);
                }
            } catch (error) {
                console.error('Error refreshing charts:', error);
            }
        }
        
        // --- NEW AND MODIFIED FUNCTIONS ---

        function fetchAllHistoricalData() {
            fetchHistoricalData();
            fetchHeatmapData();
            // เพิ่มการโหลดกราฟแท่งน้ำหนักด้วย
            const activeTab = document.querySelector('#historicalTab .nav-link.active');
            if (activeTab && activeTab.id === 'daily-weight-bar-tab') {
                fetchDailyWeightData();
            }
        }

        // Mobile-friendly functions
        function setDefaultDateRange() {
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('historical-start-date').value = lastWeek.toISOString().split('T')[0];
            document.getElementById('historical-end-date').value = today.toISOString().split('T')[0];
        }

        function toggleChartFullscreen(chartId) {
            const chartElement = document.getElementById(chartId);
            if (!chartElement) return;

            if (chartElement.requestFullscreen) {
                chartElement.requestFullscreen();
            } else if (chartElement.webkitRequestFullscreen) {
                chartElement.webkitRequestFullscreen();
            } else if (chartElement.msRequestFullscreen) {
                chartElement.msRequestFullscreen();
            }
        }

        function downloadChart(chartId) {
            const chartElement = document.getElementById(chartId);
            if (!chartElement) return;

            // Create a temporary canvas to capture the chart
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = chartElement.offsetWidth;
            canvas.height = chartElement.offsetHeight;

            // For Plotly charts, use the built-in download functionality
            if (window.Plotly && chartElement.data) {
                Plotly.downloadImage(chartElement, {
                    format: 'png',
                    width: 800,
                    height: 600,
                    filename: 'chart-' + chartId
                });
            }
        }

        // Enhanced mobile touch support
        function initializeMobileSupport() {
            // Add touch event listeners for better mobile interaction
            const chartContainers = document.querySelectorAll('.chart-container');
            chartContainers.forEach(container => {
                container.addEventListener('touchstart', function(e) {
                    this.style.transform = 'scale(0.98)';
                });
                
                container.addEventListener('touchend', function(e) {
                    this.style.transform = 'scale(1)';
                });
            });

            // Optimize chart rendering for mobile
            if (window.innerWidth <= 768) {
                // Reduce chart complexity on mobile
                window.mobileOptimized = true;
            }
        }

        // Initialize mobile support when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeMobileSupport();
        });

        async function fetchHistoricalData() {
            // This function remains largely the same
            const startDate = document.getElementById('historical-start-date').value;
            const endDate = document.getElementById('historical-end-date').value;
            const chartContainer = document.getElementById('chart-historical-data');
            const messageDiv = document.getElementById('historical-data-message');
            
            if (!startDate || !endDate) {
                messageDiv.textContent = "กรุณาเลือกทั้งวันที่เริ่มต้นและสิ้นสุด";
                messageDiv.style.display = 'block';
                return;
            }
            if (new Date(startDate) > new Date(endDate)) {
                messageDiv.textContent = "วันที่เริ่มต้นต้องไม่เกินวันที่สิ้นสุด";
                messageDiv.style.display = 'block';
                return;
            }

            messageDiv.textContent = "กำลังโหลดข้อมูล...";
            messageDiv.style.display = 'block';
            Plotly.purge(chartContainer);

            const url = `/get_historical_data?start_date=${startDate}&end_date=${endDate}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                const data = await response.json();
                
                console.log('Raw response from backend:', data);
                
                if (data.error) throw new Error(data.error);
                if (data.length === 0) {
                    messageDiv.textContent = "ไม่พบข้อมูลในข่วงวันที่ที่เลือก";
                    return;
                }

                messageDiv.style.display = 'none';
                renderHistoricalChart('chart-historical-data', data);
            } catch (error) {
                console.error("ไม่สามารถดึงข้อมูลย้อนหลังได้:", error);
                messageDiv.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
            }
        }

        async function fetchHeatmapData() {
            const startDate = document.getElementById('historical-start-date').value;
            const endDate = document.getElementById('historical-end-date').value;
            const chartContainer = document.getElementById('chart-heatmap');
            const messageDiv = document.getElementById('heatmap-message');
            
            messageDiv.textContent = "กำลังโหลดข้อมูล Heatmap...";
            messageDiv.style.display = 'block';
            Plotly.purge(chartContainer);

            const url = `/get_heatmap_data?start_date=${startDate}&end_date=${endDate}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                const data = await response.json();

                if (data.error) throw new Error(data.error);
                if (data.z.length === 0) {
                    messageDiv.textContent = "ไม่พบข้อมูลสำหรับสร้าง Heatmap";
                    return;
                }

                messageDiv.style.display = 'none';
                renderHeatmap('chart-heatmap', data);
            } catch (error) {
                console.error("ไม่สามารถดึงข้อมูล Heatmap ได้:", error);
                messageDiv.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
            }
        }

        async function fetchMonthlyData() {
            const chartContainer = document.getElementById('chart-monthly-bar');
            const messageDiv = document.getElementById('monthly-bar-message');
            
            if (!chartContainer) {
                console.error('Monthly chart container not found');
                return;
            }
            
            if (!messageDiv) {
                console.error('Monthly chart message div not found');
                return;
            }
            
            messageDiv.style.display = 'block';
            messageDiv.textContent = 'กำลังโหลดข้อมูลรายเดือน...';
            Plotly.purge(chartContainer);

            const url = '/get_monthly_data';
            try {
                console.log('Fetching monthly data from:', url);
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                const data = await response.json();

                console.log('Monthly data received:', data);

                if (data.error) throw new Error(data.error);
                if (data.length === 0) {
                    messageDiv.textContent = "ไม่พบข้อมูลรายเดือน";
                    return;
                }
                
                messageDiv.style.display = 'none';
                console.log('Rendering monthly chart with data:', data);
                renderMonthlyBarChart('chart-monthly-bar', data);
            } catch (error) {
                console.error("ไม่สามารถดึงข้อมูลรายเดือนได้:", error);
                messageDiv.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
            }
        }

        // --- DAILY WEIGHT BAR CHART FUNCTIONS ---

        async function fetchDailyWeightData() {
            // ใช้วันที่เดียวกับส่วนข้อมูลย้อนหลัง
            const startDate = document.getElementById('historical-start-date').value;
            const endDate = document.getElementById('historical-end-date').value;
            const chartContainer = document.getElementById('chart-daily-weight');
            const messageDiv = document.getElementById('daily-weight-message');
            const summaryDiv = document.getElementById('daily-weight-summary');
            
            if (!startDate || !endDate) {
                messageDiv.textContent = "กรุณาเลือกทั้งวันที่เริ่มต้นและสิ้นสุด";
                messageDiv.style.display = 'block';
                summaryDiv.style.display = 'none';
                return;
            }
            if (new Date(startDate) > new Date(endDate)) {
                messageDiv.textContent = "วันที่เริ่มต้นต้องไม่เกินวันที่สิ้นสุด";
                messageDiv.style.display = 'block';
                summaryDiv.style.display = 'none';
                return;
            }

            messageDiv.textContent = "กำลังโหลดข้อมูลน้ำหนักรายวัน...";
            messageDiv.style.display = 'block';
            summaryDiv.style.display = 'none';
            Plotly.purge(chartContainer);

            const url = `/get_daily_weight_data?start_date=${startDate}&end_date=${endDate}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                const data = await response.json();

                if (data.error) throw new Error(data.error);
                if (data.data.length === 0) {
                    messageDiv.textContent = data.message || "ไม่พบข้อมูลน้ำหนักในช่วงวันที่ที่เลือก";
                    return;
                }

                messageDiv.style.display = 'none';
                renderDailyWeightBarChart('chart-daily-weight', data);
                updateDailyWeightSummary(data.summary);
            } catch (error) {
                console.error("ไม่สามารถดึงข้อมูลน้ำหนักรายวันได้:", error);
                messageDiv.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
            }
        }

        async function fetchDailyWeightComparison() {
            // ใช้วันที่เดียวกับส่วนข้อมูลย้อนหลัง
            const endDate = document.getElementById('historical-end-date').value;
            const chartContainer = document.getElementById('chart-daily-weight');
            const messageDiv = document.getElementById('daily-weight-message');
            const summaryDiv = document.getElementById('daily-weight-summary');
            
            if (!endDate) {
                messageDiv.textContent = "กรุณาเลือกวันที่สิ้นสุด";
                messageDiv.style.display = 'block';
                summaryDiv.style.display = 'none';
                return;
            }

            messageDiv.textContent = "กำลังโหลดข้อมูลเปรียบเทียบ...";
            messageDiv.style.display = 'block';
            summaryDiv.style.display = 'none';
            Plotly.purge(chartContainer);

            const url = `/get_daily_weight_comparison?date=${endDate}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
                const data = await response.json();

                if (data.error) throw new Error(data.error);
                if (data.comparison.current_period.length === 0 && data.comparison.previous_period.length === 0) {
                    messageDiv.textContent = data.message || "ไม่พบข้อมูลสำหรับการเปรียบเทียบ";
                    return;
                }

                messageDiv.style.display = 'none';
                renderDailyWeightComparisonChart('chart-daily-weight', data.comparison);
                updateDailyWeightComparisonSummary(data.comparison.summary);
            } catch (error) {
                console.error("ไม่สามารถดึงข้อมูลเปรียบเทียบได้:", error);
                messageDiv.textContent = `เกิดข้อผิดพลาด: ${error.message}`;
            }
        }

        function renderDailyWeightBarChart(elementId, data) {
            console.log('Daily weight data received:', data);
            const dates = data.data.map(d => d.date);
            const weights = data.data.map(d => {
                const weight = parseFloat(d.total_weight) || 0;
                console.log(`Date: ${d.date}, Total weight: ${d.total_weight}, Parsed: ${weight}`);
                return weight;
            });
            const freshWeights = data.data.map(d => parseFloat(d.fresh_weight) || 0);
            const burntWeights = data.data.map(d => parseFloat(d.burnt_weight) || 0);
            
            // สร้างสีแบบ gradient ตามปริมาณ
            const validWeights = weights.filter(w => !isNaN(w) && w > 0);
            const maxWeight = validWeights.length > 0 ? Math.max(...validWeights) : 1;
            const colors = weights.map(weight => {
                const safeWeight = isNaN(weight) ? 0 : weight;
                const intensity = maxWeight > 0 ? safeWeight / maxWeight : 0;
                return `rgba(34, 197, 94, ${0.4 + intensity * 0.6})`;
            });

            const traces = [
                {
                    x: dates,
                    y: weights,
                    type: 'bar',
                    name: 'น้ำหนักรวม',
                    marker: {
                        color: colors,
                        line: {
                            color: 'rgba(255,255,255,0.3)',
                            width: 1
                        }
                    },
                    hovertemplate: '<b>วันที่: %{x}</b><br>น้ำหนักรวม: %{y:,.2f} ตัน<br>จำนวนรถ: %{customdata[0]:,} คัน<extra></extra>',
                    customdata: data.data.map(d => [parseInt(d.truck_count) || 0]),
                    text: weights.map(w => {
                        const safeWeight = isNaN(w) ? 0 : w;
                        return safeWeight.toLocaleString('th-TH', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    }),
                    textposition: 'outside',
                    textfont: { color: '#f8f9fa', size: 10 }
                },
                {
                    x: dates,
                    y: freshWeights,
                    type: 'bar',
                    name: 'อ้อยสด',
                    marker: {
                        color: 'rgba(34, 197, 94, 0.7)',
                        line: {
                            color: 'rgba(255,255,255,0.2)',
                            width: 1
                        }
                    },
                    hovertemplate: '<b>วันที่: %{x}</b><br>อ้อยสด: %{y:,.2f} ตัน<extra></extra>',
                    visible: 'legendonly'
                },
                {
                    x: dates,
                    y: burntWeights,
                    type: 'bar',
                    name: 'อ้อยไฟ',
                    marker: {
                        color: 'rgba(239, 68, 68, 0.7)',
                        line: {
                            color: 'rgba(255,255,255,0.2)',
                            width: 1
                        }
                    },
                    hovertemplate: '<b>วันที่: %{x}</b><br>อ้อยไฟ: %{y:,.2f} ตัน<extra></extra>',
                    visible: 'legendonly'
                }
            ];

            const layout = {
                ...commonLayoutOptions,
                title: {
                    text: `กราฟแท่งน้ำหนักอ้อยรายวัน (${data.date_range.start_date} ถึง ${data.date_range.end_date})`,
                    font: { size: 16, color: '#f8f9fa' },
                    x: 0.5,
                    y: 0.95
                },
                yaxis: { 
                    ...commonLayoutOptions.yaxis, 
                    title: { text: 'น้ำหนักอ้อย (ตัน)', font: { size: 12 } }
                },
                xaxis: { 
                    ...commonLayoutOptions.xaxis, 
                    type: 'category',
                    title: { text: 'วันที่', font: { size: 12 } }
                },
                barmode: 'group',
                showlegend: true,
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(0,0,0,0.3)',
                    bordercolor: 'rgba(255,255,255,0.2)',
                    borderwidth: 1,
                    font: { color: '#f8f9fa' }
                }
            };

            Plotly.react(elementId, traces, layout, chartConfig);
        }

        function renderDailyWeightComparisonChart(elementId, comparisonData) {
            const currentDates = comparisonData.current_period.map(d => d.date);
            const currentWeights = comparisonData.current_period.map(d => parseFloat(d.weight) || 0);
            const previousDates = comparisonData.previous_period.map(d => d.date);
            const previousWeights = comparisonData.previous_period.map(d => parseFloat(d.weight) || 0);

            const traces = [
                {
                    x: currentDates,
                    y: currentWeights,
                    type: 'bar',
                    name: 'ช่วงปัจจุบัน',
                    marker: {
                        color: 'rgba(59, 130, 246, 0.8)',
                        line: {
                            color: 'rgba(255,255,255,0.3)',
                            width: 1
                        }
                    },
                    hovertemplate: '<b>วันที่: %{x}</b><br>น้ำหนัก: %{y:,.2f} ตัน<br>จำนวนรถ: %{customdata[0]:,} คัน<extra></extra>',
                    customdata: comparisonData.current_period.map(d => [parseInt(d.truck_count) || 0]),
                    text: currentWeights.map(w => {
                        const safeWeight = isNaN(w) ? 0 : w;
                        return safeWeight.toLocaleString('th-TH', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    }),
                    textposition: 'outside',
                    textfont: { color: '#f8f9fa', size: 10 }
                },
                {
                    x: previousDates,
                    y: previousWeights,
                    type: 'bar',
                    name: 'ช่วงก่อนหน้า',
                    marker: {
                        color: 'rgba(156, 163, 175, 0.6)',
                        line: {
                            color: 'rgba(255,255,255,0.2)',
                            width: 1
                        }
                    },
                    hovertemplate: '<b>วันที่: %{x}</b><br>น้ำหนัก: %{y:,.2f} ตัน<br>จำนวนรถ: %{customdata[0]:,} คัน<extra></extra>',
                    customdata: comparisonData.previous_period.map(d => [parseInt(d.truck_count) || 0]),
                    text: previousWeights.map(w => {
                        const safeWeight = isNaN(w) ? 0 : w;
                        return safeWeight.toLocaleString('th-TH', {minimumFractionDigits: 0, maximumFractionDigits: 0});
                    }),
                    textposition: 'outside',
                    textfont: { color: '#f8f9fa', size: 10 }
                }
            ];

            const layout = {
                ...commonLayoutOptions,
                title: {
                    text: 'เปรียบเทียบน้ำหนักอ้อยรายวัน',
                    font: { size: 16, color: '#f8f9fa' },
                    x: 0.5,
                    y: 0.95
                },
                yaxis: { 
                    ...commonLayoutOptions.yaxis, 
                    title: { text: 'น้ำหนักอ้อย (ตัน)', font: { size: 12 } }
                },
                xaxis: { 
                    ...commonLayoutOptions.xaxis, 
                    type: 'category',
                    title: { text: 'วันที่', font: { size: 12 } }
                },
                barmode: 'group',
                showlegend: true,
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(0,0,0,0.3)',
                    bordercolor: 'rgba(255,255,255,0.2)',
                    borderwidth: 1,
                    font: { color: '#f8f9fa' }
                }
            };

            Plotly.react(elementId, traces, layout, chartConfig);
        }

        function updateDailyWeightSummary(summary) {
            document.getElementById('summary-days').textContent = summary.total_days;
            document.getElementById('summary-total').textContent = summary.total_weight.toLocaleString('th-TH', {minimumFractionDigits: 0, maximumFractionDigits: 0}) + ' ตัน';
            document.getElementById('summary-avg').textContent = summary.avg_daily_weight.toLocaleString('th-TH', {minimumFractionDigits: 1, maximumFractionDigits: 1}) + ' ตัน';
            document.getElementById('summary-max').textContent = summary.max_daily_weight.toLocaleString('th-TH', {minimumFractionDigits: 0, maximumFractionDigits: 0}) + ' ตัน';
            document.getElementById('daily-weight-summary').style.display = 'block';
        }

        function updateDailyWeightComparisonSummary(summary) {
            const changePercent = summary.weight_change_percent;
            const changeText = changePercent >= 0 ? `+${changePercent.toFixed(1)}%` : `${changePercent.toFixed(1)}%`;
            const changeColor = changePercent >= 0 ? 'text-success' : 'text-danger';
            
            document.getElementById('summary-days').textContent = '7 วัน';
            document.getElementById('summary-total').textContent = summary.current_total.toLocaleString('th-TH', {minimumFractionDigits: 0, maximumFractionDigits: 0}) + ' ตัน';
            document.getElementById('summary-avg').textContent = summary.current_avg.toLocaleString('th-TH', {minimumFractionDigits: 1, maximumFractionDigits: 1}) + ' ตัน';
            document.getElementById('summary-max').innerHTML = `<span class="${changeColor}">${changeText}</span>`;
            document.getElementById('daily-weight-summary').style.display = 'block';
        }

        // --- TABLE SORTING AND UTILITIES ---

        function sortTable(columnIndex) {
            if (!currentData || currentData.length === 0) {
                console.warn('No data to sort');
                return;
            }
            
            const key = ['Time', 'A_Count', 'A_Tons', 'B_Count', 'B_Tons', 'Total_Count', 'Total_Tons'][columnIndex];
            if (!key) {
                console.error('Invalid column index:', columnIndex);
                return;
            }
            
            const normalData = currentData.filter(row => !row.is_summary);
            const summaryRow = currentData.find(row => row.is_summary);

            if (columnIndex === sortColumnIndex) {
                isSortAscending = !isSortAscending;
            } else {
                sortColumnIndex = columnIndex;
                isSortAscending = true;
            }
            
            const sortDirection = isSortAscending ? 1 : -1;

            normalData.sort((a, b) => {
                let valA = a[key], valB = b[key];
                
                if (key === 'Time') {
                    const hourA = parseInt(valA.split(':')[0]);
                    const hourB = parseInt(valB.split(':')[0]);
                    // แก้ไขการเรียงลำดับเวลาให้เริ่มจาก 18:00
                    valA = (hourA - 18 + 24) % 24;
                    valB = (hourB - 18 + 24) % 24;
                    // เรียงจากน้อยไปมาก (18:00=0, 19:00=1, ..., 17:00=23)
                    if (valA < valB) return -1;
                    if (valA > valB) return 1;
                    return 0;
                } else {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                }

                if (valA < valB) return -sortDirection;
                if (valA > valB) return sortDirection;
                return 0;
            });

            currentData = [...normalData];
            if (summaryRow) {
                currentData.push(summaryRow);
            }

            renderTable();
            updateSortIndicators();
        }

        function updateSortIndicators() {
            const headers = document.querySelectorAll('.table-dark thead th');
            headers.forEach((th, index) => {
                const iconSpan = th.querySelector('.sort-icon');
                if (index === sortColumnIndex) {
                    th.classList.add(isSortAscending ? 'sort-asc' : 'sort-desc');
                    th.classList.remove(isSortAscending ? 'sort-desc' : 'sort-asc');
                    iconSpan.innerHTML = isSortAscending ? '<i class="bi bi-caret-up-fill"></i>' : '<i class="bi bi-caret-down-fill"></i>';
                } else {
                    th.classList.remove('sort-asc', 'sort-desc');
                    iconSpan.innerHTML = '';
                }
            });
        }

        function setupRefreshTimer() {
            clearInterval(refreshTimer);
            const interval = parseInt(refreshIntervalSelect.value);
            localStorage.setItem('refreshInterval', interval);
            if (interval > 0) {
                refreshTimer = setInterval(() => { if (!isUserInteracting) fetchData({ silent: true }); }, interval);
            }
        }

        function animateValue(id, end, duration, decimalPlaces = 0) {
            const obj = document.getElementById(id);
            if (!obj) {
                console.warn(`Element with ID '${id}' not found for animation`);
                return;
            }
            
            const startText = obj.textContent.replace(/,/g, '');
            const start = parseFloat(startText) || 0;
            const endValue = parseFloat(String(end).replace(/,/g, '')) || 0;
            if (start === endValue) return;

            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentValue = progress * (endValue - start) + start;
                obj.textContent = currentValue.toLocaleString('th-TH', { 
                    minimumFractionDigits: decimalPlaces, 
                    maximumFractionDigits: decimalPlaces 
                });
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        function flashElement(element) {
            if (element) {
                element.classList.add('flash-update');
                element.addEventListener('animationend', () => {
                    element.classList.remove('flash-update');
                }, { once: true });
            }
        }
        
        function updateAndFlash(elementId, value) {
            const el = document.getElementById(elementId);
            if (!el) {
                console.warn(`Element with ID '${elementId}' not found`);
                return;
            }
            
            if (el.textContent !== String(value)) {
                el.textContent = value;
                flashElement(el.closest('.stat-value') || el.closest('.stat-item') || el.closest('.analysis-text') || el);
            }
        }
        
        function goToToday() {
            const today = new Date().toISOString().split('T')[0];
            if (datePicker.value !== today) {
                datePicker.value = today;
                fetchData();
            }
        }

        function showError(message) { 
            const statusMessageEl = document.getElementById('status-message');
            if (statusMessageEl) {
                statusMessageEl.innerHTML = `<i class="bi bi-exclamation-triangle-fill text-danger"></i> ${message}`;
            }
        }
        
        function showNotification(message, type = 'info') { 
            console.log(`Notification [${type}]: ${message}`);
            // สามารถเพิ่ม toast notification ได้ที่นี่
        }
        function toggleFullscreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }

        // FAQ Modal Functions
        function showFAQModal(faqType, title) {
            const modal = new bootstrap.Modal(document.getElementById('faqModal'));
            document.getElementById('faq-title').textContent = title;
            
            const content = getFAQContent(faqType);
            document.getElementById('faq-content').innerHTML = content;
            
            modal.show();
        }

        function getFAQContent(faqType) {
            const faqData = {
                'truck-a-count': {
                    title: 'จำนวนรถราง A',
                    description: 'จำนวนรถบรรทุกอ้อยที่เข้าโรงงานผ่านราง A ในวันนี้ (นับตั้งแต่ 18:00 ของวันก่อนถึง 18:00 ของวันนี้)',
                    source: 'ข้อมูลมาจากระบบชั่งน้ำหนักอ้อยที่ราง A (Weighbridge System A)',
                    calculation: 'การนับรถราง A:\n1. ตรวจจับรถที่ขึ้นชั่งน้ำหนักที่ราง A\n2. บันทึกเวลาที่รถเข้าและออก\n3. นับจำนวนครั้งที่รถผ่านในแต่ละชั่วโมง\n4. รวมจำนวนรถทั้งหมดในวันนั้น\n\nสูตร: จำนวนรถราง A = Σ(จำนวนรถในชั่วโมงที่ 1 ถึง 24)',
                    ai_analysis: 'LOGIC PROGRAMMING - ใช้ Real-time Counting Algorithm ไม่ใช้ AI',
                    accuracy: 'ความแม่นยำ 99.9%',
                    unit: 'คัน (Trucks)',
                    note: 'ราง A ตั้งอยู่ทางทิศเหนือของโรงงาน มักมีปริมาณการใช้งานมากกว่าราง B เนื่องจากอยู่ใกล้พื้นที่ปลูกอ้อยหลัก'
                },
                'truck-b-count': {
                    title: 'จำนวนรถราง B',
                    description: 'จำนวนรถบรรทุกอ้อยที่เข้าโรงงานผ่านราง B ในวันนี้ (นับตั้งแต่ 18:00 ของวันก่อนถึง 18:00 ของวันนี้)',
                    source: 'ข้อมูลมาจากระบบชั่งน้ำหนักอ้อยที่ราง B (Weighbridge System B)',
                    calculation: 'การนับรถราง B:\n1. ตรวจจับรถที่ขึ้นชั่งน้ำหนักที่ราง B\n2. บันทึกเวลาที่รถเข้าและออก\n3. นับจำนวนครั้งที่รถผ่านในแต่ละชั่วโมง\n4. รวมจำนวนรถทั้งหมดในวันนั้น\n\nสูตร: จำนวนรถราง B = Σ(จำนวนรถในชั่วโมงที่ 1 ถึง 24)',
                    ai_analysis: 'LOGIC PROGRAMMING - ใช้ Real-time Counting Algorithm ไม่ใช้ AI',
                    accuracy: 'ความแม่นยำ 99.9%',
                    unit: 'คัน (Trucks)',
                    note: 'ราง B ตั้งอยู่ทางทิศใต้ของโรงงาน มักมีปริมาณการใช้งานน้อยกว่าราง A เนื่องจากอยู่ไกลจากพื้นที่ปลูกอ้อยหลัก'
                },
                'tons-a': {
                    title: 'ปริมาณอ้อยราง A',
                    description: 'ปริมาณอ้อยสุทธิที่ชั่งผ่านราง A ในวันนี้ (หน่วยเป็นตัน) - น้ำหนักอ้อยจริงหลังจากหักน้ำหนักรถแล้ว',
                    source: 'ข้อมูลมาจากระบบชั่งน้ำหนักอ้อยที่ราง A (Weighbridge System A)',
                    calculation: 'การคำนวณน้ำหนักอ้อยสุทธิราง A:\n1. ชั่งน้ำหนักรถบรรทุกอ้อย (Gross Weight)\n2. ชั่งน้ำหนักรถเปล่า (Tare Weight)\n3. คำนวณน้ำหนักอ้อยสุทธิ (Net Weight)\n4. รวมน้ำหนักอ้อยสุทธิทั้งหมดในวันนั้น\n\nสูตร: wgt_net = wgt_gross - wgt_tare\nปริมาณอ้อยราง A = Σ(wgt_net ของทุกคันที่ผ่านราง A)',
                    ai_analysis: 'LOGIC PROGRAMMING - ใช้ Real-time Weight Calculation Algorithm ไม่ใช้ AI',
                    accuracy: 'ความแม่นยำ ±0.1%, ระบบตรวจสอบหลายชั้น',
                    unit: 'ตัน (Tons)',
                    note: 'น้ำหนักที่แสดงเป็นน้ำหนักสุทธิ (หักน้ำหนักรถแล้ว) ตามมาตรฐานอุตสาหกรรมน้ำตาล'
                },
                'tons-b': {
                    title: 'ปริมาณอ้อยราง B',
                    description: 'ปริมาณอ้อยสุทธิที่ชั่งผ่านราง B ในวันนี้ (หน่วยเป็นตัน) - น้ำหนักอ้อยจริงหลังจากหักน้ำหนักรถแล้ว',
                    source: 'ข้อมูลมาจากระบบชั่งน้ำหนักอ้อยที่ราง B (Weighbridge System B)',
                    calculation: 'การคำนวณน้ำหนักอ้อยสุทธิราง B:\n1. ชั่งน้ำหนักรถบรรทุกอ้อย (Gross Weight)\n2. ชั่งน้ำหนักรถเปล่า (Tare Weight)\n3. คำนวณน้ำหนักอ้อยสุทธิ (Net Weight)\n4. รวมน้ำหนักอ้อยสุทธิทั้งหมดในวันนั้น\n\nสูตร: wgt_net = wgt_gross - wgt_tare\nปริมาณอ้อยราง B = Σ(wgt_net ของทุกคันที่ผ่านราง B)',
                    ai_analysis: 'LOGIC PROGRAMMING - ใช้ Real-time Weight Calculation Algorithm ไม่ใช้ AI',
                    accuracy: 'ความแม่นยำ ±0.1%, ระบบตรวจสอบหลายชั้น',
                    unit: 'ตัน (Tons)',
                    note: 'น้ำหนักที่แสดงเป็นน้ำหนักสุทธิ (หักน้ำหนักรถแล้ว) ตามมาตรฐานอุตสาหกรรมน้ำตาล'
                },
                'fresh-cane': {
                    title: 'อ้อยสด',
                    description: 'ปริมาณอ้อยสดที่เข้าโรงงานในวันนี้ (อ้อยที่ตัดสดจากไร่ - cane_type = "1")',
                    source: 'ข้อมูลมาจากการบันทึกประเภทอ้อยในระบบชั่งน้ำหนัก (cane_type field)',
                    calculation: 'การคำนวณอ้อยสด:\n1. ตรวจสอบประเภทอ้อย (cane_type = "1")\n2. กรองข้อมูลที่ผ่านการตรวจสอบ (PRINT_W = "y")\n3. กรองน้ำหนักที่มากกว่า 0 (WGT_NET > 0)\n4. กรองข้อมูลที่ไม่ใช่ข้อมูลทดสอบ (NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))\n5. รวมน้ำหนักอ้อยสุทธิของทุกคันที่มีประเภทเป็น "อ้อยสด"\n6. คำนวณสัดส่วนอ้อยสดต่ออ้อยทั้งหมด\n\nสูตร: อ้อยสดรวม = Σ(wgt_net WHERE cane_type = "1" AND PRINT_W = "y" AND WGT_NET > 0 AND NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))\nสัดส่วนอ้อยสด = (อ้อยสดรวม / อ้อยทั้งหมด) × 100',
                    ai_analysis: 'LOGIC PROGRAMMING - ใช้ SQL Aggregation Functions ไม่ใช้ AI',
                    accuracy: 'ความแม่นยำ 95-98% ขึ้นอยู่กับการบันทึกประเภทอ้อยที่ถูกต้องจากพนักงาน',
                    unit: 'ตัน (Tons) และเปอร์เซ็นต์ (%)',
                    note: 'อ้อยสดมีคุณภาพดีกว่าอ้อยไฟ (น้ำตาล 12-14%) แต่มีอายุการเก็บสั้นกว่า (24-48 ชั่วโมง)'
                },
                'burnt-cane': {
                    title: 'อ้อยไฟ',
                    description: 'ปริมาณอ้อยไฟที่เข้าโรงงานในวันนี้ (อ้อยที่เผาก่อนตัด - cane_type = "2")',
                    source: 'ข้อมูลมาจากการบันทึกประเภทอ้อยในระบบชั่งน้ำหนัก (cane_type field)',
                    calculation: 'การคำนวณอ้อยไฟ:\n1. ตรวจสอบประเภทอ้อย (cane_type = "2")\n2. กรองข้อมูลที่ผ่านการตรวจสอบ (PRINT_W = "y")\n3. กรองน้ำหนักที่มากกว่า 0 (WGT_NET > 0)\n4. กรองข้อมูลที่ไม่ใช่ข้อมูลทดสอบ (NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))\n5. รวมน้ำหนักอ้อยสุทธิของทุกคันที่มีประเภทเป็น "อ้อยไฟ"\n6. คำนวณสัดส่วนอ้อยไฟต่ออ้อยทั้งหมด\n\nสูตร: อ้อยไฟรวม = Σ(wgt_net WHERE cane_type = "2" AND PRINT_W = "y" AND WGT_NET > 0 AND NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))\nสัดส่วนอ้อยไฟ = (อ้อยไฟรวม / อ้อยทั้งหมด) × 100',
                    ai_analysis: 'LOGIC PROGRAMMING - ใช้ SQL Aggregation Functions ไม่ใช้ AI',
                    accuracy: 'ความแม่นยำ 95-98% ขึ้นอยู่กับการบันทึกประเภทอ้อยที่ถูกต้องจากพนักงาน',
                    unit: 'ตัน (Tons) และเปอร์เซ็นต์ (%)',
                    note: 'อ้อยไฟมีอายุการเก็บนานกว่า (72-120 ชั่วโมง) แต่คุณภาพน้ำตาลต่ำกว่า (8-10%) เนื่องจากความร้อนทำลายน้ำตาลบางส่วน'
                },
                'total-today': {
                    title: 'ยอดรวมวันนี้',
                    description: 'ปริมาณอ้อยรวมทั้งหมดที่เข้าโรงงานในวันนี้ (รวมจากราง A และราง B)',
                    source: 'ข้อมูลมาจากการรวมปริมาณอ้อยจากราง A และราง B ในระบบชั่งน้ำหนัก',
                    calculation: 'การคำนวณยอดรวมวันนี้:\n1. รวมน้ำหนักอ้อยสุทธิจากราง A (Prod_line = "A")\n2. รวมน้ำหนักอ้อยสุทธิจากราง B (Prod_line = "B")\n3. รวมน้ำหนักทั้งหมดในวันนั้น\n4. คำนวณเฉลี่ยต่อชั่วโมง\n\nสูตร: ยอดรวมวันนี้ = Σ(wgt_net WHERE Prod_line = "A") + Σ(wgt_net WHERE Prod_line = "B")\nเฉลี่ยต่อชั่วโมง = ยอดรวมวันนี้ / 24',
                    ai_analysis: 'LOGIC PROGRAMMING - ใช้ SQL Aggregation Functions ไม่ใช้ AI',
                    accuracy: 'ความแม่นยำ 99.9% เนื่องจากมาจากระบบชั่งน้ำหนักโดยตรง',
                    unit: 'ตัน (Tons)',
                    note: 'ยอดรวมนี้ใช้สำหรับประเมินประสิทธิภาพการทำงานของโรงงานและเปรียบเทียบกับเป้าหมายที่กำหนด'
                },
                'truck-count-today': {
                    title: 'จำนวนรถวันนี้',
                    description: 'จำนวนรถบรรทุกอ้อยที่เข้าโรงงานทั้งหมดในวันนี้ (รวมจากราง A และราง B)',
                    source: 'ข้อมูลมาจากการนับจำนวนรถที่ผ่านราง A และราง B ในระบบชั่งน้ำหนัก',
                    calculation: 'การนับจำนวนรถวันนี้:\n1. นับจำนวนรถที่ผ่านราง A (Prod_line = "A")\n2. นับจำนวนรถที่ผ่านราง B (Prod_line = "B")\n3. รวมจำนวนรถทั้งหมดในวันนั้น\n4. คำนวณเฉลี่ยต่อชั่วโมง\n\nสูตร: จำนวนรถวันนี้ = COUNT(WHERE Prod_line = "A") + COUNT(WHERE Prod_line = "B")\nเฉลี่ยต่อชั่วโมง = จำนวนรถวันนี้ / 24',
                    ai_analysis: 'LOGIC PROGRAMMING - ใช้ Real-time Counting Algorithm ไม่ใช้ AI',
                    accuracy: 'ความแม่นยำ 99.9% เนื่องจากนับจากระบบอัตโนมัติ',
                    unit: 'คัน (Trucks)',
                    note: 'จำนวนรถสะท้อนถึงความเข้มข้นของการขนส่งอ้อยและประสิทธิภาพการจัดการโลจิสติกส์'
                },
                'fresh-today': {
                    title: 'อ้อยสดวันนี้',
                    description: 'ปริมาณอ้อยสดที่เข้าโรงงานในวันนี้ (รวมจากราง A และราง B)',
                    source: 'ข้อมูลมาจากการบันทึกประเภทอ้อยในระบบชั่งน้ำหนัก (cane_type = "1")',
                    calculation: 'การคำนวณอ้อยสดวันนี้:\n1. กรองข้อมูลที่ผ่านการตรวจสอบ (PRINT_W = "y")\n2. กรองน้ำหนักที่มากกว่า 0 (WGT_NET > 0)\n3. กรองข้อมูลที่ไม่ใช่ข้อมูลทดสอบ (NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))\n4. รวมน้ำหนักอ้อยสดจากราง A (WHERE cane_type = "1" AND Prod_line = "A")\n5. รวมน้ำหนักอ้อยสดจากราง B (WHERE cane_type = "1" AND Prod_line = "B")\n6. รวมน้ำหนักอ้อยสดทั้งหมดในวันนั้น\n7. คำนวณสัดส่วนอ้อยสดต่ออ้อยทั้งหมด\n\nสูตร: อ้อยสดวันนี้ = Σ(wgt_net WHERE cane_type = "1" AND PRINT_W = "y" AND WGT_NET > 0 AND NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))\nสัดส่วนอ้อยสด = (อ้อยสดวันนี้ / อ้อยทั้งหมด) × 100',
                    ai_analysis: 'LOGIC PROGRAMMING - ใช้ SQL Aggregation Functions ไม่ใช้ AI',
                    accuracy: 'ความแม่นยำ 95-98% ขึ้นอยู่กับการบันทึกประเภทอ้อยที่ถูกต้องจากพนักงาน',
                    unit: 'ตัน (Tons) และเปอร์เซ็นต์ (%)',
                    note: 'อ้อยสดมีน้ำตาลสูงกว่าอ้อยไฟ (12-14% vs 8-10%) และมีคุณภาพดีกว่า แต่มีอายุการเก็บสั้นกว่า'
                },
                'burnt-today': {
                    title: 'อ้อยไฟวันนี้',
                    description: 'ปริมาณอ้อยไฟที่เข้าโรงงานในวันนี้ (รวมจากราง A และราง B)',
                    source: 'ข้อมูลมาจากการบันทึกประเภทอ้อยในระบบชั่งน้ำหนัก (cane_type = "2")',
                    calculation: 'การคำนวณอ้อยไฟวันนี้:\n1. กรองข้อมูลที่ผ่านการตรวจสอบ (PRINT_W = "y")\n2. กรองน้ำหนักที่มากกว่า 0 (WGT_NET > 0)\n3. กรองข้อมูลที่ไม่ใช่ข้อมูลทดสอบ (NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))\n4. รวมน้ำหนักอ้อยไฟจากราง A (WHERE cane_type = "2" AND Prod_line = "A")\n5. รวมน้ำหนักอ้อยไฟจากราง B (WHERE cane_type = "2" AND Prod_line = "B")\n6. รวมน้ำหนักอ้อยไฟทั้งหมดในวันนั้น\n7. คำนวณสัดส่วนอ้อยไฟต่ออ้อยทั้งหมด\n\nสูตร: อ้อยไฟวันนี้ = Σ(wgt_net WHERE cane_type = "2" AND PRINT_W = "y" AND WGT_NET > 0 AND NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))\nสัดส่วนอ้อยไฟ = (อ้อยไฟวันนี้ / อ้อยทั้งหมด) × 100',
                    ai_analysis: 'LOGIC PROGRAMMING - ใช้ SQL Aggregation Functions ไม่ใช้ AI',
                    accuracy: 'ความแม่นยำ 95-98% ขึ้นอยู่กับการบันทึกประเภทอ้อยที่ถูกต้องจากพนักงาน',
                    unit: 'ตัน (Tons) และเปอร์เซ็นต์ (%)',
                    note: 'อ้อยไฟมีอายุการเก็บนานกว่าอ้อยสด (72-120 ชม. vs 24-48 ชม.) แต่คุณภาพน้ำตาลต่ำกว่า'
                },
                'total-all-time': {
                    title: 'ยอดสะสมทั้งหมด',
                    description: 'ปริมาณอ้อยรวมทั้งหมดที่เข้าโรงงานตั้งแต่เริ่มฤดูกาลหีบอ้อย',
                    source: 'ข้อมูลมาจากการรวมปริมาณอ้อยทั้งหมดจากฐานข้อมูลตั้งแต่เริ่มฤดูกาล',
                    calculation: 'รวมน้ำหนักอ้อยสุทธิทั้งหมดจากราง A และราง B ตั้งแต่เริ่มฤดูกาล',
                    ai_analysis: 'ระบบ AI วิเคราะห์แนวโน้มการผลิตและคาดการณ์ผลผลิตทั้งฤดูกาล',
                    accuracy: 'ข้อมูลมีความแม่นยำสูง เนื่องจากมาจากระบบชั่งน้ำหนักโดยตรง',
                    unit: 'ตัน',
                    note: 'ใช้สำหรับประเมินประสิทธิภาพการผลิตทั้งฤดูกาล'
                },
                'tons-a-all-time': {
                    title: 'ปริมาณอ้อยราง A สะสม',
                    description: 'ปริมาณอ้อยที่ชั่งผ่านราง A ตั้งแต่เริ่มฤดูกาลหีบอ้อย',
                    source: 'ข้อมูลมาจากระบบชั่งน้ำหนักอ้อยที่ราง A ตั้งแต่เริ่มฤดูกาล',
                    calculation: 'รวมน้ำหนักอ้อยสุทธิจากราง A ตั้งแต่เริ่มฤดูกาล',
                    ai_analysis: 'ระบบ AI วิเคราะห์ประสิทธิภาพการทำงานของราง A และคาดการณ์ความต้องการ',
                    accuracy: 'ข้อมูลมีความแม่นยำ ±0.1% ตามมาตรฐานระบบชั่งน้ำหนัก',
                    unit: 'ตัน',
                    note: 'ราง A มักมีปริมาณมากกว่าราง B เนื่องจากอยู่ใกล้พื้นที่ปลูกอ้อย'
                },
                'tons-b-all-time': {
                    title: 'ปริมาณอ้อยราง B สะสม',
                    description: 'ปริมาณอ้อยที่ชั่งผ่านราง B ตั้งแต่เริ่มฤดูกาลหีบอ้อย',
                    source: 'ข้อมูลมาจากระบบชั่งน้ำหนักอ้อยที่ราง B ตั้งแต่เริ่มฤดูกาล',
                    calculation: 'รวมน้ำหนักอ้อยสุทธิจากราง B ตั้งแต่เริ่มฤดูกาล',
                    ai_analysis: 'ระบบ AI วิเคราะห์ประสิทธิภาพการทำงานของราง B และคาดการณ์ความต้องการ',
                    accuracy: 'ข้อมูลมีความแม่นยำ ±0.1% ตามมาตรฐานระบบชั่งน้ำหนัก',
                    unit: 'ตัน',
                    note: 'ราง B มักมีปริมาณน้อยกว่าราง A เนื่องจากอยู่ไกลจากพื้นที่ปลูกอ้อย'
                },
                'trucks-a-all-time': {
                    title: 'จำนวนรถราง A สะสม',
                    description: 'จำนวนรถบรรทุกอ้อยที่ผ่านราง A ตั้งแต่เริ่มฤดูกาลหีบอ้อย',
                    source: 'ข้อมูลมาจากการนับจำนวนรถที่ผ่านราง A ตั้งแต่เริ่มฤดูกาล',
                    calculation: 'รวมจำนวนรถจากราง A ตั้งแต่เริ่มฤดูกาล',
                    ai_analysis: 'ระบบ AI วิเคราะห์รูปแบบการขนส่งและคาดการณ์ความต้องการรถ',
                    accuracy: 'ข้อมูลมีความแม่นยำสูง เนื่องจากนับจากระบบอัตโนมัติ',
                    unit: 'คัน',
                    note: 'จำนวนรถสะท้อนถึงความเข้มข้นของการขนส่งอ้อยในพื้นที่ใกล้เคียง'
                },
                'trucks-b-all-time': {
                    title: 'จำนวนรถราง B สะสม',
                    description: 'จำนวนรถบรรทุกอ้อยที่ผ่านราง B ตั้งแต่เริ่มฤดูกาลหีบอ้อย',
                    source: 'ข้อมูลมาจากการนับจำนวนรถที่ผ่านราง B ตั้งแต่เริ่มฤดูกาล',
                    calculation: 'รวมจำนวนรถจากราง B ตั้งแต่เริ่มฤดูกาล',
                    ai_analysis: 'ระบบ AI วิเคราะห์รูปแบบการขนส่งและคาดการณ์ความต้องการรถ',
                    accuracy: 'ข้อมูลมีความแม่นยำสูง เนื่องจากนับจากระบบอัตโนมัติ',
                    unit: 'คัน',
                    note: 'จำนวนรถสะท้อนถึงความเข้มข้นของการขนส่งอ้อยในพื้นที่ห่างไกล'
                },
                'fresh-all-time': {
                    title: 'อ้อยสดสะสม',
                    description: 'ปริมาณอ้อยสดที่เข้าโรงงานตั้งแต่เริ่มฤดูกาลหีบอ้อย',
                    source: 'ข้อมูลมาจากการบันทึกประเภทอ้อยในระบบชั่งน้ำหนักตั้งแต่เริ่มฤดูกาล',
                    calculation: 'การคำนวณอ้อยสดสะสม:\n1. กรองข้อมูลที่ผ่านการตรวจสอบ (PRINT_W = "y")\n2. กรองน้ำหนักที่มากกว่า 0 (WGT_NET > 0)\n3. กรองข้อมูลที่ไม่ใช่ข้อมูลทดสอบ (NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))\n4. รวมน้ำหนักอ้อยสดจากราง A และราง B ตั้งแต่เริ่มฤดูกาล\n\nสูตร: อ้อยสดสะสม = Σ(wgt_net WHERE cane_type = "1" AND PRINT_W = "y" AND WGT_NET > 0 AND NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))',
                    ai_analysis: 'ระบบ AI วิเคราะห์คุณภาพอ้อยและคาดการณ์ผลผลิตน้ำตาลทั้งฤดูกาล',
                    accuracy: 'ข้อมูลขึ้นอยู่กับการบันทึกประเภทอ้อยที่ถูกต้อง',
                    unit: 'ตัน',
                    note: 'อ้อยสดมีคุณภาพดีกว่าอ้อยไฟ แต่มีอายุการเก็บสั้นกว่า'
                },
                'burnt-all-time': {
                    title: 'อ้อยไฟสะสม',
                    description: 'ปริมาณอ้อยไฟที่เข้าโรงงานตั้งแต่เริ่มฤดูกาลหีบอ้อย',
                    source: 'ข้อมูลมาจากการบันทึกประเภทอ้อยในระบบชั่งน้ำหนักตั้งแต่เริ่มฤดูกาล',
                    calculation: 'การคำนวณอ้อยไฟสะสม:\n1. กรองข้อมูลที่ผ่านการตรวจสอบ (PRINT_W = "y")\n2. กรองน้ำหนักที่มากกว่า 0 (WGT_NET > 0)\n3. กรองข้อมูลที่ไม่ใช่ข้อมูลทดสอบ (NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))\n4. รวมน้ำหนักอ้อยไฟจากราง A และราง B ตั้งแต่เริ่มฤดูกาล\n\nสูตร: อ้อยไฟสะสม = Σ(wgt_net WHERE cane_type = "2" AND PRINT_W = "y" AND WGT_NET > 0 AND NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))',
                    ai_analysis: 'ระบบ AI วิเคราะห์ผลกระทบต่อคุณภาพและประสิทธิภาพการผลิตทั้งฤดูกาล',
                    accuracy: 'ข้อมูลขึ้นอยู่กับการบันทึกประเภทอ้อยที่ถูกต้อง',
                    unit: 'ตัน',
                    note: 'อ้อยไฟมีอายุการเก็บนานกว่าแต่คุณภาพน้ำตาลต่ำกว่า'
                },
                'hourly-data': {
                    title: 'ข้อมูลรายชั่วโมง',
                    description: 'ข้อมูลปริมาณอ้อยและจำนวนรถที่เข้าโรงงานในแต่ละชั่วโมงของวัน',
                    source: 'ข้อมูลมาจากระบบชั่งน้ำหนักอ้อย (Weighbridge System) ที่ราง A และราง B',
                    calculation: 'แบ่งข้อมูลตามช่วงเวลา 1 ชั่วโมง เริ่มจาก 18:00 น. ของวันก่อนหน้า ถึง 17:59 น. ของวันปัจจุบัน',
                    ai_analysis: 'ระบบ AI วิเคราะห์รูปแบบการทำงานในแต่ละชั่วโมง และคาดการณ์ปริมาณในชั่วโมงถัดไป',
                    accuracy: 'ข้อมูลมีความแม่นยำสูง เนื่องจากมาจากระบบชั่งน้ำหนักโดยตรง และมีการตรวจสอบความถูกต้อง',
                    unit: 'ตัน (ปริมาณ) / คัน (จำนวนรถ)',
                    note: 'ข้อมูลรายชั่วโมงช่วยในการวางแผนการทำงานและประเมินประสิทธิภาพการผลิต'
                },
                'ai-analysis': {
                    title: 'การวิเคราะห์ด้วย AI',
                    description: 'ระบบปัญญาประดิษฐ์ที่วิเคราะห์ข้อมูลการผลิตอ้อยและให้ข้อเสนอแนะ',
                    source: 'ข้อมูลมาจากการวิเคราะห์ข้อมูลการผลิตอ้อยในอดีตและข้อมูลปัจจุบัน',
                    calculation: 'ใช้ Machine Learning algorithms ในการวิเคราะห์รูปแบบ การคาดการณ์ และการให้คะแนนประสิทธิภาพ',
                    ai_analysis: 'AI - ระบบใช้ Machine Learning algorithms เช่น Time Series Analysis, Pattern Recognition, และ Predictive Modeling',
                    accuracy: 'ความแม่นยำขึ้นอยู่กับคุณภาพและปริมาณข้อมูลที่ใช้ในการฝึกฝน AI model',
                    unit: 'คะแนน (0-10) และเปอร์เซ็นต์ (%)',
                    note: 'ระบบ AI จะเรียนรู้และปรับปรุงความแม่นยำตามข้อมูลที่เพิ่มขึ้น'
                },
                'chart-hourly-tons': {
                    title: 'กราฟปริมาณอ้อยรายชั่วโมง',
                    description: 'กราฟแสดงปริมาณอ้อยที่เข้าโรงงานในแต่ละชั่วโมงของวัน',
                    source: 'ข้อมูลมาจากระบบชั่งน้ำหนักอ้อย (Weighbridge System) ที่ราง A และราง B',
                    calculation: 'แสดงปริมาณอ้อยสุทธิจากราง A และราง B ในแต่ละชั่วโมง',
                    ai_analysis: 'ระบบ AI วิเคราะห์รูปแบบการทำงานในแต่ละชั่วโมง และคาดการณ์ปริมาณในชั่วโมงถัดไป',
                    accuracy: 'ข้อมูลมีความแม่นยำสูง เนื่องจากมาจากระบบชั่งน้ำหนักโดยตรง',
                    unit: 'ตัน',
                    note: 'กราฟนี้ช่วยในการวางแผนการทำงานและประเมินประสิทธิภาพการผลิต'
                },
                'chart-hourly-counts': {
                    title: 'กราฟจำนวนรถรายชั่วโมง',
                    description: 'กราฟแสดงจำนวนรถบรรทุกอ้อยที่เข้าโรงงานในแต่ละชั่วโมงของวัน',
                    source: 'ข้อมูลมาจากการนับจำนวนรถที่ผ่านราง A และราง B',
                    calculation: 'แสดงจำนวนรถจากราง A และราง B ในแต่ละชั่วโมง',
                    ai_analysis: 'ระบบ AI วิเคราะห์รูปแบบการขนส่งและคาดการณ์ความต้องการรถ',
                    accuracy: 'ข้อมูลมีความแม่นยำสูง เนื่องจากนับจากระบบอัตโนมัติ',
                    unit: 'คัน',
                    note: 'กราฟนี้ช่วยในการวางแผนการขนส่งและประเมินความเข้มข้นของการขนส่ง'
                },
                'chart-cumulative-types': {
                    title: 'กราฟปริมาณอ้อยสะสมตามประเภท',
                    description: 'กราฟแสดงปริมาณอ้อยสะสมตามประเภท (อ้อยสด/อ้อยไฟ) ในแต่ละชั่วโมง',
                    source: 'ข้อมูลมาจากการบันทึกประเภทอ้อยในระบบชั่งน้ำหนัก',
                    calculation: 'แสดงปริมาณอ้อยสะสมตามประเภทในแต่ละชั่วโมง',
                    ai_analysis: 'ระบบ AI วิเคราะห์สัดส่วนอ้อยสดต่ออ้อยไฟ และคาดการณ์คุณภาพน้ำตาล',
                    accuracy: 'ข้อมูลขึ้นอยู่กับการบันทึกประเภทอ้อยที่ถูกต้องจากพนักงาน',
                    unit: 'ตัน',
                    note: 'กราฟนี้ช่วยในการประเมินคุณภาพอ้อยและวางแผนการผลิต'
                },
                'chart-cumulative-lines': {
                    title: 'กราฟปริมาณอ้อยสะสมตามราง',
                    description: 'กราฟแสดงปริมาณอ้อยสะสมตามราง (ราง A/ราง B) ในแต่ละชั่วโมง',
                    source: 'ข้อมูลมาจากระบบชั่งน้ำหนักอ้อยที่ราง A และราง B',
                    calculation: 'แสดงปริมาณอ้อยสะสมจากราง A และราง B ในแต่ละชั่วโมง',
                    ai_analysis: 'ระบบ AI วิเคราะห์ประสิทธิภาพการทำงานของแต่ละราง และคาดการณ์ความต้องการ',
                    accuracy: 'ข้อมูลมีความแม่นยำ ±0.1% ตามมาตรฐานระบบชั่งน้ำหนัก',
                    unit: 'ตัน',
                    note: 'กราฟนี้ช่วยในการประเมินประสิทธิภาพการทำงานของแต่ละราง'
                },
                'historical-data': {
                    title: 'ข้อมูลย้อนหลัง',
                    description: 'ข้อมูลการผลิตอ้อยในอดีตที่ใช้สำหรับการวิเคราะห์แนวโน้มและเปรียบเทียบ',
                    source: 'ข้อมูลมาจากระบบชั่งน้ำหนักอ้อย (Weighbridge System) ที่เก็บไว้ในฐานข้อมูล',
                    calculation: 'ดึงข้อมูลจากฐานข้อมูลตามช่วงวันที่ที่เลือก และแสดงในรูปแบบกราฟหรือตาราง',
                    ai_analysis: 'ระบบ AI วิเคราะห์แนวโน้มการผลิตในอดีต และใช้เป็นพื้นฐานในการคาดการณ์อนาคต',
                    accuracy: 'ข้อมูลมีความแม่นยำสูง เนื่องจากมาจากระบบชั่งน้ำหนักโดยตรง และมีการเก็บรักษาที่ดี',
                    unit: 'ตัน (ปริมาณ) / คัน (จำนวนรถ)',
                    note: 'ข้อมูลย้อนหลังช่วยในการวางแผนการผลิตและประเมินประสิทธิภาพการทำงาน'
                },
                'monthly-data': {
                    title: 'สรุปยอดอ้อยรายเดือน',
                    description: 'ข้อมูลสรุปปริมาณอ้อยที่เข้าโรงงานในแต่ละเดือนตลอดฤดูกาลหีบอ้อย',
                    source: 'ข้อมูลมาจากการรวมปริมาณอ้อยจากระบบชั่งน้ำหนักอ้อยในแต่ละเดือน',
                    calculation: 'รวมปริมาณอ้อยสุทธิจากราง A และราง B ในแต่ละเดือน',
                    ai_analysis: 'ระบบ AI วิเคราะห์แนวโน้มการผลิตรายเดือน และคาดการณ์ผลผลิตในเดือนถัดไป',
                    accuracy: 'ข้อมูลมีความแม่นยำสูง เนื่องจากมาจากระบบชั่งน้ำหนักโดยตรง',
                    unit: 'ตัน',
                    note: 'ข้อมูลรายเดือนช่วยในการวางแผนการผลิตและประเมินประสิทธิภาพการทำงานทั้งฤดูกาล'
                },
                'key-metrics': {
                    title: 'ข้อมูลชี้วัดสำคัญ',
                    description: 'ข้อมูลชี้วัดหลักที่ใช้ในการประเมินประสิทธิภาพการทำงานของโรงงาน',
                    source: 'ข้อมูลมาจากการวิเคราะห์ข้อมูลการผลิตอ้อยในปัจจุบันและอดีต',
                    calculation: 'คำนวณจากข้อมูลปริมาณอ้อยล่าสุด ชั่วโมงเร่งด่วน และการคาดการณ์ยอดสิ้นวัน',
                    ai_analysis: 'ระบบ AI วิเคราะห์รูปแบบการทำงานและคาดการณ์ประสิทธิภาพการผลิต',
                    accuracy: 'ความแม่นยำขึ้นอยู่กับคุณภาพข้อมูลและความถูกต้องของการวิเคราะห์ AI',
                    unit: 'ตัน และ ชั่วโมง',
                    note: 'ข้อมูลชี้วัดเหล่านี้ใช้ในการตัดสินใจเชิงกลยุทธ์และการวางแผนการผลิต'
                },
                'efficiency-score': {
                    title: 'คะแนนประสิทธิภาพ',
                    description: 'คะแนนที่แสดงประสิทธิภาพการทำงานของโรงงานในวันนั้น (0-10 คะแนน)',
                    source: 'ข้อมูลมาจากการวิเคราะห์ประสิทธิภาพหลายด้านของโรงงาน',
                    calculation: 'คำนวณจากปัจจัยต่างๆ เช่น ปริมาณการผลิต ความเสถียร คุณภาพ และประสิทธิภาพต่อชั่วโมง\n\nสูตร: คะแนนรวม = (คะแนนปริมาณ × 0.3) + (คะแนนคุณภาพ × 0.25) + (คะแนนความเสถียร × 0.25) + (คะแนนประสิทธิภาพต่อชั่วโมง × 0.2)',
                    ai_analysis: 'AI - ระบบใช้ Machine Learning algorithms ในการประเมินและให้คะแนนประสิทธิภาพ',
                    accuracy: 'ความแม่นยำขึ้นอยู่กับคุณภาพข้อมูลและความถูกต้องของ AI model',
                    unit: 'คะแนน (0-10)',
                    note: 'คะแนนสูงแสดงถึงประสิทธิภาพการทำงานที่ดี'
                },
                'analysis-findings': {
                    title: 'การวิเคราะห์และข้อค้นพบ',
                    description: 'ผลการวิเคราะห์ข้อมูลการผลิตอ้อยและข้อค้นพบที่สำคัญ',
                    source: 'ข้อมูลมาจากการวิเคราะห์ข้อมูลการผลิตอ้อยในปัจจุบันและเปรียบเทียบกับข้อมูลย้อนหลัง',
                    calculation: 'ใช้เทคนิคการวิเคราะห์หลายแบบ เช่น Statistical Analysis, Comparative Analysis, Trend Analysis, และ Pattern Recognition',
                    ai_analysis: 'AI - ระบบใช้เทคนิคต่างๆ เช่น Pattern Recognition, Trend Analysis, และ Anomaly Detection',
                    accuracy: 'ความแม่นยำขึ้นอยู่กับคุณภาพและความสมบูรณ์ของข้อมูล',
                    unit: 'ข้อความวิเคราะห์, เปอร์เซ็นต์, และค่าสถิติ',
                    note: 'ข้อค้นพบเหล่านี้ใช้ในการปรับปรุงประสิทธิภาพการทำงาน'
                },
                'efficiency-metrics': {
                    title: 'ประสิทธิภาพรายด้าน',
                    description: 'คะแนนประสิทธิภาพแยกตามด้านต่างๆ ของการทำงานโรงงาน',
                    source: 'ข้อมูลมาจากการวิเคราะห์ประสิทธิภาพแยกตามด้านต่างๆ',
                    calculation: 'คำนวณประสิทธิภาพแยกตามด้าน: ปริมาณ (30%), คุณภาพ (25%), ความเสถียร (25%), และประสิทธิภาพต่อชั่วโมง (20%)',
                    ai_analysis: 'AI - ระบบใช้ Machine Learning algorithms ในการประเมินแต่ละด้าน',
                    accuracy: 'ความแม่นยำขึ้นอยู่กับคุณภาพข้อมูลและความถูกต้องของเป้าหมาย',
                    unit: 'คะแนน (0-10)',
                    note: 'ช่วยในการระบุจุดแข็งและจุดที่ต้องปรับปรุงของโรงงาน'
                },
                'ai-commentary': {
                    title: 'ความเห็นจาก AI',
                    description: 'ข้อความวิเคราะห์และความเห็นจากระบบปัญญาประดิษฐ์เกี่ยวกับการทำงานของโรงงาน',
                    source: 'ข้อมูลมาจากการวิเคราะห์ข้อมูลการผลิตอ้อยโดยระบบ AI',
                    calculation: 'ระบบ AI ใช้เทคนิคต่างๆ เช่น Natural Language Processing (NLP), Sentiment Analysis, และ Pattern Recognition',
                    ai_analysis: 'AI - ระบบใช้เทคนิคต่างๆ เช่น NLP, Sentiment Analysis, และ Pattern Recognition',
                    accuracy: 'ความแม่นยำขึ้นอยู่กับคุณภาพข้อมูลและความถูกต้องของ AI model',
                    unit: 'ข้อความวิเคราะห์ (ภาษาไทย)',
                    note: 'ความเห็นจาก AI ช่วยในการเข้าใจสถานการณ์และแนวโน้มการทำงาน'
                },
                'practical-recommendations': {
                    title: 'ข้อเสนอแนะเชิงปฏิบัติ',
                    description: 'ข้อเสนอแนะที่เป็นรูปธรรมสำหรับการปรับปรุงประสิทธิภาพการทำงานของโรงงาน',
                    source: 'ข้อมูลมาจากการวิเคราะห์ข้อมูลการผลิตอ้อยและประสบการณ์ในอดีต',
                    calculation: 'ระบบ AI ใช้เทคนิคต่างๆ เช่น Problem-Solving Algorithms, Optimization Models, และ Best Practices Analysis',
                    ai_analysis: 'AI - ระบบใช้เทคนิคต่างๆ เช่น Problem-Solving Algorithms, Optimization Models, และ Risk Assessment',
                    accuracy: 'ความแม่นยำขึ้นอยู่กับคุณภาพข้อมูลและประสบการณ์ในอดีต',
                    unit: 'ข้อเสนอแนะเชิงปฏิบัติ (ภาษาไทย)',
                    note: 'ข้อเสนอแนะเหล่านี้สามารถนำไปใช้ในการปรับปรุงการทำงานได้ทันที'
                },
                'operational-insights': {
                    title: 'ข้อมูลเชิงปฏิบัติ',
                    description: 'ข้อมูลเชิงลึกที่เกี่ยวข้องกับการปฏิบัติงานจริงในโรงงาน',
                    source: 'ข้อมูลมาจากการวิเคราะห์ข้อมูลการผลิตอ้อยและการปฏิบัติงานในอดีต',
                    calculation: 'ระบบ AI ใช้เทคนิคต่างๆ เช่น Operational Analysis, Process Optimization, และ Performance Monitoring',
                    ai_analysis: 'AI - ระบบใช้เทคนิคต่างๆ เช่น Operational Analysis, Process Optimization, และ Resource Utilization Analysis',
                    accuracy: 'ความแม่นยำขึ้นอยู่กับคุณภาพและความสมบูรณ์ของข้อมูล',
                    unit: 'ข้อมูลเชิงปฏิบัติ (ภาษาไทย) และค่าสถิติ',
                    note: 'ข้อมูลเหล่านี้ช่วยในการปรับปรุงกระบวนการทำงานและประสิทธิภาพการผลิต'
                },
                'quick-actions': {
                    title: 'การดำเนินการ',
                    description: 'การดำเนินการที่สามารถทำได้ทันทีเพื่อปรับปรุงประสิทธิภาพการทำงาน',
                    source: 'ข้อมูลมาจากการวิเคราะห์ข้อมูลการผลิตอ้อยและข้อเสนอแนะจากระบบ AI',
                    calculation: 'ระบบ AI ใช้เทคนิคต่างๆ เช่น Action Planning, Priority Setting, และ Resource Optimization',
                    ai_analysis: 'AI - ระบบใช้เทคนิคต่างๆ เช่น Action Planning, Priority Setting, และ Risk Assessment',
                    accuracy: 'ความแม่นยำขึ้นอยู่กับคุณภาพข้อมูลและความชัดเจนของปัญหา',
                    unit: 'การดำเนินการ (ภาษาไทย)',
                    note: 'การดำเนินการเหล่านี้สามารถทำได้ทันทีเพื่อปรับปรุงประสิทธิภาพการทำงาน'
                },
                'comparison-7-days': {
                    title: 'เปรียบเทียบกับค่าเฉลี่ยย้อนหลัง 7 วัน',
                    description: 'การเปรียบเทียบข้อมูลปัจจุบันกับค่าเฉลี่ยย้อนหลัง 7 วัน',
                    source: 'ข้อมูลมาจากการคำนวณค่าเฉลี่ยข้อมูลย้อนหลัง 7 วัน',
                    calculation: 'คำนวณค่าเฉลี่ยปริมาณและสัดส่วนอ้อยสดจากข้อมูล 7 วันย้อนหลัง แล้วเปรียบเทียบกับข้อมูลวันปัจจุบัน\n\nสูตร: เปอร์เซ็นต์เปลี่ยนแปลง = ((ค่าปัจจุบัน - ค่าเฉลี่ย) / ค่าเฉลี่ย) × 100',
                    ai_analysis: 'LOGIC - ระบบใช้การคำนวณค่าเฉลี่ยและเปรียบเทียบแบบธรรมดา ไม่ใช้ AI',
                    accuracy: 'ข้อมูลมีความแม่นยำสูง เนื่องจากใช้ข้อมูลจริงจากระบบชั่งน้ำหนัก',
                    unit: 'เปอร์เซ็นต์ (%)',
                    note: 'ช่วยในการประเมินประสิทธิภาพการทำงานเทียบกับช่วงเวลาที่ผ่านมา'
                },
                'trend-2-weeks': {
                    title: 'แนวโน้ม 2 สัปดาห์',
                    description: 'การวิเคราะห์แนวโน้มการเปลี่ยนแปลงในช่วง 2 สัปดาห์ที่ผ่านมา',
                    source: 'ข้อมูลมาจากการวิเคราะห์แนวโน้มข้อมูลย้อนหลัง 14 วัน',
                    calculation: 'ใช้เทคนิคการวิเคราะห์แนวโน้ม (Trend Analysis) ในการประเมินทิศทางการเปลี่ยนแปลงของข้อมูล\n\nสูตร: แนวโน้ม = การเปลี่ยนแปลงเฉลี่ยต่อวันในช่วง 14 วัน',
                    ai_analysis: 'AI - ระบบใช้ Time Series Analysis และ Trend Analysis algorithms',
                    accuracy: 'ความแม่นยำขึ้นอยู่กับความต่อเนื่องและคุณภาพของข้อมูลย้อนหลัง',
                    unit: 'ทิศทางแนวโน้ม (เพิ่มขึ้น/ลดลง/คงที่)',
                    note: 'ช่วยในการคาดการณ์แนวโน้มการทำงานในอนาคต'
                },
                'efficiency-indicators': {
                    title: 'ดัชนีชี้วัดประสิทธิภาพ',
                    description: 'ดัชนีชี้วัดประสิทธิภาพแยกตามด้านต่างๆ ของการทำงาน',
                    source: 'ข้อมูลมาจากการวิเคราะห์ประสิทธิภาพหลายด้านของโรงงาน',
                    calculation: 'คำนวณประสิทธิภาพแยกตามด้าน: ปริมาณ, คุณภาพ, ความเสถียร\n\nแต่ละด้านมีเกณฑ์การประเมินที่แตกต่างกัน เช่น ปริมาณเทียบกับเป้าหมาย, คุณภาพเทียบกับมาตรฐาน',
                    ai_analysis: 'AI - ระบบใช้ Machine Learning algorithms ในการประเมินและให้คะแนนแต่ละด้าน',
                    accuracy: 'ความแม่นยำขึ้นอยู่กับคุณภาพข้อมูลและความถูกต้องของเกณฑ์การประเมิน',
                    unit: 'เปอร์เซ็นต์ (%) และสถานะ (สูง/ปกติ/ต่ำ)',
                    note: 'ช่วยในการระบุจุดแข็งและจุดที่ต้องปรับปรุงของโรงงาน'
                },
                'operational-insights-detailed': {
                    title: 'ข้อมูลเชิงลึกปฏิบัติการ',
                    description: 'ข้อมูลเชิงลึกที่เกี่ยวข้องกับการปฏิบัติงานจริงในโรงงาน',
                    source: 'ข้อมูลมาจากการวิเคราะห์ข้อมูลการผลิตอ้อยและการปฏิบัติงานในอดีต',
                    calculation: 'ระบบ AI ใช้เทคนิคต่างๆ เช่น Operational Analysis, Process Optimization, และ Performance Monitoring',
                    ai_analysis: 'AI - ระบบใช้เทคนิคต่างๆ เช่น Operational Analysis, Process Optimization, และ Resource Utilization Analysis',
                    accuracy: 'ความแม่นยำขึ้นอยู่กับคุณภาพและความสมบูรณ์ของข้อมูล',
                    unit: 'ข้อมูลเชิงปฏิบัติ (ภาษาไทย)',
                    note: 'ข้อมูลเหล่านี้ช่วยในการปรับปรุงกระบวนการทำงานและประสิทธิภาพการผลิต'
                },
                'predictive-insights': {
                    title: 'การคาดการณ์เชิงข้อมูล',
                    description: 'การคาดการณ์แนวโน้มและผลลัพธ์ในอนาคตโดยใช้ข้อมูลในอดีต',
                    source: 'ข้อมูลมาจากการวิเคราะห์ข้อมูลย้อนหลังและการใช้ Machine Learning algorithms',
                    calculation: 'ระบบ AI ใช้เทคนิคต่างๆ เช่น Time Series Forecasting, Pattern Recognition, และ Predictive Modeling',
                    ai_analysis: 'AI - ระบบใช้ Machine Learning algorithms เช่น Time Series Analysis, Predictive Modeling, และ Pattern Recognition',
                    accuracy: 'ความแม่นยำขึ้นอยู่กับคุณภาพข้อมูลย้อนหลังและความถูกต้องของ AI model',
                    unit: 'การคาดการณ์ (ภาษาไทย)',
                    note: 'ช่วยในการวางแผนและเตรียมการสำหรับอนาคต'
                },
                'anomaly-detection': {
                    title: 'รายการที่ควรตรวจสอบ',
                    description: 'รายการที่ระบบตรวจพบความผิดปกติหรือสิ่งที่น่าสงสัย',
                    source: 'ข้อมูลมาจากการวิเคราะห์ข้อมูลปัจจุบันและเปรียบเทียบกับรูปแบบปกติ',
                    calculation: 'ระบบ AI ใช้เทคนิคต่างๆ เช่น Anomaly Detection, Statistical Analysis, และ Pattern Recognition',
                    ai_analysis: 'AI - ระบบใช้ Anomaly Detection algorithms และ Statistical Analysis',
                    accuracy: 'ความแม่นยำขึ้นอยู่กับความชัดเจนของรูปแบบปกติและคุณภาพของข้อมูล',
                    unit: 'รายการที่ควรตรวจสอบ (ภาษาไทย)',
                    note: 'ช่วยในการระบุปัญหาที่อาจเกิดขึ้นและป้องกันไว้ก่อน'
                },
                'daily-weight-bar': {
                    title: 'กราฟแท่งน้ำหนักอ้อยรายวัน',
                    description: 'กราฟแท่งแสดงน้ำหนักอ้อยรายวันในช่วงเวลาที่เลือก พร้อมการวิเคราะห์สรุป',
                    source: 'ข้อมูลมาจากระบบชั่งน้ำหนักอ้อยในแต่ละวัน',
                    calculation: 'รวมน้ำหนักอ้อยสุทธิจากทุกรถในแต่ละวัน\n\nสูตร: น้ำหนักรวมวัน = Σ(น้ำหนักสุทธิของรถแต่ละคันในวันนั้น)',
                    ai_analysis: 'DATA VISUALIZATION - ระบบใช้ Plotly.js ในการสร้างกราฟแท่งแบบ Interactive',
                    accuracy: 'ข้อมูลมีความแม่นยำสูง เนื่องจากมาจากระบบชั่งน้ำหนักจริง',
                    unit: 'ตัน (Ton)',
                    note: 'ช่วยในการติดตามแนวโน้มน้ำหนักอ้อยรายวันและเปรียบเทียบระหว่างช่วงเวลา'
                },
                'daily-weight-comparison': {
                    title: 'เปรียบเทียบน้ำหนักอ้อยรายวัน',
                    description: 'การเปรียบเทียบน้ำหนักอ้อยระหว่างช่วงเวลาปัจจุบันกับช่วงเวลาก่อนหน้า',
                    source: 'ข้อมูลมาจากการเปรียบเทียบข้อมูลน้ำหนักอ้อยระหว่างสองช่วงเวลา',
                    calculation: 'เปรียบเทียบน้ำหนักเฉลี่ยต่อวันระหว่างช่วงเวลาปัจจุบัน (7 วัน) กับช่วงเวลาก่อนหน้า (7 วัน)\n\nสูตร: เปอร์เซ็นต์เปลี่ยนแปลง = ((เฉลี่ยปัจจุบัน - เฉลี่ยก่อนหน้า) / เฉลี่ยก่อนหน้า) × 100',
                    ai_analysis: 'COMPARATIVE ANALYSIS - ระบบใช้การวิเคราะห์เปรียบเทียบแบบสถิติ',
                    accuracy: 'ข้อมูลมีความแม่นยำสูง เนื่องจากใช้ข้อมูลจริงจากระบบชั่งน้ำหนัก',
                    unit: 'ตัน (Ton) และเปอร์เซ็นต์ (%)',
                    note: 'ช่วยในการประเมินประสิทธิภาพการทำงานและแนวโน้มการเปลี่ยนแปลง'
                },
                'ai-analysis': {
                    title: 'การวิเคราะห์ด้วย AI',
                    description: 'ระบบปัญญาประดิษฐ์ที่ใช้ในการวิเคราะห์ข้อมูลการผลิตอ้อยและให้คำแนะนำ',
                    source: 'ข้อมูลมาจากการประมวลผลข้อมูลการผลิตด้วย Machine Learning Algorithms',
                    calculation: 'ระบบ AI ใช้หลายอัลกอริทึม:\n1. Random Forest สำหรับการจำแนกประเภท\n2. Time Series Analysis สำหรับการคาดการณ์\n3. Anomaly Detection สำหรับการตรวจจับความผิดปกติ\n4. Natural Language Processing สำหรับการสร้างรายงาน',
                    ai_analysis: 'AI SYSTEM - ใช้ Machine Learning และ Deep Learning Algorithms',
                    accuracy: 'ความแม่นยำ: การคาดการณ์ 85-92%, การจำแนกประเภท 88-95%, การตรวจจับความผิดปกติ 90-96%',
                    unit: 'คะแนนและเปอร์เซ็นต์',
                    note: 'ระบบ AI จะ retrain ทุกสัปดาห์เพื่อปรับปรุงความแม่นยำ'
                },
                'performance-score': {
                    title: 'คะแนนประสิทธิภาพ',
                    description: 'คะแนนที่แสดงประสิทธิภาพการทำงานของโรงงานในวันนั้น',
                    source: 'ข้อมูลมาจากการคำนวณคะแนนจากหลายปัจจัยด้วยระบบ AI',
                    calculation: 'คะแนนรวม = (คะแนนปริมาณ × 0.3) + (คะแนนคุณภาพ × 0.25) + (คะแนนความเสถียร × 0.25) + (คะแนนประสิทธิภาพต่อชั่วโมง × 0.2)\n\nคะแนนแต่ละด้าน:\n- คะแนนปริมาณ: (ปริมาณจริง/เป้าหมาย) × 10\n- คะแนนคุณภาพ: (สัดส่วนอ้อยสด/0.7) × 10\n- คะแนนความเสถียร: (1 - CV) × 10\n- คะแนนประสิทธิภาพต่อชั่วโมง: (ปริมาณต่อชั่วโมง/เป้าหมายต่อชั่วโมง) × 10',
                    ai_analysis: 'AI CALCULATION - ใช้ Weighted Scoring Algorithm',
                    accuracy: 'ความแม่นยำ 90-95% ขึ้นอยู่กับความถูกต้องของข้อมูลป้อนเข้า',
                    unit: 'คะแนน (0-10)',
                    note: 'คะแนน 8-10 = ดีเยี่ยม, 6-7.9 = ดี, 4-5.9 = ปานกลาง, 0-3.9 = ต้องปรับปรุง'
                },
                'hourly-data': {
                    title: 'ข้อมูลรายชั่วโมง',
                    description: 'ตารางแสดงข้อมูลการผลิตอ้อยแยกตามชั่วโมงในแต่ละวัน',
                    source: 'ข้อมูลมาจากการรวบรวมข้อมูลจากระบบชั่งน้ำหนักในแต่ละชั่วโมง',
                    calculation: 'ข้อมูลแต่ละชั่วโมงคำนวณจาก:\n1. นับจำนวนรถที่ผ่านในชั่วโมงนั้น\n2. รวมน้ำหนักอ้อยสุทธิในชั่วโมงนั้น\n3. แยกประเภทอ้อยสด/อ้อยไฟ\n4. คำนวณเฉลี่ยต่อชั่วโมง',
                    ai_analysis: 'LOGIC + AI ANALYSIS - ข้อมูลดิบใช้ Logic, การวิเคราะห์รูปแบบใช้ AI',
                    accuracy: 'ข้อมูลดิบมีความแม่นยำ 99.9%, การวิเคราะห์รูปแบบ 85-90%',
                    unit: 'คัน, ตัน, เปอร์เซ็นต์',
                    note: 'ช่วยในการวิเคราะห์รูปแบบการทำงานและจุดที่ต้องปรับปรุง'
                },
                'cane-quality-analysis': {
                    title: 'การวิเคราะห์คุณภาพอ้อย',
                    description: 'การวิเคราะห์คุณภาพอ้อยสดและอ้อยไฟเพื่อประเมินผลผลิตน้ำตาล',
                    source: 'ข้อมูลมาจากการวิเคราะห์สัดส่วนอ้อยสด/อ้อยไฟและปัจจัยอื่นๆ',
                    calculation: 'ดัชนีคุณภาพ = (สัดส่วนอ้อยสด × 0.8) + (ปัจจัยอายุการเก็บ × 0.2)\n\nอ้อยสด: คะแนนคุณภาพ 8-10\nอ้อยไฟ: คะแนนคุณภาพ 5-7\nปัจจัยอายุการเก็บ: อ้อยสด 24-48 ชม. = 10, 48-72 ชม. = 7, >72 ชม. = 5',
                    ai_analysis: 'AI QUALITY ASSESSMENT - ใช้ Classification และ Regression Models',
                    accuracy: 'ความแม่นยำในการประเมินคุณภาพ 88-93%',
                    unit: 'คะแนนคุณภาพ (0-10)',
                    note: 'คุณภาพอ้อยส่งผลโดยตรงต่อผลผลิตน้ำตาลและต้นทุนการผลิต'
                },
                'efficiency-metrics': {
                    title: 'ดัชนีชี้วัดประสิทธิภาพ',
                    description: 'ดัชนีต่างๆ ที่ใช้ประเมินประสิทธิภาพการทำงานของโรงงาน',
                    source: 'ข้อมูลมาจากการคำนวณจากข้อมูลการผลิตและเป้าหมายที่กำหนด',
                    calculation: 'ดัชนีหลัก:\n1. Efficiency Ratio = (ผลผลิตจริง / เป้าหมาย) × 100\n2. Capacity Utilization = (ปริมาณที่ใช้ / ความจุสูงสุด) × 100\n3. Quality Index = (อ้อยสด / อ้อยทั้งหมด) × 100\n4. Throughput Rate = ปริมาณต่อชั่วโมง\n5. Downtime Percentage = (เวลาหยุด / เวลาทำงานทั้งหมด) × 100',
                    ai_analysis: 'AI PERFORMANCE ANALYTICS - ใช้ Multi-factor Analysis',
                    accuracy: 'ความแม่นยำในการประเมินประสิทธิภาพ 90-95%',
                    unit: 'เปอร์เซ็นต์, อัตรา, คะแนน',
                    note: 'ใช้สำหรับการวางแผนปรับปรุงและเพิ่มประสิทธิภาพ'
                },
                'predictive-insights': {
                    title: 'การคาดการณ์เชิงข้อมูล',
                    description: 'การคาดการณ์แนวโน้มและผลลัพธ์ในอนาคตโดยใช้ข้อมูลในอดีต',
                    source: 'ข้อมูลมาจากการวิเคราะห์ข้อมูลย้อนหลังด้วย Time Series Analysis',
                    calculation: 'อัลกอริทึมที่ใช้:\n1. ARIMA Model สำหรับการคาดการณ์ปริมาณ\n2. Seasonal Decomposition สำหรับการวิเคราะห์ฤดูกาล\n3. Moving Average สำหรับการปรับเรียบข้อมูล\n4. Trend Analysis สำหรับการวิเคราะห์แนวโน้ม\n\nสูตรคาดการณ์: Y(t+1) = α × Y(t) + β × Trend + γ × Seasonal + ε',
                    ai_analysis: 'AI PREDICTIVE MODELING - ใช้ Time Series Forecasting และ Machine Learning',
                    accuracy: 'ความแม่นยำการคาดการณ์: 1 วัน 85-90%, 3 วัน 75-80%, 7 วัน 65-70%',
                    unit: 'ตัน, เปอร์เซ็นต์, คะแนน',
                    note: 'การคาดการณ์ช่วยในการวางแผนการผลิตและจัดการทรัพยากร'
                },
                'anomaly-detection': {
                    title: 'การตรวจจับความผิดปกติ',
                    description: 'ระบบที่ตรวจจับและแจ้งเตือนเมื่อมีการทำงานที่ผิดปกติหรือไม่เป็นไปตามมาตรฐาน',
                    source: 'ข้อมูลมาจากการวิเคราะห์ข้อมูลการผลิตแบบ Real-time',
                    calculation: 'อัลกอริทึมตรวจจับ:\n1. Statistical Threshold: ค่าเบี่ยงเบนมาตรฐาน > 2σ\n2. Isolation Forest: ตรวจจับจุดที่แยกออกจากกลุ่ม\n3. One-Class SVM: จำแนกข้อมูลปกติและผิดปกติ\n4. Z-Score Analysis: Z = (X - μ) / σ\n\nเกณฑ์การแจ้งเตือน: Z-Score > 2.5 หรือ < -2.5',
                    ai_analysis: 'AI ANOMALY DETECTION - ใช้ Unsupervised Learning Algorithms',
                    accuracy: 'ความแม่นยำในการตรวจจับ 90-96%, False Positive Rate < 5%',
                    unit: 'คะแนนความผิดปกติ (0-10)',
                    note: 'ช่วยในการป้องกันปัญหาและปรับปรุงคุณภาพการผลิต'
                },
                'operational-insights': {
                    title: 'ข้อมูลเชิงลึกปฏิบัติการ',
                    description: 'ข้อมูลเชิงลึกที่เกี่ยวข้องกับการปฏิบัติงานจริงในโรงงาน',
                    source: 'ข้อมูลมาจากการวิเคราะห์ข้อมูลการทำงานและประสบการณ์จากผู้เชี่ยวชาญ',
                    calculation: 'การวิเคราะห์เชิงปฏิบัติ:\n1. Bottleneck Analysis: วิเคราะห์จุดคอขวด\n2. Resource Utilization: การใช้ทรัพยากร\n3. Process Optimization: การปรับปรุงกระบวนการ\n4. Cost-Benefit Analysis: การวิเคราะห์ต้นทุน-ผลประโยชน์\n5. Risk Assessment: การประเมินความเสี่ยง',
                    ai_analysis: 'AI OPERATIONAL INTELLIGENCE - ใช้ Business Intelligence และ Process Mining',
                    accuracy: 'ความแม่นยำในการวิเคราะห์ 85-92%',
                    unit: 'คะแนน, เปอร์เซ็นต์, หน่วยเวลา',
                    note: 'ช่วยในการตัดสินใจเชิงปฏิบัติและเพิ่มประสิทธิภาพการทำงาน'
                },
                'trend-analysis': {
                    title: 'การวิเคราะห์แนวโน้ม',
                    description: 'การวิเคราะห์แนวโน้มการเปลี่ยนแปลงของข้อมูลในช่วงเวลาที่กำหนด',
                    source: 'ข้อมูลมาจากการวิเคราะห์ข้อมูลย้อนหลังในช่วง 2 สัปดาห์',
                    calculation: 'การวิเคราะห์แนวโน้ม:\n1. Linear Trend: Y = aX + b\n2. Exponential Trend: Y = a × b^X\n3. Seasonal Trend: Y = Trend + Seasonal + Random\n4. Moving Average: MA(n) = (X1 + X2 + ... + Xn) / n\n5. Trend Strength: R² = 1 - (SSres / SStot)',
                    ai_analysis: 'AI TREND ANALYSIS - ใช้ Statistical Analysis และ Time Series Decomposition',
                    accuracy: 'ความแม่นยำในการวิเคราะห์แนวโน้ม 80-88%',
                    unit: 'เปอร์เซ็นต์การเปลี่ยนแปลง, คะแนนแนวโน้ม',
                    note: 'ช่วยในการวางแผนระยะยาวและคาดการณ์ผลลัพธ์'
                },
                'recommendation-system': {
                    title: 'ระบบข้อเสนอแนะ',
                    description: 'ระบบที่ให้ข้อเสนอแนะเชิงปฏิบัติเพื่อปรับปรุงประสิทธิภาพการทำงาน',
                    source: 'ข้อมูลมาจากการวิเคราะห์ข้อมูลและฐานความรู้ของผู้เชี่ยวชาญ',
                    calculation: 'อัลกอริทึมข้อเสนอแนะ:\n1. Rule-based System: ใช้กฎเกณฑ์ที่กำหนด\n2. Collaborative Filtering: ใช้ประสบการณ์จากกรณีที่คล้ายกัน\n3. Content-based Filtering: ใช้คุณสมบัติของข้อมูล\n4. Hybrid Approach: รวมหลายวิธี\n\nคะแนนความเหมาะสม = Σ(Weight × Score) / Σ(Weight)',
                    ai_analysis: 'AI RECOMMENDATION ENGINE - ใช้ Machine Learning และ Expert System',
                    accuracy: 'ความแม่นยำในการให้ข้อเสนอแนะ 85-90%',
                    unit: 'คะแนนความเหมาะสม (0-10)',
                    note: 'ข้อเสนอแนะจะปรับปรุงตามผลลัพธ์ที่เกิดขึ้นจริง'
                },
                'chart-hourly-tons': {
                    title: 'กราฟปริมาณอ้อยรายชั่วโมง',
                    description: 'กราฟแสดงปริมาณอ้อยที่เข้าโรงงานแยกตามชั่วโมงในแต่ละวัน',
                    source: 'ข้อมูลมาจากการรวบรวมข้อมูลปริมาณอ้อยจากระบบชั่งน้ำหนักในแต่ละชั่วโมง',
                    calculation: 'การสร้างกราฟ:\n1. แบ่งข้อมูลเป็น 24 ชั่วโมง (18:00-18:00)\n2. รวมน้ำหนักอ้อยสุทธิในแต่ละชั่วโมง\n3. สร้างกราฟเส้นแสดงแนวโน้ม\n4. คำนวณค่าเฉลี่ยและจุดสูงสุด\n\nสูตร: ปริมาณต่อชั่วโมง = Σ(wgt_net ในชั่วโมงนั้น)\nจุดสูงสุด = MAX(ปริมาณต่อชั่วโมง)',
                    ai_analysis: 'DATA VISUALIZATION - ใช้ Plotly.js ในการสร้างกราฟเส้นแบบ Interactive',
                    accuracy: 'ข้อมูลมีความแม่นยำ 99.9% เนื่องจากมาจากระบบชั่งน้ำหนักจริง',
                    unit: 'ตัน (Tons) ต่อชั่วโมง',
                    note: 'ช่วยในการวิเคราะห์รูปแบบการทำงานและจุดที่ต้องปรับปรุง'
                },
                'chart-hourly-counts': {
                    title: 'กราฟจำนวนรถรายชั่วโมง',
                    description: 'กราฟแสดงจำนวนรถบรรทุกอ้อยที่เข้าโรงงานแยกตามชั่วโมงในแต่ละวัน',
                    source: 'ข้อมูลมาจากการนับจำนวนรถที่ผ่านระบบชั่งน้ำหนักในแต่ละชั่วโมง',
                    calculation: 'การสร้างกราฟ:\n1. แบ่งข้อมูลเป็น 24 ชั่วโมง (18:00-18:00)\n2. นับจำนวนรถที่ผ่านในแต่ละชั่วโมง\n3. สร้างกราฟแท่งแสดงความหนาแน่น\n4. คำนวณค่าเฉลี่ยและจุดสูงสุด\n\nสูตร: จำนวนรถต่อชั่วโมง = COUNT(รถในชั่วโมงนั้น)\nจุดสูงสุด = MAX(จำนวนรถต่อชั่วโมง)',
                    ai_analysis: 'DATA VISUALIZATION - ใช้ Plotly.js ในการสร้างกราฟแท่งแบบ Interactive',
                    accuracy: 'ข้อมูลมีความแม่นยำ 99.9% เนื่องจากนับจากระบบอัตโนมัติ',
                    unit: 'คัน (Trucks) ต่อชั่วโมง',
                    note: 'ช่วยในการวิเคราะห์ความหนาแน่นของการขนส่งและวางแผนการจัดการ'
                },
                'chart-cumulative-types': {
                    title: 'กราฟปริมาณอ้อยสะสมตามประเภท',
                    description: 'กราฟแสดงปริมาณอ้อยสะสมแยกตามประเภท (อ้อยสด/อ้อยไฟ) ในแต่ละชั่วโมง',
                    source: 'ข้อมูลมาจากการรวมปริมาณอ้อยแยกตามประเภทจากระบบชั่งน้ำหนัก',
                    calculation: 'การสร้างกราฟสะสม:\n1. แบ่งข้อมูลเป็น 24 ชั่วโมง\n2. กรองข้อมูลที่ผ่านการตรวจสอบ (PRINT_W = "y")\n3. กรองน้ำหนักที่มากกว่า 0 (WGT_NET > 0)\n4. กรองข้อมูลที่ไม่ใช่ข้อมูลทดสอบ (NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))\n5. รวมน้ำหนักอ้อยสดสะสม (cane_type = "1")\n6. รวมน้ำหนักอ้อยไฟสะสม (cane_type = "2")\n7. สร้างกราฟพื้นที่แสดงสัดส่วน\n\nสูตร: อ้อยสดสะสม = Σ(wgt_net WHERE cane_type = "1" AND PRINT_W = "y" AND WGT_NET > 0 AND NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))\nอ้อยไฟสะสม = Σ(wgt_net WHERE cane_type = "2" AND PRINT_W = "y" AND WGT_NET > 0 AND NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))',
                    ai_analysis: 'DATA VISUALIZATION - ใช้ Plotly.js ในการสร้างกราฟพื้นที่แบบ Interactive',
                    accuracy: 'ข้อมูลมีความแม่นยำ 95-98% ขึ้นอยู่กับการบันทึกประเภทอ้อย',
                    unit: 'ตัน (Tons) สะสม',
                    note: 'ช่วยในการวิเคราะห์สัดส่วนคุณภาพอ้อยและแนวโน้มการเปลี่ยนแปลง'
                },
                'chart-cumulative-lines': {
                    title: 'กราฟปริมาณอ้อยสะสมตามราง',
                    description: 'กราฟแสดงปริมาณอ้อยสะสมแยกตามราง (ราง A/ราง B) ในแต่ละชั่วโมง',
                    source: 'ข้อมูลมาจากการรวมปริมาณอ้อยแยกตามรางจากระบบชั่งน้ำหนัก',
                    calculation: 'การสร้างกราฟสะสม:\n1. แบ่งข้อมูลเป็น 24 ชั่วโมง\n2. รวมน้ำหนักอ้อยราง A สะสม (Prod_line = "A")\n3. รวมน้ำหนักอ้อยราง B สะสม (Prod_line = "B")\n4. สร้างกราฟเส้นแสดงประสิทธิภาพ\n\nสูตร: ราง A สะสม = Σ(wgt_net WHERE Prod_line = "A")\nราง B สะสม = Σ(wgt_net WHERE Prod_line = "B")',
                    ai_analysis: 'DATA VISUALIZATION - ใช้ Plotly.js ในการสร้างกราฟเส้นแบบ Interactive',
                    accuracy: 'ข้อมูลมีความแม่นยำ 99.9% เนื่องจากมาจากระบบชั่งน้ำหนักจริง',
                    unit: 'ตัน (Tons) สะสม',
                    note: 'ช่วยในการวิเคราะห์ประสิทธิภาพการทำงานของแต่ละรางและเปรียบเทียบ'
                },
                'monthly-data': {
                    title: 'สรุปยอดอ้อยรายเดือน',
                    description: 'ข้อมูลสรุปปริมาณอ้อยที่เข้าโรงงานแยกตามเดือนในฤดูกาลหีบอ้อย',
                    source: 'ข้อมูลมาจากการรวมปริมาณอ้อยทั้งหมดจากฐานข้อมูลแยกตามเดือน',
                    calculation: 'การสรุปข้อมูลรายเดือน:\n1. จัดกลุ่มข้อมูลตามเดือน (FORMAT(reportdate, "yyyy-MM"))\n2. รวมน้ำหนักอ้อยทั้งหมดในเดือนนั้น\n3. แยกประเภทอ้อยสด/อ้อยไฟ\n4. คำนวณสถิติต่างๆ\n\nสูตร: ปริมาณรายเดือน = Σ(wgt_net WHERE MONTH = เดือนนั้น)\nเฉลี่ยต่อวัน = ปริมาณรายเดือน / จำนวนวันในเดือน',
                    ai_analysis: 'DATA AGGREGATION - ใช้ SQL GROUP BY และ Aggregation Functions',
                    accuracy: 'ข้อมูลมีความแม่นยำ 99.9% เนื่องจากมาจากระบบชั่งน้ำหนักจริง',
                    unit: 'ตัน (Tons) ต่อเดือน',
                    note: 'ช่วยในการวิเคราะห์แนวโน้มการผลิตทั้งฤดูกาลและวางแผนการผลิต'
                },
                'heatmap-data': {
                    title: 'Heatmap ข้อมูลรายชั่วโมง',
                    description: 'แผนที่ความร้อนแสดงปริมาณอ้อยในแต่ละชั่วโมงของแต่ละวัน',
                    source: 'ข้อมูลมาจากการรวบรวมข้อมูลปริมาณอ้อยรายชั่วโมงจากหลายวัน',
                    calculation: 'การสร้าง Heatmap:\n1. แบ่งข้อมูลเป็น 24 ชั่วโมง × จำนวนวัน\n2. คำนวณปริมาณอ้อยในแต่ละเซลล์\n3. สร้างแผนที่ความร้อนด้วยสี\n4. คำนวณค่าเฉลี่ยและจุดสูงสุด\n\nสูตร: ปริมาณในเซลล์ = Σ(wgt_net ในชั่วโมงนั้นของวันนั้น)\nสี = ฟังก์ชันของปริมาณ (ต่ำ=เขียว, สูง=แดง)',
                    ai_analysis: 'DATA VISUALIZATION - ใช้ Plotly.js ในการสร้าง Heatmap แบบ Interactive',
                    accuracy: 'ข้อมูลมีความแม่นยำ 99.9% เนื่องจากมาจากระบบชั่งน้ำหนักจริง',
                    unit: 'ตัน (Tons) ต่อชั่วโมง',
                    note: 'ช่วยในการวิเคราะห์รูปแบบการทำงานและจุดที่ต้องปรับปรุง'
                },
                'daily-weight-chart': {
                    title: 'กราฟน้ำหนักอ้อยรายวัน',
                    description: 'กราฟแท่งแสดงปริมาณอ้อยที่เข้าโรงงานในแต่ละวันในช่วงเวลาที่เลือก',
                    source: 'ข้อมูลมาจากการรวมปริมาณอ้อยรายวันจากฐานข้อมูล',
                    calculation: 'การสร้างกราฟแท่ง:\n1. จัดกลุ่มข้อมูลตามวันที่\n2. กรองข้อมูลที่ผ่านการตรวจสอบ (PRINT_W = "y")\n3. กรองน้ำหนักที่มากกว่า 0 (WGT_NET > 0)\n4. กรองข้อมูลที่ไม่ใช่ข้อมูลทดสอบ (NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))\n5. รวมน้ำหนักอ้อยทั้งหมดในวันนั้น\n6. แยกประเภทอ้อยสด/อ้อยไฟ\n7. สร้างกราฟแท่งแสดงเปรียบเทียบ\n\nสูตร: ปริมาณรายวัน = Σ(wgt_net WHERE DATE = วันที่นั้น AND PRINT_W = "y" AND WGT_NET > 0 AND NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))\nอ้อยสดรายวัน = Σ(wgt_net WHERE cane_type = "1" AND DATE = วันที่นั้น AND PRINT_W = "y" AND WGT_NET > 0 AND NameLan NOT IN ("10","20","30","31","40","41","50","80","81"))',
                    ai_analysis: 'DATA VISUALIZATION - ใช้ Plotly.js ในการสร้างกราฟแท่งแบบ Interactive',
                    accuracy: 'ข้อมูลมีความแม่นยำสูง เนื่องจากมาจากระบบชั่งน้ำหนักจริง',
                    unit: 'ตัน (Tons) ต่อวัน',
                    note: 'ช่วยในการติดตามแนวโน้มน้ำหนักอ้อยรายวันและเปรียบเทียบระหว่างช่วงเวลา'
                }
            };

            const data = faqData[faqType] || {
                title: 'ไม่พบข้อมูล',
                description: 'ไม่พบข้อมูลสำหรับรายการนี้',
                source: 'ไม่ระบุ',
                calculation: 'ไม่ระบุ',
                ai_analysis: 'ไม่ระบุ',
                accuracy: 'ไม่ระบุ',
                unit: 'ไม่ระบุ',
                note: 'ไม่ระบุ'
            };

            return `
                <div class="row">
                    <div class="col-12">
                        <div class="mb-4">
                            <h6 class="text-info mb-3"><i class="bi bi-info-circle me-2"></i>คำอธิบาย</h6>
                            <p class="text-light">${data.description}</p>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="text-success mb-3"><i class="bi bi-database me-2"></i>ที่มาของข้อมูล</h6>
                            <p class="text-light">${data.source}</p>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="text-warning mb-3"><i class="bi bi-calculator me-2"></i>วิธีการคำนวณ</h6>
                            <p class="text-light">${data.calculation}</p>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="text-primary mb-3"><i class="bi bi-robot me-2"></i>การวิเคราะห์ด้วย AI</h6>
                            <p class="text-light">${data.ai_analysis}</p>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="text-danger mb-3"><i class="bi bi-shield-check me-2"></i>ความแม่นยำของข้อมูล</h6>
                            <p class="text-light">${data.accuracy}</p>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="text-secondary mb-3"><i class="bi bi-rulers me-2"></i>หน่วยที่ใช้</h6>
                            <p class="text-light">${data.unit}</p>
                        </div>
                        
                        <div class="mb-4">
                            <h6 class="text-info mb-3"><i class="bi bi-lightbulb me-2"></i>หมายเหตุ</h6>
                            <p class="text-light">${data.note}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Weather Data Functions removed
        


        document.addEventListener('DOMContentLoaded', () => {
                    // Initialize progressive loading
        initProgressiveLoading();
        
        // Start AI loading messages on page load
        if (loadingOverlay && loadingOverlay.style.display !== 'none') {
            startAILoadingMessages();
        }
        
        // Load monthly data after page is fully loaded
        setTimeout(() => {
            fetchMonthlyData();
        }, 2000);
            
            // Optimize initial load
            setTimeout(optimizeInitialLoad, 100);
            
            fetchData().then(() => {
                updateSortIndicators();
                // Load monthly data after main data is loaded
                setTimeout(() => {
                    fetchMonthlyData();
                }, 500);
            });
            
            // Initial load of historical and new charts
            fetchAllHistoricalData();
            
            // Load monthly data with a delay to ensure DOM is ready
            setTimeout(() => {
                fetchMonthlyData();
            }, 1000);
            
            // Weather data loading removed
            

            
            const savedInterval = localStorage.getItem('refreshInterval');
            refreshIntervalSelect.value = savedInterval ? savedInterval : parseInt('{{ auto_refresh_interval }}').toString();

            setupRefreshTimer();
            setInterval(() => {
                const now = new Date();
                document.getElementById('current-date-display').textContent = now.toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById('current-time-display').textContent = now.toLocaleTimeString('th-TH');
            }, 1000);
            
            // Weather data update interval removed
            

        });

        datePicker.addEventListener('change', () => {
            fetchData();
            // Weather data update for selected date removed
        });
        refreshIntervalSelect.addEventListener('change', setupRefreshTimer);
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'r') { e.preventDefault(); fetchData(); }
            if (e.key === 'F11') { e.preventDefault(); toggleFullscreen(); }
        });
        
        ['scroll', 'mousemove', 'mousedown', 'keydown'].forEach(evt => document.addEventListener(evt, () => {
            isUserInteracting = true;
            clearTimeout(interactionTimer);
            interactionTimer = setTimeout(() => { isUserInteracting = false; }, 5000);
        }, true));

        // AI Notice Functions
        function dismissAINotice() {
            const alert = document.getElementById('ai-notice-alert');
            if (alert) {
                alert.style.animation = 'slideOutUp 0.5s ease-in forwards';
                setTimeout(() => {
                    alert.style.display = 'none';
                    // Save to localStorage so it doesn't show again in this session
                    localStorage.setItem('ai-notice-dismissed', 'true');
                }, 500);
            }
        }
        
        function showAINotice() {
            const alert = document.getElementById('ai-notice-alert');
            const dismissed = localStorage.getItem('ai-notice-dismissed');
            
            if (alert && !dismissed) {
                alert.style.display = 'block';
                alert.style.animation = 'slideInDown 0.6s ease-out';
            } else if (alert && dismissed) {
                alert.style.display = 'none';
            }
        }

        // Timeout and Idle Detection System
        let idleTimer;
        let lastActivity = Date.now();
        const IDLE_TIMEOUT = parseInt('{{ session_timeout }}') * 60 * 1000; // From server config
        const WARNING_TIMEOUT = parseInt('{{ warning_timeout }}') * 60 * 1000; // From server config
        
        function resetIdleTimer() {
            lastActivity = Date.now();
            clearTimeout(idleTimer);
            idleTimer = setTimeout(checkIdle, IDLE_TIMEOUT);
        }
        
        function checkIdle() {
            const timeSinceLastActivity = Date.now() - lastActivity;
            
            if (timeSinceLastActivity >= IDLE_TIMEOUT) {
                // User has been idle for 30 minutes
                showIdleWarning();
            } else if (timeSinceLastActivity >= WARNING_TIMEOUT) {
                // Show warning at 25 minutes
                showIdleWarning();
            }
        }
        
        function showIdleWarning() {
            const warningModal = `
                <div class="modal fade" id="idleWarningModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog">
                        <div class="modal-content bg-dark text-light">
                            <div class="modal-header border-secondary">
                                <h5 class="modal-title">
                                    <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
                                    เตือนการใช้งาน
                                </h5>
                            </div>
                            <div class="modal-body">
                                <p>คุณไม่ได้ใช้งานระบบเป็นเวลานานแล้ว</p>
                                <p class="text-muted small">ระบบจะปิดการเชื่อมต่อในอีก 5 นาที หากไม่มีการใช้งาน</p>
                            </div>
                            <div class="modal-footer border-secondary">
                                <button type="button" class="btn btn-primary" onclick="extendSession()">
                                    <i class="bi bi-check-circle me-1"></i>ใช้งานต่อ
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="logout()">
                                    <i class="bi bi-box-arrow-right me-1"></i>ออกจากระบบ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('idleWarningModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to page and show it
            document.body.insertAdjacentHTML('beforeend', warningModal);
            const modal = new bootstrap.Modal(document.getElementById('idleWarningModal'));
            modal.show();
            
            // Auto logout after 5 minutes if no response
            setTimeout(() => {
                const modalElement = document.getElementById('idleWarningModal');
                if (modalElement && modalElement.classList.contains('show')) {
                    logout();
                }
            }, 5 * 60 * 1000);
        }
        
        function extendSession() {
            resetIdleTimer();
            const modal = bootstrap.Modal.getInstance(document.getElementById('idleWarningModal'));
            if (modal) {
                modal.hide();
            }
            showNotification('เซสชันได้รับการต่ออายุแล้ว', 'success');
        }
        
        function logout() {
            // Clear all timers and data
            clearTimeout(idleTimer);
            clearInterval(refreshTimer);
            localStorage.clear();
            
            // Show logout message
            const logoutMessage = `
                <div class="modal fade" id="logoutModal" tabindex="-1" data-bs-backdrop="static">
                    <div class="modal-dialog">
                        <div class="modal-content bg-dark text-light">
                            <div class="modal-header border-secondary">
                                <h5 class="modal-title">
                                    <i class="bi bi-box-arrow-right text-info me-2"></i>
                                    ออกจากระบบ
                                </h5>
                            </div>
                            <div class="modal-body">
                                <p>คุณได้ออกจากระบบแล้ว</p>
                                <p class="text-muted small">กรุณารีเฟรชหน้าเว็บเพื่อเข้าสู่ระบบใหม่</p>
                            </div>
                            <div class="modal-footer border-secondary">
                                <button type="button" class="btn btn-primary" onclick="location.reload()">
                                    <i class="bi bi-arrow-clockwise me-1"></i>รีเฟรชหน้าเว็บ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            document.body.insertAdjacentHTML('beforeend', logoutMessage);
            const modal = new bootstrap.Modal(document.getElementById('logoutModal'));
            modal.show();
        }
        
        // Track user activity
        function trackActivity() {
            resetIdleTimer();
        }
        
        // Event listeners for activity tracking
        const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
        activityEvents.forEach(event => {
            document.addEventListener(event, trackActivity, true);
        });

        document.addEventListener('DOMContentLoaded', () => {
            
            // Initialize idle timer
            resetIdleTimer();
            
            // Add tab change event listeners
            const historicalTabs = document.querySelectorAll('#historicalTab .nav-link');
            historicalTabs.forEach(tab => {
                tab.addEventListener('shown.bs.tab', function (event) {
                    const targetId = event.target.getAttribute('data-bs-target');
                    if (targetId === '#daily-weight-bar-pane') {
                        // โหลดข้อมูลกราฟแท่งน้ำหนักเมื่อเปลี่ยนไปแท็บนี้
                        const startDate = document.getElementById('historical-start-date').value;
                        const endDate = document.getElementById('historical-end-date').value;
                        if (startDate && endDate) {
                            fetchDailyWeightData();
                        }
                    }
                });
            });
            
            fetchData().then(() => {
                updateSortIndicators();
                // Load monthly data after main data is loaded
                setTimeout(() => {
                    fetchMonthlyData();
                }, 500);
            });
        });
    </script>

    <!-- AI & Logic Information Footer -->
    <footer class="ai-logic-footer mt-5 py-4" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-top: 2px solid #0d6efd; margin-top: auto;">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h5 class="text-center text-white mb-4">
                        <i class="bi bi-cpu me-2"></i>ระบบ AI & Logic ที่ใช้ในแอปพลิเคชัน
                    </h5>
                </div>
            </div>
            
            <div class="row g-4">
                <!-- AI Systems -->
                <div class="col-lg-6">
                    <div class="ai-section">
                        <h6 class="text-info mb-3">
                            <i class="bi bi-robot me-2"></i>ระบบ AI (Artificial Intelligence)
                        </h6>
                        <div class="ai-list">
                            <div class="ai-item mb-2">
                                <span class="badge bg-primary me-2">ML</span>
                                <strong>Machine Learning:</strong> Random Forest (พร้อมใช้งาน)
                            </div>
                            <div class="ai-item mb-2">
                                <span class="badge bg-success me-2">NLP</span>
                                <strong>Natural Language Processing:</strong> การสร้างรายงานและข้อความวิเคราะห์
                            </div>
                            <div class="ai-item mb-2">
                                <span class="badge bg-warning me-2">STAT</span>
                                <strong>Statistical Analysis:</strong> Z-Score, Trend Analysis
                            </div>
                            <div class="ai-item mb-2">
                                <span class="badge bg-danger me-2">AD</span>
                                <strong>Anomaly Detection:</strong> Statistical Threshold (ใช้งานได้)
                            </div>
                            <div class="ai-item mb-2">
                                <span class="badge bg-info me-2">PM</span>
                                <strong>Predictive Modeling:</strong> Time Series Analysis (ใช้งานได้)
                            </div>
                            <div class="ai-item mb-2">
                                <span class="badge bg-secondary me-2">ES</span>
                                <strong>Expert System:</strong> Rule-based Analysis
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Logic Systems -->
                <div class="col-lg-6">
                    <div class="logic-section">
                        <h6 class="text-warning mb-3">
                            <i class="bi bi-gear me-2"></i>ระบบ Logic Programming
                        </h6>
                        <div class="logic-list">
                            <div class="logic-item mb-2">
                                <span class="badge bg-light text-dark me-2">SQL</span>
                                <strong>Database Operations:</strong> Aggregation Functions, GROUP BY
                            </div>
                            <div class="logic-item mb-2">
                                <span class="badge bg-light text-dark me-2">CALC</span>
                                <strong>Real-time Calculation:</strong> Weight Calculation, Counting
                            </div>
                            <div class="logic-item mb-2">
                                <span class="badge bg-light text-dark me-2">VIZ</span>
                                <strong>Data Visualization:</strong> Plotly.js Charts, Interactive Graphs
                            </div>
                            <div class="logic-item mb-2">
                                <span class="badge bg-light text-dark me-2">STAT</span>
                                <strong>Statistical Analysis:</strong> Mean, Standard Deviation, Trends
                            </div>
                            <div class="logic-item mb-2">
                                <span class="badge bg-light text-dark me-2">AGG</span>
                                <strong>Data Aggregation:</strong> Hourly, Daily, Monthly Summaries
                            </div>
                            <div class="logic-item mb-2">
                                <span class="badge bg-light text-dark me-2">COMP</span>
                                <strong>Comparative Analysis:</strong> Historical Comparison, Performance Metrics
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </footer>

    <style>
        .ai-logic-footer {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .ai-section, .logic-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .ai-item, .logic-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .ai-item {
            border-left-color: #0d6efd;
        }
        
        .ai-item:hover {
            background: rgba(13, 110, 253, 0.1);
            transform: translateX(5px);
        }
        
        .logic-item {
            border-left-color: #ffc107;
        }
        
        .logic-item:hover {
            background: rgba(255, 193, 7, 0.1);
            transform: translateX(5px);
        }
        
        
        
        .badge {
            font-size: 0.7rem;
            padding: 4px 8px;
        }
        
        @media (max-width: 768px) {
            .ai-item, .logic-item {
                flex-direction: column;
                align-items: flex-start;
                text-align: left;
            }
            
        }
    </style>
</body>
</html>